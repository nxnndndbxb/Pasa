
<body html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Treasure Pro - Aqua Spark</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* style.css */
        /* Global Styles - Aqua Spark Theme */
        :root {
            --primary-color: #00A99D; /* Vibrant Teal */
            --primary-light: #4DD0E1; /* Lighter Aqua */
            --primary-dark: #00796B;  /* Darker Teal */
            
            --secondary-color: #673AB7; /* Deep Purple */
            --secondary-light: #9575CD;
            --secondary-dark: #512DA8;

            --accent-color: #FF6F61; /* Bright Coral */
            --accent-light: #FFAB91;
            --accent-dark: #D84315;

            --success-color: #4CAF50; /* Green */
            --warning-color: #FFC107; /* Amber */
            --danger-color: #F44336; /* Red */
            --info-color: #03A9F4;   /* Light Blue */

            --bg-light: #f7fafc; /* Very light gray background */
            --bg-dark: #1a202c;  /* For dark mode (future) */
            
            --card-bg: #ffffff;
            --card-bg-dark-mode: #2d3748; /* For dark mode (future) */

            --text-light: #ffffff;
            --text-dark: #2d3748;  /* Dark Gray for text */
            --text-gray: #718096; /* Lighter Gray for secondary text */

            --border-color: #e2e8f0; /* Light border for elements */
            --border-radius: 8px; /* Softer radius */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Smoother transition */
            
            --font-primary: 'Inter', 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-primary);
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--secondary-dark); /* Changed to secondary for headings */
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-gray);
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition);
        }

        a:hover {
            color: var(--primary-dark);
        }

        /* Auth Styles */
        #auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-light);
            padding: 20px;
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            text-align: center;
        }

        .logo {
            width: 90px; /* Slightly smaller */
            height: 90px;
            margin-bottom: 15px;
            animation: gentlePulse 2.5s infinite ease-in-out;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.25));
        }

        @keyframes gentlePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        .app-title {
            font-size: 2.2rem; /* Adjusted size */
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            color: var(--text-light);
        }

        #auth-options {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 380px; /* Slightly narrower */
        }

        .auth-btn {
            padding: 12px 25px; /* Adjusted padding */
            border: none;
            border-radius: var(--border-radius); /* Consistent radius */
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--accent-color);
            color: var(--text-light);
            box-shadow: var(--shadow);
            flex: 1;
            text-align: center;
        }

        .auth-btn:hover {
            transform: translateY(-2px) scale(1.02); /* More subtle hover */
            box-shadow: var(--shadow-hover);
            background-color: var(--accent-light);
        }

        .auth-form {
            background-color: var(--card-bg);
            padding: 35px; /* Increased padding */
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 420px; /* Slightly wider for better spacing */
            box-shadow: var(--shadow-hover);
            animation: fadeIn 0.5s ease-out;
            color: var(--text-dark);
        }
        
        .auth-form h2 {
            color: var(--primary-dark); /* Using primary-dark for form titles */
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.7rem;
        }

        .form-group {
            position: relative;
            margin-bottom: 20px;
        }

        .form-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-gray);
        }
        
        .form-group.password-container i.fas.fa-lock {
             left: 15px;
        }

        .password-container .password-toggle i {
            left: auto;
            right: 15px;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-gray);
            cursor: pointer;
        }

        .password-strength {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px; /* Increased margin */
        }

        .strength-bar {
            height: 5px; /* Slightly thicker */
            flex: 1;
            background-color: var(--border-color); /* Neutral base */
            border-radius: 3px;
        }
        .strength-bar.weak { background-color: var(--danger-color); }
        .strength-bar.medium { background-color: var(--warning-color); }
        .strength-bar.strong { background-color: var(--success-color); }

        .strength-text {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-left: 5px;
        }

        .auth-form input {
            width: 100%;
            padding: 12px 15px 12px 45px; /* Increased left padding for icon */
            margin-bottom: 5px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--bg-light); /* Lighter input bg */
        }

        .password-container input {
            padding-right: 45px;
        }
        
        .password-container.has-strength input {
            padding-right: 70px;
        }

        .auth-form input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 169, 157, 0.2); /* Primary color focus ring */
            background-color: var(--card-bg);
        }

        .terms {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .terms input {
            width: auto;
            margin-right: 10px;
            accent-color: var(--primary-color); /* Style checkbox */
        }

        .terms label {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        #terms-link {
            color: var(--primary-color);
            font-weight: 500;
        }
        #terms-link:hover {
            text-decoration: underline;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .submit-btn:hover {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .auth-switch {
            text-align: center;
            margin-top: 25px;
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        .auth-switch span {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
        }
        .auth-switch span:hover {
            text-decoration: underline;
        }

        .forgot-password {
            text-align: center;
            margin: 15px 0;
            color: var(--accent-color);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .forgot-password:hover {
            text-decoration: underline;
        }

        #email-verify-notice {
            text-align: center;
        }

        .verify-icon {
            font-size: 3.5rem; /* Larger icon */
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        #verify-email {
            font-weight: 600;
            color: var(--primary-dark); /* Darker for emphasis */
        }

        #resend-verify {
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        /* App Styles */
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--bg-light);
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 25px; /* Adjusted padding */
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color)); /* Gradient header */
            color: var(--text-light);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .menu-toggle {
            font-size: 1.6rem; /* Larger toggle */
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
            padding: 5px; /* Clickable area */
        }

        .menu-toggle:hover {
            transform: scale(1.1) rotate(90deg); /* Fun hover */
            color: var(--accent-light);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo img {
            width: 35px; /* Slightly larger */
            height: 35px;
            border-radius: 50%;
        }

        .app-logo h1 {
            font-size: 1.3rem; /* Adjusted size */
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .balance-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.15); /* More subtle */
            padding: 6px 12px;
            border-radius: 20px;
        }

        #user-balance {
            font-weight: 600;
        }

        .refresh-balance {
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .refresh-balance:hover {
            transform: rotate(360deg) scale(1.1); /* Full rotate */
            color: var(--accent-light);
        }

        .user-avatar {
            position: relative;
            cursor: pointer;
        }

        .user-avatar i {
            font-size: 2rem; /* Larger avatar icon */
            color: var(--text-light);
        }

        .online-status {
            position: absolute;
            bottom: 2px; /* Adjusted position */
            right: 2px;
            width: 10px;
            height: 10px;
            background-color: var(--success-color);
            border-radius: 50%;
            border: 2px solid var(--primary-dark); /* Matched to header bg */
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background-color: var(--card-bg);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1); /* Enhanced shadow */
            transition: var(--transition);
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .side-menu.active {
            left: 0;
        }

        .menu-header {
            padding: 25px 20px; /* More padding */
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark)); /* Purple gradient */
            color: var(--text-light);
            text-align: center;
            position: relative;
        }

        .menu-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 12px;
            border: 3px solid rgba(255,255,255,0.8);
            object-fit: cover;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .menu-header h3 {
            color: var(--text-light);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .menu-header span {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .user-level {
            margin-top: 10px;
        }

        #user-level-badge {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--text-light);
            padding: 4px 12px; /* Adjusted padding */
            border-radius: 15px; /* Pill shape */
            font-size: 0.8rem;
            font-weight: 600;
        }

        .menu-items {
            list-style: none;
            padding: 15px 0; /* Increased padding */
            flex: 1;
        }

        .menu-item {
            padding: 15px 25px; /* Increased padding */
            display: flex;
            align-items: center;
            gap: 18px; /* Increased gap */
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            color: var(--text-gray);
            font-weight: 500; /* Slightly bolder */
        }

        .menu-item span {
            flex: 1;
        }

        .menu-item i {
            width: 22px; /* Adjusted width */
            text-align: center;
            font-size: 1.15rem; /* Adjusted size */
            color: var(--text-gray); /* Consistent icon color */
            transition: var(--transition);
        }

        .menu-item:hover {
            background-color: var(--bg-light);
            color: var(--primary-dark); /* Hover to primary dark */
            border-left-color: var(--primary-color);
        }
         .menu-item:hover i {
            color: var(--primary-dark);
        }

        .menu-item.active {
            background-color: var(--primary-light); /* Lighter primary for active */
            border-left: 4px solid var(--primary-dark); /* Darker border for active */
            color: var(--primary-dark); /* Dark text for active */
            font-weight: 600;
        }
        .menu-item.active i {
            color: var(--primary-dark); /* Match icon color */
        }


        .menu-footer {
            padding: 20px 15px; /* Increased padding */
            text-align: center;
            font-size: 0.85rem; /* Slightly larger */
            color: var(--text-gray);
            border-top: 1px solid var(--border-color);
        }

        .main-content {
            flex: 1;
            padding: 25px; /* Increased padding */
            margin-top: 60px; /* Height of app-header */
            transition: var(--transition);
        }
        
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
        }

        /* Page Styles */
        .page {
            animation: fadeIn 0.5s ease;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 1px solid var(--border-color); /* Add a separator */
            padding-bottom: 15px;
        }

        .page-header h2 {
            margin-bottom: 0;
            color: var(--secondary-dark); /* Consistent heading color */
        }

        .page-description {
            color: var(--text-gray);
            margin-bottom: 25px;
            font-size: 0.95rem; /* Slightly larger description */
            width: 100%;
        }
        
        /* Card Style for general purpose cards */
        .card-style {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }
        .card-style h3 {
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-size: 1.25rem;
        }
        .card-style h3 i {
            margin-right: 10px;
            color: var(--primary-color);
        }

        /* Home Page */
        .slideshow-container {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover); /* More prominent shadow */
            margin-bottom: 30px;
        }

        .slide {
            display: none;
            position: relative;
        }

        .slide img {
            width: 100%;
            vertical-align: middle;
            height: 350px; /* Increased height */
            object-fit: cover;
        }

        .slide-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.85) 20%, transparent); /* Stronger gradient */
            color: var(--text-light);
            padding: 40px 25px 25px; /* Adjusted padding */
        }

        .slide-content h3 {
            color: var(--text-light);
            margin-bottom: 8px;
            font-size: 1.6rem; /* Larger slide title */
        }

        .slide-content p {
            color: rgba(255,255,255,0.85);
            margin-bottom: 0;
            font-size: 1rem; /* Larger slide text */
        }

        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 18px; /* Larger controls */
            margin-top: -25px; /* Adjusted */
            color: white;
            font-weight: bold;
            font-size: 20px;
            transition: 0.6s ease;
            border-radius: 50%; /* Circular controls */
            user-select: none;
            background-color: rgba(0, 0, 0, 0.4);
            transform: translateY(-50%);
        }
        .prev { left: 15px; }
        .next { right: 15px; }


        .prev:hover, .next:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .dot-container {
            text-align: center;
            padding: 15px 0; /* Increased padding */
        }

        .dot {
            cursor: pointer;
            height: 13px; /* Larger dots */
            width: 13px;
            margin: 0 6px;
            background-color: var(--border-color);
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.6s ease;
        }

        .active-dot, .dot:hover {
            background-color: var(--primary-color);
        }
        .fade {
            animation-name: fade;
            animation-duration: 1.5s;
        }
        @keyframes fade {
            from {opacity: .4}
            to {opacity: 1}
        }


        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); /* Adjusted minmax */
            gap: 25px; /* Increased gap */
            margin: 30px 0;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 25px; /* Increased padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 20px; /* Increased gap */
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02); /* Added scale */
            box-shadow: var(--shadow-hover);
        }

        .stat-icon {
            width: 55px; /* Larger icon container */
            height: 55px;
            border-radius: 50%;
            background-color: var(--primary-light); /* Primary light bg */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.7rem; /* Larger icon */
            color: var(--primary-dark); /* Darker icon on light bg */
        }

        .stat-card h3 {
            font-size: 0.95rem; /* Adjusted size */
            color: var(--text-gray);
            margin-bottom: 5px;
            font-weight: 500; /* Normal weight */
        }

        .stat-card p {
            font-size: 1.7rem; /* Larger stat value */
            font-weight: 700;
            color: var(--primary-dark); /* Dark primary for value */
            margin-bottom: 0;
        }

        .quick-actions {
            display: flex;
            gap: 20px; /* Increased gap */
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .quick-action {
            flex: 1 1 160px; /* Adjusted basis */
            min-width: 160px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color); /* Subtle border */
            border-radius: var(--border-radius);
            padding: 20px; /* Increased padding */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px; /* Increased gap */
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            color: var(--text-gray);
            text-align: center;
        }

        .quick-action i {
            font-size: 1.8rem; /* Larger icon */
            color: var(--primary-color);
            transition: var(--transition);
        }

        .quick-action span {
            font-weight: 600; /* Bolder text */
            color: var(--text-dark); /* Darker text */
            transition: var(--transition);
        }

        .quick-action:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }

        .quick-action:hover i, .quick-action:hover span {
            color: var(--text-light);
        }

        .announcement-card { /* Uses .card-style now */
            margin-top: 30px;
        }
        
        .announcement-card h3 i {
            color: var(--accent-color);
        }

        .announcement-content {
            padding: 15px; /* Increased padding */
            background-color: var(--bg-light); /* Light bg for content */
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
         .announcement-content p {
            color: var(--text-dark);
        }


        /* Team Page */
        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .ranking-header h3 { /* Sub-heading style */
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .rank-badge {
            background-color: var(--accent-color);
            color: var(--text-light);
            padding: 8px 18px; /* Adjusted padding */
            border-radius: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px; /* Increased gap */
        }

        .rank-badge i {
            font-size: 1.3rem;
        }

        .action-btn {
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
            font-weight: 500;
            display: inline-flex; /* For inline display with icon */
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .action-btn:hover {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .ranking-table { /* This is a .card-style container */
            margin-bottom: 30px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th, td {
            padding: 14px 18px; /* Increased padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle; /* Better alignment */
        }

        th {
            background-color: var(--bg-light); /* Light bg for header */
            color: var(--primary-dark); /* Primary dark for th text */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem; /* Adjusted size */
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: var(--primary-light); /* Lighter primary for row hover */
        }
         tr:hover td {
            color: var(--primary-dark);
        }


        .current-user {
            background-color: rgba(0, 169, 157, 0.1) !important; /* Primary transparent bg */
            font-weight: 600; /* Bolder current user */
        }
        .current-user td {
            color: var(--primary-dark) !important;
        }


        .invitation-section { /* Uses .card-style */
            margin-bottom: 30px;
        }
        
        .invite-code-container {
            display: flex;
            margin: 20px 0; /* Increased margin */
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 0 0 1px var(--border-color);
        }

        #invite-code {
            flex: 1;
            padding: 12px 15px;
            border: none;
            font-weight: 600;
            font-size: 1.1rem; /* Larger code */
            color: var(--primary-dark);
            background-color: var(--bg-light);
        }

        .copy-btn {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .copy-btn:hover {
            background-color: var(--primary-dark);
        }

        .invite-note {
            font-style: italic;
            color: var(--text-gray);
            margin-bottom: 20px;
            font-size: 0.9rem;
            background-color: var(--bg-light); /* Light bg for note */
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--primary-color);
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Adjusted minmax */
            gap: 20px; /* Increased gap */
            margin: 25px 0;
        }

        .referral-stat {
            background-color: var(--bg-light); /* Consistent light bg */
            padding: 20px; /* Increased padding */
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border-color);
        }
        .referral-stat .stat-icon { /* Shared from home page, but might want specific styling */
            width: 45px;
            height: 45px;
            font-size: 1.3rem;
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }

        .referral-stat h4 {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .referral-stat p {
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0;
            font-size: 1.2rem; /* Larger stat value */
        }

        .referral-share {
            margin: 25px 0;
        }

        .referral-share h4 {
            margin-bottom: 15px;
            color: var(--text-dark); /* Darker heading */
            font-size: 1.05rem; /* Slightly larger */
        }

        .share-buttons {
            display: flex;
            gap: 12px; /* Adjusted gap */
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 10px 18px; /* Adjusted padding */
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px; /* Increased gap */
            font-size: 0.95rem; /* Adjusted size */
            box-shadow: var(--shadow);
        }

        .share-btn i {
            font-size: 1.2rem;
        }

        .share-btn.whatsapp { background-color: #25D366; color: white; }
        .share-btn.facebook { background-color: #1877F2; color: white; } /* Updated FB color */
        .share-btn.copy-link {
            background-color: var(--card-bg);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .share-btn:hover {
            transform: translateY(-2px) scale(1.03); /* Enhanced hover */
            box-shadow: var(--shadow-hover);
            opacity: 0.9;
        }

        .referral-table th, .referral-table td { /* Part of general table styling */
            padding: 12px 15px; /* Adjusted padding */
            font-size: 0.9rem;
        }

        /* Status Badges for Tables */
        .status-pending, .status-completed, .status-rejected, .status-cancelled, .status-active {
            padding: 4px 10px;
            border-radius: 15px; /* Pill shape */
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-block; /* For padding to apply */
            text-transform: capitalize;
        }
        .status-pending { background-color: var(--warning-color); color: var(--text-dark); }
        .status-completed, .status-active { background-color: var(--success-color); color: var(--text-light); }
        .status-rejected, .status-cancelled { background-color: var(--danger-color); color: var(--text-light); }


        /* Plans Page */
        .plans-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Wider cards */
            gap: 25px; /* Increased gap */
            margin-top: 20px;
        }

        .plan-card {
            background-color: var(--card-bg);
            padding: 30px; /* Increased padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color); /* Subtle border */
        }

        .plan-card:hover {
            transform: translateY(-6px) scale(1.01); /* Enhanced hover */
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-color);
        }

        .plan-card h3 {
            color: var(--secondary-dark); /* Secondary color for plan title */
            margin-bottom: 15px; /* Adjusted margin */
            text-align: center;
            font-size: 1.4rem; /* Larger title */
        }

        .plan-price {
            font-size: 2.2rem; /* Larger price */
            font-weight: 700;
            color: var(--primary-dark); /* Primary dark for price */
            text-align: center;
            margin-bottom: 10px;
        }
        .plan-price span.currency { /* If you add "Rs" next to price */
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-gray);
        }


        .plan-duration {
            text-align: center;
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .plan-duration i {
            color: var(--primary-color);
        }


        .plan-features {
            list-style: none;
            margin-bottom: 30px; /* Increased margin */
            flex: 1;
        }

        .plan-features li {
            margin-bottom: 12px; /* Increased margin */
            display: flex;
            align-items: flex-start;
            gap: 12px; /* Increased gap */
            font-size: 0.95rem;
            color: var(--text-dark); /* Darker feature text */
        }

        .plan-features i {
            color: var(--success-color);
            margin-top: 4px; /* Adjusted alignment */
            font-size: 1.1rem; /* Larger check icon */
        }

        .buy-plan-btn { /* Uses .submit-btn style, customized if needed */
            margin-top: auto;
        }
        .buy-plan-btn:disabled {
            background: var(--border-color);
            color: var(--text-gray);
            cursor: not-allowed;
        }
        .buy-plan-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }


        .popular {
            border: 2px solid var(--primary-color); /* Primary border for popular */
            transform: scale(1.02); /* Slightly larger popular plan */
        }
        .popular:hover {
            transform: translateY(-6px) scale(1.03); /* Maintain scale on hover */
        }

        .popular-badge {
            position: absolute;
            top: -12px; /* Adjusted position */
            right: 20px;
            background-color: var(--primary-color); /* Primary for badge */
            color: var(--text-light);
            padding: 6px 18px; /* Adjusted padding */
            border-radius: 20px;
            font-size: 0.85rem; /* Adjusted size */
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .plan-info-card { /* Uses .card-style */
            margin-top: 30px;
        }
        .plan-info-card h3 i {
            color: var(--info-color);
        }

        .info-content {
            padding: 15px;
            background-color: var(--bg-light);
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .info-content p {
            margin-bottom: 12px;
            display: flex;
        }

        .info-content p strong {
            min-width: 130px; /* Adjusted width */
            color: var(--text-dark);
            margin-right: 8px;
        }
        .info-content p span { /* For the value part */
            color: var(--text-gray);
        }

        /* Deposit Page */
        .deposit-methods {
            display: flex;
            gap: 20px; /* Increased gap */
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .method-card {
            background-color: var(--card-bg);
            padding: 20px; /* Increased padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            border: 2px solid transparent;
            min-width: 130px; /* Adjusted width */
            text-align: center;
        }

        .method-card img {
            height: 45px; /* Adjusted height */
            width: auto;
            max-width: 110px;
            object-fit: contain;
            margin-bottom: 5px; /* Space below image */
        }
        .method-card span {
            font-weight: 500;
            color: var(--text-dark);
        }

        .method-card.active {
            border-color: var(--primary-color);
            background-color: rgba(0, 169, 157, 0.05); /* Primary transparent */
            box-shadow: var(--shadow-hover);
            transform: scale(1.03); /* Scale up active method */
        }

        .method-card:hover:not(.active) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-light);
        }

        .deposit-instructions { /* Uses .card-style */
            margin-bottom: 30px;
        }
        .deposit-instructions h3 i {
            color: var(--info-color);
        }

        .account-details {
            background-color: var(--bg-light);
            padding: 20px; /* Increased padding */
            border-radius: var(--border-radius);
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .detail-item {
            display: flex;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center; /* Align items */
        }
        .detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            width: 150px; /* Adjusted width */
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .detail-value {
            flex: 1;
            font-family: 'Roboto Mono', monospace; /* Better mono font */
            font-size: 1.15rem; /* Slightly larger */
            color: var(--primary-dark);
            word-break: break-all;
            background-color: var(--card-bg); /* Light bg for value */
            padding: 5px 8px;
            border-radius: 4px;
        }

        .important-note {
            display: flex;
            gap: 15px; /* Increased gap */
            background-color: rgba(255, 193, 7, 0.1); /* Warning transparent */
            padding: 18px; /* Increased padding */
            border-radius: var(--border-radius);
            margin-top: 25px;
            border-left: 4px solid var(--warning-color);
        }

        .important-note i {
            color: var(--warning-color);
            font-size: 1.3rem;
            margin-top: 3px;
        }

        .important-note p {
            margin-bottom: 0;
            color: var(--text-dark);
            font-size: 0.95rem; /* Slightly larger */
        }

        .deposit-form { /* Uses .card-style */
        }
        .deposit-form h3 i {
            color: var(--primary-color);
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px; /* Increased margin */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); /* Gray arrow */
            background-repeat: no-repeat;
            background-position: right 15px center; /* Adjusted position */
            background-size: 1em;
            transition: var(--transition);
            background-color: var(--bg-light); /* Light bg for select */
            color: var(--text-dark);
        }
        .form-select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 169, 157, 0.2);
        }

        #custom-amount-container {
            margin-top: 10px;
        }

        #custom-amount {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: var(--bg-light);
        }
        #custom-amount:focus {
             border-color: var(--primary-color);
             outline: none;
             box-shadow: 0 0 0 3px rgba(0, 169, 157, 0.2);
        }

        .file-upload {
            position: relative;
            margin-bottom: 20px;
        }

        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-btn {
            display: flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 15px;
            background-color: var(--bg-light);
            color: var(--text-gray);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            border: 2px dashed var(--border-color); /* Dashed border */
            text-align: center;
            width: 100%;
        }
        .upload-btn i {
            font-size: 1.2rem;
        }

        .upload-btn:hover {
            background-color: var(--border-color);
            border-color: var(--primary-color);
            color: var(--primary-dark);
        }

        #file-name {
            display: block;
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--text-gray);
            font-style: italic;
            text-align: center;
        }

        /* Withdraw Page */
        .withdraw-info-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); /* Adjusted minmax */
            gap: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 18px; /* Increased gap */
            padding: 15px;
            background-color: var(--bg-light); /* Light bg for items */
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .info-item i {
            font-size: 1.6rem; /* Larger icon */
            color: var(--primary-color);
            flex-shrink: 0;
            width: 40px; /* Give icon fixed width */
            text-align: center;
        }

        .info-content h4 {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .info-content p {
            font-weight: 600; /* Bolder text */
            color: var(--text-dark);
            margin-bottom: 0;
            font-size: 1.05rem; /* Slightly larger */
        }

        .withdraw-form { /* Uses .card-style */
        }
        .withdraw-form h3 i {
            color: var(--primary-color);
        }

        .amount-buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px; /* Increased margin */
            flex-wrap: wrap;
        }

        .amount-btn {
            padding: 8px 15px; /* Adjusted padding */
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius); /* Consistent radius */
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--primary-dark); /* Darker text for buttons */
            font-weight: 500;
        }

        .amount-btn:hover {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
            transform: scale(1.05); /* Slight scale on hover */
        }
        
        /* History Pages */
        .history-filter {
            display: flex;
            align-items: center;
            gap: 15px; /* Increased gap */
            margin-bottom: 15px;
        }

        .history-filter select, .earnings-filter select { /* Uses .form-select styling */
            min-width: 180px; /* Adjusted width */
            margin-bottom: 0; /* Remove margin if used in header */
        }

        .history-table { /* Container for the table using .card-style */
            padding: 0; /* Remove card padding if table fills it */
            overflow: hidden; /* Keep for rounded corners on table */
        }
        .history-table table { /* The <table> element */
             margin-bottom: 0; /* Remove default table margin */
        }

        .history-table th {
            background-color: var(--primary-color); /* Primary for history th */
            color: var(--text-light);
        }

        .history-table tr:nth-child(even) {
            background-color: var(--bg-light); /* Lighter even rows */
        }
        .history-table tr:hover {
            background-color: var(--primary-light); /* Primary light hover */
        }
         .history-table tr:hover td {
            color: var(--primary-dark);
        }

        .history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Adjusted minmax */
            gap: 20px; /* Increased gap */
            margin-top: 25px; /* Space above summary */
        }

        .summary-card {
            background-color: var(--card-bg);
            padding: 20px; /* Increased padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .summary-card h4 {
            color: var(--text-gray);
            font-size: 0.95rem; /* Adjusted size */
            margin-bottom: 10px;
            font-weight: 500;
        }

        .summary-card p {
            font-weight: 700;
            color: var(--primary-dark); /* Primary dark for value */
            margin-bottom: 0;
            font-size: 1.3rem; /* Larger value */
        }

        .action-link {
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            text-decoration: none; /* Remove underline by default */
            transition: var(--transition);
        }

        .action-link:hover {
            color: var(--primary-dark);
            text-decoration: underline; /* Underline on hover */
        }
        td .action-link {
            font-size: 0.9em;
        }

        /* Earnings Page */
        .earnings-stats {
            margin-bottom: 30px;
        }

        .earnings-chart-container { /* Uses .card-style */
            margin-bottom: 30px;
        }
        .earnings-chart-container h3 i {
            color: var(--primary-color);
        }

        #earnings-chart {
            width: 100% !important;
            max-height: 380px; /* Increased max height */
        }

        .earnings-table-container { /* Uses .card-style */
        }
        .earnings-table-container h3 i {
            color: var(--primary-color);
        }

        .earnings-table th, .earnings-table td { /* Part of .history-table styling */
            font-size: 0.9rem;
        }
        .earnings-table .badge { /* For 'Type' column in earnings */
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-light);
        }
        .earnings-table .badge.investment { background-color: var(--primary-color); }
        .earnings-table .badge.referral { background-color: var(--secondary-color); }
        .earnings-table .badge.milestone { background-color: var(--accent-color); }


        /* Contact Page */
        .contact-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Wider cards */
            gap: 25px; /* Increased gap */
            margin-bottom: 30px;
        }

        .contact-card {
            background-color: var(--card-bg);
            padding: 35px; /* Increased padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .contact-card:hover {
            transform: translateY(-6px) scale(1.01); /* Enhanced hover */
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-color);
        }

        .contact-icon {
            width: 65px; /* Larger icon container */
            height: 65px;
            border-radius: 50%;
            background-color: var(--primary-light); /* Primary light bg */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px; /* Increased margin */
            font-size: 2rem; /* Larger icon */
        }

        .contact-card.whatsapp .contact-icon { color: #25D366; background-color: rgba(37, 211, 102, 0.1); }
        .contact-card.email .contact-icon { color: var(--primary-dark); background-color: var(--primary-light); }
        .contact-card.phone .contact-icon { color: var(--info-color); background-color: rgba(3, 169, 244, 0.1); }

        .contact-card h3 {
            margin-bottom: 12px; /* Adjusted margin */
            font-size: 1.3rem; /* Slightly larger heading */
            color: var(--secondary-dark); /* Secondary color for title */
        }

        .contact-card p {
            margin-bottom: 25px;
            flex: 1;
            color: var(--text-gray);
            font-size: 0.95rem; /* Slightly larger */
        }

        .contact-btn { /* Uses .action-btn styling */
            margin-top: auto;
            padding: 12px 28px; /* Larger contact buttons */
            font-size: 1rem;
        }
        .contact-btn:hover {
             color: var(--text-light); /* Ensure text stays light */
        }


        .contact-form-container { /* Uses .card-style */
        }
        .contact-form-container h3 i {
            color: var(--primary-color);
        }

        #contact-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        #contact-form input,
        #contact-form textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px; /* Increased margin */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        #contact-form textarea {
            resize: vertical;
            min-height: 130px; /* Increased height */
        }

        #contact-form input:focus,
        #contact-form textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 169, 157, 0.2);
            background-color: var(--card-bg);
        }
        #contact-form .submit-btn { /* Using general submit-btn styling */
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(247, 250, 252, 0.85); /* Lighter overlay, matches bg-light */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(3px); /* Subtle blur */
        }

        .loader-content {
            background-color: var(--card-bg);
            padding: 35px 45px; /* Increased padding */
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-hover);
            color: var(--text-dark);
        }

        .loader-content i {
            font-size: 2.8rem; /* Larger spinner */
            color: var(--primary-color);
            margin-bottom: 20px; /* Increased margin */
            display: block;
        }

        .loader-content p {
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        /* Notification System */
        #notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px; /* Increased gap */
            width: calc(100% - 40px);
            max-width: 400px; /* Wider notifications */
        }

        .notification {
            padding: 18px 22px; /* Increased padding */
            border-radius: var(--border-radius);
            color: var(--text-light);
            box-shadow: var(--shadow-hover);
            animation: slideInRight 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), fadeOut 0.5s ease-in 3.5s forwards; /* Smoother animation */
            display: flex;
            align-items: center;
            gap: 18px; /* Increased gap */
            font-size: 1rem; /* Slightly larger */
            line-height: 1.5; /* Improved line height */
        }

        @keyframes slideInRight {
            from { transform: translateX(120%) translateY(-10px) scale(0.95); opacity: 0; } /* Added subtle intro anim */
            to { transform: translateX(0) translateY(0) scale(1); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1) translateY(0); }
            to { opacity: 0; transform: scale(0.9) translateY(-10px); } /* Added subtle outro anim */
        }

        .notification i {
            font-size: 1.4rem; /* Larger icon */
            flex-shrink: 0;
        }

        .notification.success { background: linear-gradient(to right, var(--success-color), #66BB6A); } /* Gradient */
        .notification.error { background: linear-gradient(to right, var(--danger-color), #EF5350); }
        .notification.warning { background: linear-gradient(to right, var(--warning-color), #FFCA28); color: var(--text-dark); }
        .notification.info { background: linear-gradient(to right, var(--info-color), #29B6F6); }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(45, 55, 72, 0.75); /* Darker backdrop, text-dark with alpha */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 20px;
            backdrop-filter: blur(4px); /* Modal backdrop blur */
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 35px; /* Increased padding */
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 480px; /* Wider modals */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25); /* Stronger shadow */
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease;
            position: relative;
            opacity: 0;
        }

        .modal.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal-icon {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-icon i {
            font-size: 3.8rem; /* Larger modal icon */
            display: none;
        }

        .modal-icon i.success { display: block; color: var(--success-color); }
        .modal-icon i.warning { display: block; color: var(--warning-color); }
        .modal-icon i.error { display: block; color: var(--danger-color); }

        .modal h3 {
            text-align: center;
            margin-bottom: 18px; /* Adjusted margin */
            color: var(--secondary-dark); /* Modal title color */
            font-size: 1.5rem; /* Larger modal title */
        }

        .modal p {
            text-align: center;
            margin-bottom: 30px; /* Increased margin */
            color: var(--text-gray);
            line-height: 1.6; /* Improved line height */
            font-size: 1rem; /* Slightly larger */
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 18px; /* Increased gap */
            margin-top: 15px; /* Adjusted margin */
        }

        .modal-btn {
            padding: 10px 28px; /* Adjusted padding */
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 120px;
            font-size: 0.95rem;
            box-shadow: var(--shadow);
        }

        .modal-btn.cancel {
            background-color: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .modal-btn.cancel:hover {
            background-color: var(--border-color);
            box-shadow: var(--shadow-hover);
        }

        .modal-btn.confirm {
            background-color: var(--primary-color);
            color: var(--text-light);
        }
        .modal-btn.confirm.error { background-color: var(--danger-color); }
        .modal-btn.confirm.warning { background-color: var(--warning-color); color: var(--text-dark); }

        .modal-btn.confirm:hover {
            background-color: var(--primary-dark);
            box-shadow: var(--shadow-hover);
            transform: translateY(-1px);
        }
        .modal-btn.confirm.error:hover { background-color: var(--accent-dark); }
        .modal-btn.confirm.warning:hover { background-color: var(--accent-light); }

        .terms-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        .terms-text {
            margin-bottom: 25px;
            font-size: 0.95rem; /* Slightly larger */
            line-height: 1.7;
        }
        .terms-text p {
            color: var(--text-dark); /* Ensure good readability */
        }
        .terms-text h4 {
            margin-top: 25px; /* Increased margin */
            color: var(--primary-dark); /* Primary dark for subheadings */
            font-size: 1.15rem; /* Adjusted size */
        }
        .terms-content #terms-accept.submit-btn {
             width: auto;
             margin: 20px auto 0;
             display: block;
             padding: 12px 30px; /* More padding for accept button */
        }

        .screenshot-content {
            max-width: 550px; /* Wider screenshot modal */
        }

        #screenshot-preview {
            min-height: 280px; /* Adjusted height */
            max-height: 450px;
            background-color: var(--bg-light); /* Light bg for preview */
            border-radius: var(--border-radius); /* Consistent radius */
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        #screenshot-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 5px;
        }
         #screenshot-preview p {
            color: var(--text-gray);
            font-style: italic;
            padding: 20px; /* Padding for placeholder */
        }
        
        /* Referral Invites Block - Team Page */
        .invites-block { /* Uses .card-style */
            margin-top: 30px;
        }
        .invites-block h3 { /* Specific icon color for this block */
            color: var(--secondary-dark);
        }
        .invites-block h3 i {
            color: var(--secondary-color);
        }
        .referral-level-info p {
            font-size: 1.05rem;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }
        .referral-level-info p strong {
            color: var(--primary-dark);
        }
        .referral-milestones {
            margin-top: 20px;
        }
        .referral-milestones h4 {
            font-size: 1rem;
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        .referral-milestones ul {
            list-style: none;
            padding-left: 0;
        }
        .referral-milestones li {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.95rem;
            color: var(--text-gray);
        }
        .referral-milestones li:last-child {
            border-bottom: none;
        }
        .referral-milestones li .status-completed { /* Using existing status badge */
             margin-left: 5px;
        }
        .referral-milestones li .status-pending {
            margin-left: 5px;
            background-color: transparent;
            color: var(--text-gray);
            padding: 0;
            font-style: italic;
        }

        .next-milestone-progress {
            margin-top: 20px;
        }
        .next-milestone-progress p {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 8px;
        }
        .progress-bar-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            height: 12px; /* Thicker progress bar */
        }
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.5s ease-in-out;
            border-radius: var(--border-radius);
            text-align: center;
            line-height: 12px;
            font-size: 0.7rem;
            color: white;
        }


        /* Responsive Styles */
        @media (max-width: 992px) {
            .stat-card.large {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .stats-container, .referral-stats, .earnings-stats {
                grid-template-columns: 1fr;
            }
            .app-title { font-size: 1.8rem; }
            .auth-form { padding: 25px; }
            .side-menu { width: 260px; left: -270px; }
            .side-menu.active { left: 0; }
            .main-content { padding: 20px; margin-top: 56px; /* Header height might change */ }
            .quick-actions { justify-content: space-around; }
            .quick-action { flex-basis: calc(48% - 10px); } /* 2 per row */
            .contact-methods { grid-template-columns: 1fr; }
            #notification-container { top: 70px; width: calc(100% - 30px); }
            .slide img { height: 280px; }
        }

        @media (max-width: 480px) {
            #auth-options { flex-direction: column; gap: 15px; }
            .auth-btn { width: 100%; }
            .auth-form { padding: 20px; }
            .modal-content { padding: 25px; margin: 0 10px; }
            .modal-buttons { flex-direction: column-reverse; gap: 12px; }
            .modal-btn { width: 100%; }
            .history-filter, .earnings-filter { flex-direction: column; align-items: stretch; }
            .history-filter select, .earnings-filter select { width: 100%; }
            .quick-action { flex-basis: 100%; } /* 1 per row */
            .app-logo h1 { font-size: 1.1rem; }
            .slide img { height: 220px; }
            .prev, .next { padding: 14px; font-size: 18px; }
            .dot { height: 11px; width: 11px; }
            .deposit-methods .method-card { min-width: calc(50% - 10px); padding: 15px; } /* 2 per row */
            .deposit-methods .method-card img { height: 35px; }
            .detail-label, .detail-value { width: 100%; }
            .detail-value { font-size: 1.05rem;}
            .plans-container { grid-template-columns: 1fr; } /* Stack plans */
        }

    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="auth-container" class="container">
        <div class="logo-container">
            <img src="https://cdn-icons-png.flaticon.com/512/2936/2936886.png" alt="Video Treasure Logo" class="logo">
            <h1 class="app-title">Video Treasure Pro</h1>
        </div>
        
        <div id="auth-options">
            <button id="register-btn" class="auth-btn animate__animated animate__fadeInUp">Register</button>
            <button id="login-btn" class="auth-btn animate__animated animate__fadeInUp">Login</button>
        </div>
        
        <div id="register-form" class="auth-form hidden">
            <h2>Create Account</h2>
            <div class="form-group">
                <i class="fas fa-user"></i>
                <input type="text" id="reg-name" placeholder="Full Name" required>
            </div>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="reg-email" placeholder="Email" required>
            </div>
            <div class="form-group password-container has-strength">
                <i class="fas fa-lock"></i>
                <input type="password" id="reg-password" placeholder="Password" required>
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
                <div class="password-strength">
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-text"></span>
                </div>
            </div>
            <div class="form-group password-container">
                <i class="fas fa-lock"></i>
                <input type="password" id="reg-confirm-password" placeholder="Confirm Password" required>
            </div>
            <div class="form-group">
                <i class="fas fa-phone"></i>
                <input type="text" id="reg-phone" placeholder="Phone Number (e.g., 03xxxxxxxxx)" required>
            </div>
            <div class="form-group">
                <i class="fas fa-user-plus"></i>
                <input type="text" id="reg-invite" placeholder="Invitation Code (Optional)">
            </div>
            <div class="form-group terms">
                <input type="checkbox" id="reg-terms">
                <label for="reg-terms">I agree to the <a href="#" id="terms-link">Terms & Conditions</a></label>
            </div>
            <button id="submit-register" class="submit-btn">
                <span class="btn-text">Register</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="auth-switch">Already have an account? <span id="switch-to-login">Login</span></p>
        </div>
        
        <div id="login-form" class="auth-form hidden">
            <h2>Login</h2>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="login-email" placeholder="Email" required>
            </div>
            <div class="form-group password-container">
                <i class="fas fa-lock"></i>
                <input type="password" id="login-password" placeholder="Password" required>
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
            </div>
            <button id="submit-login" class="submit-btn">
                <span class="btn-text">Login</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="forgot-password" id="forgot-password">Forgot Password?</p>
            <p class="auth-switch">Don't have an account? <span id="switch-to-register">Register</span></p>
        </div>
        
        <div id="reset-form" class="auth-form hidden">
            <h2>Reset Password</h2>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="reset-email" placeholder="Enter your email" required>
            </div>
            <button id="submit-reset" class="submit-btn">
                <span class="btn-text">Send Reset Link</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="auth-switch">Remember your password? <span id="switch-to-login-from-reset">Login</span></p>
        </div>
        
        <div id="email-verify-notice" class="auth-form hidden">
            <h2>Verify Your Email</h2>
            <i class="fas fa-envelope-open-text verify-icon"></i>
            <p>We've sent a verification email to <strong id="verify-email-address">your.email@example.com</strong>. Please check your inbox (and spam folder) and click the verification link to activate your account.</p>
            <p>Didn't receive the email? <span id="resend-verify" class="auth-switch">Resend Email</span></p>
            <button id="verify-continue" class="submit-btn hidden" style="margin-top:20px;">Continue (after verification)</button>
        </div>
    </div>
    
    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <div class="app-logo">
                <img src="https://cdn-icons-png.flaticon.com/512/2936/2936886.png" alt="Video Treasure Logo">
                <h1>Video Treasure Pro</h1>
            </div>
            <div class="user-info">
                <div class="balance-container">
                    <i class="fas fa-wallet" style="font-size: 0.9em; opacity: 0.8;"></i>
                    <span id="user-balance">0 Rs</span>
                    <i class="fas fa-sync-alt refresh-balance" id="refresh-balance" title="Refresh Balance"></i>
                </div>
                <div class="user-avatar" id="user-profile">
                    <i class="fas fa-user-circle"></i>
                    <span class="online-status"></span>
                </div>
            </div>
        </header>
        
        <!-- Side Menu -->
        <div class="side-menu" id="side-menu">
            <div class="menu-header">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User Profile" id="menu-user-img">
                <h3 id="menu-username">User Name</h3>
                <span id="menu-user-email">user@example.com</span>
                <div class="user-level">
                    <span id="user-level-badge">Standard</span>
                </div>
            </div>
            <ul class="menu-items">
                <li class="menu-item active" data-page="home"><i class="fas fa-home"></i> <span>Home</span></li>
                <li class="menu-item" data-page="team"><i class="fas fa-users"></i> <span>Team & Rewards</span></li>
                <li class="menu-item" data-page="plans"><i class="fas fa-box-open"></i> <span>Plans</span></li>
                <li class="menu-item" data-page="deposit"><i class="fas fa-money-bill-wave"></i> <span>Deposit</span></li>
                <li class="menu-item" data-page="withdraw"><i class="fas fa-wallet"></i> <span>Withdraw</span></li>
                <li class="menu-item" data-page="deposit-history"><i class="fas fa-history"></i> <span>Deposit History</span></li>
                <li class="menu-item" data-page="withdraw-history"><i class="fas fa-clock"></i> <span>Withdraw History</span></li>
                <li class="menu-item" data-page="earnings"><i class="fas fa-chart-line"></i> <span>Earnings</span></li>
                <li class="menu-item" data-page="contact"><i class="fas fa-headset"></i> <span>Contact Us</span></li>
                <li class="menu-item" id="logout-btn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></li>
            </ul>
            <div class="menu-footer">
                <p>&copy; 2024 Video Treasure Pro</p>
                <p>Version 2.1.0</p>
            </div>
        </div>
        
        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden">
                <div class="loader-content">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading...</p>
                </div>
            </div>
            
            <!-- Home Page -->
            <div class="page" id="home-page">
                <div class="slideshow-container">
                    <div class="slide fade">
                        <img src="https://images.unsplash.com/photo-1620714223084-8fcacc6dfd8d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGludmVzdG1lbnQlMjBncm93dGh8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=800&q=60" style="width:100%">
                        <div class="slide-content">
                            <h3>Maximize Your Earnings</h3>
                            <p>Invest in our diverse plans and watch your capital grow with daily returns.</p>
                        </div>
                    </div>
                    <div class="slide fade">
                        <img src="https://images.unsplash.com/photo-1556761175-5973dc0f32e7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8cmVmZXJyYWwlMjBwcm9ncmFtfGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60" style="width:100%">
                        <div class="slide-content">
                            <h3>Unlock Referral Rewards</h3>
                            <p>Invite friends and earn commissions, plus exciting milestone bonuses!</p>
                        </div>
                    </div>
                    <div class="slide fade">
                        <img src="https://images.pexels.com/photos/50987/money-card-business-credit-card-50987.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" style="width:100%">
                        <div class="slide-content">
                            <h3>Swift & Secure Withdrawals</h3>
                            <p>Access your earnings easily via Easypaisa or JazzCash.</p>
                        </div>
                    </div>
                    <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                    <a class="next" onclick="plusSlides(1)">&#10095;</a>
                </div>
                <br>
                <div class="dot-container" style="text-align:center">
                    <span class="dot" onclick="currentSlide(1)"></span> 
                    <span class="dot" onclick="currentSlide(2)"></span> 
                    <span class="dot" onclick="currentSlide(3)"></span> 
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Balance</h3>
                            <p id="total-balance">0 Rs</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Active Plan</h3>
                            <p id="active-plan">None</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Daily Earnings</h3>
                            <p id="daily-earnings">0 Rs</p>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="quick-action" id="quick-deposit">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Deposit</span>
                    </button>
                    <button class="quick-action" id="quick-withdraw">
                        <i class="fas fa-wallet"></i>
                        <span>Withdraw</span>
                    </button>
                    <button class="quick-action" id="quick-invite">
                        <i class="fas fa-user-plus"></i>
                        <span>Invite Friends</span>
                    </button>
                </div>
                
                <div class="announcement-card card-style">
                    <h3><i class="fas fa-bullhorn"></i> Platform Updates</h3>
                    <div class="announcement-content">
                        <p id="announcement-text">Welcome to the enhanced Video Treasure Pro! Explore new referral rewards and enjoy our updated platform look. Invest wisely!</p>
                    </div>
                </div>
            </div>
            
            <!-- Team Page -->
            <div class="page hidden" id="team-page">
                <div class="page-header">
                    <h2>Your Team & Rewards</h2>
                </div>
                
                <div class="invitation-section card-style">
                    <h3><i class="fas fa-user-plus"></i> Your Invitation Code</h3>
                    <div class="invite-code-container">
                        <input type="text" id="invite-code" readonly>
                        <button id="copy-invite" class="copy-btn">
                            <i class="far fa-copy"></i> Copy
                        </button>
                    </div>
                    <p class="invite-note">Share this code with friends. You'll earn commission on their first plan purchase, and unlock milestone rewards as your team grows!</p>
                    
                    <div class="referral-stats">
                        <div class="referral-stat">
                            <div class="stat-icon"> <i class="fas fa-users"></i> </div>
                            <div class="stat-info">
                                <h4>Total Referrals</h4>
                                <p id="total-referrals">0</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                             <div class="stat-icon"> <i class="fas fa-hand-holding-usd"></i> </div>
                            <div class="stat-info">
                                <h4>Commission Earned</h4>
                                <p id="referral-earnings">0 Rs</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                           <div class="stat-icon"> <i class="fas fa-calendar-day"></i> </div>
                            <div class="stat-info">
                                <h4>Today's Commission</h4>
                                <p id="today-referral-earnings">0 Rs</p>
                            </div>
                        </div>
                         <div class="referral-stat">
                           <div class="stat-icon"> <i class="fas fa-star"></i> </div>
                            <div class="stat-info">
                                <h4>Referral Level</h4>
                                <p id="referral-user-level-display">Starter</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="referral-share">
                        <h4>Share Your Link:</h4>
                        <div class="share-buttons">
                            <button class="share-btn whatsapp"> <i class="fab fa-whatsapp"></i> WhatsApp </button>
                            <button class="share-btn facebook"> <i class="fab fa-facebook"></i> Facebook </button>
                            <button class="share-btn copy-link"> <i class="fas fa-link"></i> Copy Link </button>
                        </div>
                    </div>
                </div>

                <div class="invites-block card-style">
                    <h3><i class="fas fa-gifts"></i> Referral Milestones</h3>
                    <div class="referral-milestones">
                        <ul id="milestones-list">
                            <!-- JS will populate this -->
                        </ul>
                    </div>
                    <div class="next-milestone-progress">
                        <p id="next-milestone-info">Loading next milestone...</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="milestone-progress-bar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                </div>

                <div class="ranking-header" style="margin-top:30px;">
                    <h3>Your Current Rank</h3>
                    <div class="rank-badge" id="user-rank-badge">
                        <span>#0</span>
                        <i class="fas fa-trophy"></i>
                    </div>
                </div>
                
                <button id="view-ranking-btn" class="action-btn">
                    <i class="fas fa-list-ol"></i> View Full Ranking
                </button>
                
                <div class="ranking-table card-style hidden" id="ranking-table-container"> <!-- Renamed ID -->
                    <h3>Top Investors</h3>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Investment</th>
                                    <th>Total Earnings</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="referral-history-section card-style" style="margin-top:30px;"> <!-- New wrapper -->
                    <h3><i class="fas fa-history"></i> Referral Commission History</h3>
                    <div class="table-responsive">
                        <table class="referral-table history-table">
                            <thead>
                                <tr>
                                    <th>Referred User</th>
                                    <th>Plan Purchased</th>
                                    <th>Commission</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="referral-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Plans Page -->
            <div class="page hidden" id="plans-page">
                <div class="page-header">
                    <h2>Investment Plans</h2>
                </div>
                <p class="page-description">Choose a plan to start earning daily 5% returns for 30 days. Principal returned at end of term.</p>
                
                <div class="plans-container">
                    <div class="plan-card">
                        <h3>Basic Plan</h3>
                        <div class="plan-price">550 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="550">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                    
                    <div class="plan-card popular">
                        <div class="popular-badge">Most Popular</div>
                        <h3>Silver Plan</h3>
                        <div class="plan-price">1400 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="1400">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                    
                    <div class="plan-card">
                        <h3>Gold Plan</h3>
                        <div class="plan-price">2800 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="2800">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                    
                    <div class="plan-card">
                        <h3>Platinum Plan</h3>
                        <div class="plan-price">5600 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="5600">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                    
                    <div class="plan-card">
                        <h3>Diamond Plan</h3>
                        <div class="plan-price">8400 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 5%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 150%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="8400">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                </div>
                
                <div class="plan-info-card card-style">
                    <h3><i class="fas fa-info-circle"></i> Plan Information</h3>
                    <div class="info-content">
                        <p><strong>Daily Earnings:</strong> <span>5% of your investment amount</span></p>
                        <p><strong>Duration:</strong> <span>30 days (including weekends)</span></p>
                        <p><strong>Total Return:</strong> <span>150% (Principal + 50% profit)</span></p>
                        <p><strong>Withdrawals:</strong> <span>Daily earnings can be withdrawn anytime (Min. 200 Rs)</span></p>
                        <p><strong>Principal:</strong> <span>Returned to your balance at the end of the plan period</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Deposit Page -->
            <div class="page hidden" id="deposit-page">
                <div class="page-header">
                    <h2>Deposit Funds</h2>
                </div>
                 <p class="page-description">Add funds to your account to purchase investment plans. Currently, Easypaisa is supported for deposits.</p>
                
                <div class="deposit-methods">
                    <div class="method-card active" data-method="easypaisa">
                        <img src="https://www.easypaisa.com.pk/wp-content/uploads/2022/02/Easypaisa-Logo.png" alt="Easypaisa">
                        <span>Easypaisa</span>
                    </div>
                     <!-- Add other methods here if needed -->
                </div>
                
                <div class="deposit-instructions card-style">
                    <h3><i class="fas fa-info-circle"></i> Deposit Instructions (Easypaisa)</h3>
                    <p>Send money to the following Easypaisa account details. Ensure you enter the correct Transaction ID when submitting the form.</p>
                    <div class="account-details">
                        <div class="detail-item">
                            <span class="detail-label">Account Number:</span>
                            <span class="detail-value" id="deposit-account-number">03709912807</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Account Holder:</span>
                            <span class="detail-value" id="deposit-account-name">Memoona zohra</span>
                        </div>
                    </div>
                    <div class="important-note">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>After sending money, please fill out the form below accurately to verify your deposit. Processing typically takes 5-15 minutes. An incorrect Transaction ID will delay verification.</p>
                    </div>
                </div>
                
                <div class="deposit-form card-style">
                    <h3><i class="fas fa-edit"></i> Submit Deposit Details</h3>
                    <div class="form-group">
                        <label for="deposit-amount">Amount (Rs)</label>
                        <select id="deposit-amount" class="form-select">
                            <option value="">Select Amount or Plan</option>
                            <option value="550">550 Rs (Basic Plan)</option>
                            <option value="1400">1400 Rs (Silver Plan)</option>
                            <option value="2800">2800 Rs (Gold Plan)</option>
                            <option value="5600">5600 Rs (Platinum Plan)</option>
                            <option value="8400">8400 Rs (Diamond Plan)</option>
                            <option value="other">Other Amount</option>
                        </select>
                        <div id="custom-amount-container" class="hidden form-group" style="margin-top: 10px;">
                             <label for="custom-amount">Custom Amount (Min 550 Rs)</label>
                            <input type="number" id="custom-amount" placeholder="Enter custom amount" min="550">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="deposit-transaction">Transaction ID (TID / TrxID)</label>
                        <input type="text" id="deposit-transaction" placeholder="Enter the exact transaction ID from Easypaisa" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="deposit-sender">Your Easypaisa Mobile Number</label>
                        <input type="text" id="deposit-sender" placeholder="Enter your 11-digit Easypaisa number" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="deposit-screenshot">Payment Screenshot (Optional but Recommended)</label>
                        <div class="file-upload">
                            <input type="file" id="deposit-screenshot" accept="image/*">
                            <label for="deposit-screenshot" class="upload-btn">
                                <i class="fas fa-cloud-upload-alt"></i> <span>Choose Screenshot</span>
                            </label>
                            <span id="file-name">No file chosen</span>
                        </div>
                    </div>
                    
                    <button id="submit-deposit" class="submit-btn">
                        <span class="btn-text">Submit Deposit</span>
                        <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
            </div>
            
            <!-- Withdraw Page -->
            <div class="page hidden" id="withdraw-page">
                <div class="page-header">
                    <h2>Withdraw Funds</h2>
                </div>
                <p class="page-description">Minimum withdrawal: 200 Rs. Maximum withdrawal per transaction: 20,000 Rs. A 5% fee applies.</p>
                
                <div class="withdraw-info-card">
                    <div class="info-item">
                        <i class="fas fa-wallet"></i>
                        <div class="info-content">
                            <h4>Available Balance</h4>
                            <p id="withdraw-available-balance">0 Rs</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-clock"></i>
                        <div class="info-content">
                            <h4>Processing Time</h4>
                            <p>1-6 hours (Business Hours)</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-percentage"></i>
                        <div class="info-content">
                            <h4>Withdrawal Fee</h4>
                            <p>5% (Standard)</p>
                        </div>
                    </div>
                </div>
                
                <div class="withdraw-form card-style">
                    <h3><i class="fas fa-money-bill-wave"></i> Withdrawal Request</h3>
                    
                    <div class="form-group">
                        <label for="withdraw-method">Withdrawal Method</label>
                        <select id="withdraw-method" class="form-select">
                            <option value="">Select Method</option>
                            <option value="easypaisa">Easypaisa</option>
                            <option value="jazzcash">JazzCash</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="withdraw-account">Account Number (11 Digits)</label>
                        <input type="text" id="withdraw-account" placeholder="Enter your Easypaisa/JazzCash number" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="withdraw-name">Account Holder Name</label>
                        <input type="text" id="withdraw-name" placeholder="Enter the name registered with the account" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="withdraw-amount">Amount to Withdraw (Rs)</label>
                        <input type="number" id="withdraw-amount" placeholder="Min 200, Max 20000" min="200" max="20000" required>
                        <div class="amount-buttons">
                            <button class="amount-btn" data-amount="200">200</button>
                            <button class="amount-btn" data-amount="500">500</button>
                            <button class="amount-btn" data-amount="1000">1000</button>
                            <button class="amount-btn" data-amount="2000">2000</button>
                            <button class="amount-btn" data-amount="5000">5000</button>
                        </div>
                    </div>
                    
                    <button id="submit-withdraw" class="submit-btn">
                        <span class="btn-text">Request Withdrawal</span>
                        <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
            </div>
            
            <!-- Deposit History Page -->
            <div class="page hidden" id="deposit-history-page">
                <div class="page-header">
                    <h2>Deposit History</h2>
                    <div class="history-filter">
                        <select id="deposit-filter" class="form-select">
                            <option value="all">All Deposits</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                
                <div class="history-table card-style">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="deposit-history-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="history-summary">
                    <div class="summary-card">
                        <h4>Total Deposits</h4>
                        <p id="total-deposits">0 Rs</p>
                    </div>
                    <div class="summary-card">
                        <h4>Pending Deposits</h4>
                        <p id="pending-deposits">0 Rs</p>
                    </div>
                    <div class="summary-card">
                        <h4>Completed Deposits</h4>
                        <p id="completed-deposits">0 Rs</p>
                    </div>
                </div>
            </div>
            
            <!-- Withdraw History Page -->
            <div class="page hidden" id="withdraw-history-page">
                <div class="page-header">
                    <h2>Withdrawal History</h2>
                    <div class="history-filter">
                        <select id="withdraw-filter" class="form-select">
                            <option value="all">All Withdrawals</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                
                <div class="history-table card-style">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="withdraw-history-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="history-summary">
                    <div class="summary-card">
                        <h4>Total Withdrawals</h4>
                        <p id="total-withdrawals">0 Rs</p>
                    </div>
                    <div class="summary-card">
                        <h4>Pending Withdrawals</h4>
                        <p id="pending-withdrawals">0 Rs</p>
                    </div>
                    <div class="summary-card">
                        <h4>Completed Withdrawals</h4>
                        <p id="completed-withdrawals">0 Rs</p>
                    </div>
                </div>
            </div>
            
            <!-- Earnings Page -->
            <div class="page hidden" id="earnings-page">
                <div class="page-header">
                    <h2>Your Earnings Overview</h2>
                    <div class="earnings-filter">
                        <select id="earnings-period" class="form-select">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                </div>
                
                <div class="earnings-stats stats-container"> <!-- Re-used stats-container styling -->
                    <div class="stat-card large">
                        <div class="stat-icon"> <i class="fas fa-coins"></i> </div>
                        <div class="stat-info">
                            <h3>Total Earnings (All Time)</h3>
                            <p id="total-earnings">0 Rs</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"> <i class="fas fa-calendar-day"></i> </div>
                        <div class="stat-info">
                            <h3>Today's Earnings</h3>
                            <p id="today-earnings">0 Rs</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"> <i class="fas fa-user-friends"></i> </div>
                        <div class="stat-info">
                            <h3>Referral Earnings</h3>
                            <p id="all-referral-earnings">0 Rs</p>
                        </div>
                    </div>
                </div>
                
                <div class="earnings-chart-container card-style">
                    <h3><i class="fas fa-chart-line"></i> Earnings Trend</h3>
                    <canvas id="earnings-chart"></canvas>
                </div>
                
                <div class="earnings-table-container card-style history-table"> <!-- Added history-table for styling consistency -->
                    <h3><i class="fas fa-list"></i> Recent Earnings History</h3>
                    <div class="table-responsive">
                        <table class="earnings-table"> <!-- Removed history-table from <table> for specific overrides -->
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="earnings-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Contact Page -->
            <div class="page hidden" id="contact-page">
                <div class="page-header">
                    <h2>Contact Support</h2>
                </div>
                 <p class="page-description">Have questions or need assistance? Our support team is here to help. Choose your preferred method to get in touch.</p>
                
                <div class="contact-methods">
                    <div class="contact-card">
                        <div class="contact-icon whatsapp"> <i class="fab fa-whatsapp"></i> </div>
                        <h3>WhatsApp Support</h3>
                        <p>Chat with us directly on WhatsApp for quick answers and support.</p>
                        <a href="https://wa.me/923359408248" target="_blank" class="contact-btn action-btn">Chat Now</a>
                    </div>
                    
                    <div class="contact-card">
                        <div class="contact-icon email"> <i class="fas fa-envelope"></i> </div>
                        <h3>Email Support</h3>
                        <p>Send us an email with your query. We aim to respond within 24 hours.</p>
                        <a href="mailto:hteh34641557@gmail.com" class="contact-btn action-btn">Email Us</a>
                    </div>
                    
                    <div class="contact-card">
                        <div class="contact-icon phone"> <i class="fas fa-phone-alt"></i> </div>
                        <h3>Call Support</h3>
                        <p>Reach us by phone during business hours (10 AM - 6 PM, Mon-Fri).</p>
                        <a href="tel:+923359408248" class="contact-btn action-btn">Call Now</a>
                    </div>
                </div>
                
                <div class="contact-form-container card-style">
                    <h3><i class="fas fa-paper-plane"></i> Send us a Message Directly</h3>
                    <form id="contact-form">
                        <div class="form-group">
                            <label for="contact-name">Your Name</label>
                            <input type="text" id="contact-name" placeholder="Enter your full name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-email">Your Email Address</label>
                            <input type="email" id="contact-email" placeholder="Enter your email for our reply" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-subject">Subject</label>
                            <input type="text" id="contact-subject" placeholder="Briefly describe your query" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-message">Message</label>
                            <textarea id="contact-message" rows="5" placeholder="Please provide details here..." required></textarea>
                        </div>
                        
                        <button type="submit" class="submit-btn">
                            <span class="btn-text">Send Message</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Notification System -->
    <div id="notification-container"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content animate__animated animate__fadeInDown animate__faster">
            <div class="modal-icon">
                <i class="fas fa-check-circle success"></i>
                <i class="fas fa-exclamation-circle warning"></i>
                <i class="fas fa-times-circle error"></i>
            </div>
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-message">Are you sure you want to perform this action?</p>
            <div class="modal-buttons">
                <button id="modal-cancel" class="modal-btn cancel">Cancel</button>
                <button id="modal-confirm" class="modal-btn confirm">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Terms Modal -->
    <div id="terms-modal" class="modal hidden">
        <div class="modal-content terms-content animate__animated animate__fadeInUp animate__faster">
            <h3>Terms & Conditions</h3>
            <div class="terms-text">
                <p><strong>Last Updated: July 2024</strong></p>
                
                <h4>1. Investment Plans</h4>
                <p>All investment plans offered by Video Treasure Pro have a fixed duration of 30 days. Daily earnings are calculated at a rate of 5% of the principal investment amount. These earnings are credited daily to your account balance.</p>
                
                <h4>2. Withdrawals</h4>
                <p>The minimum amount for withdrawal is 200 Rs. Withdrawal requests are typically processed within 1 to 6 hours during standard business hours (10:00 AM to 6:00 PM, Monday to Friday). A standard withdrawal fee of 5% applies to all transactions. Maximum withdrawal per transaction is 20,000 Rs.</p>
                
                <h4>3. Referral Program</h4>
                <p>Users can earn a commission (typically 10%, subject to change) on the first investment amount of their directly referred users. Additional milestone rewards may be available for achieving specific numbers of active referrals. All referral earnings are added to the user's withdrawable balance. Video Treasure Pro reserves the right to modify the referral program terms at any time.</p>
                
                <h4>4. Account Security</h4>
                <p>You are solely responsible for maintaining the confidentiality of your account credentials, including your password. Video Treasure Pro is not liable for any loss or damage arising from your failure to protect your account. You must notify us immediately of any unauthorized use of your account or any other breach of security.</p>
                
                <h4>5. Amendments to Terms</h4>
                <p>Video Treasure Pro reserves the right to modify these Terms & Conditions at any time without prior notice. Any changes will be effective immediately upon posting the revised terms on the platform. Your continued use of the platform after such modifications constitutes your acceptance of the new Terms & Conditions.</p>
                
                <h4>6. Prohibited Activities</h4>
                <p>Users are prohibited from creating multiple accounts for exploiting the referral system, using automated scripts or bots, engaging in fraudulent activities, or attempting to exploit any vulnerabilities in the system. Violation of these terms may result in account suspension or termination and forfeiture of funds.</p>

                <h4>7. Disclaimer of Liability</h4>
                <p>Video Treasure Pro provides its services "as is" and makes no warranties regarding the platform's reliability or profitability. Investment involves risk, and past performance is not indicative of future results. We are not responsible for any financial losses incurred by users.</p>
            </div>
            <button id="terms-accept" class="submit-btn">I Understand & Accept</button>
        </div>
    </div>
    
    <!-- Screenshot Preview Modal -->
    <div id="screenshot-modal" class="modal hidden">
        <div class="modal-content screenshot-content animate__animated animate__zoomIn animate__faster">
            <h3>Payment Screenshot Preview</h3>
            <div class="screenshot-preview" id="screenshot-preview">
                <p>No image selected or preview not available.</p>
            </div>
            <div class="modal-buttons">
                <button id="screenshot-cancel" class="modal-btn cancel">Change Image</button>
                <button id="screenshot-confirm" class="modal-btn confirm">Use This Image</button>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // app.js
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCDJDsUZ-RwkC5h2LH7mRql1SSixINGT-8", // Replace with your actual API key
            authDomain: "video-apk-8af78.firebaseapp.com",
            databaseURL: "https://video-apk-8af78-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "video-apk-8af78",
            storageBucket: "video-apk-8af78.appspot.com",
            messagingSenderId: "1234567890", // Replace with your actual Sender ID
            appId: "1:272112220572:android:d5f72b22ea35d714a47059" // Replace with your actual App ID
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const registerBtn = document.getElementById('register-btn');
        const loginBtn = document.getElementById('login-btn');
        const registerFormEl = document.getElementById('register-form');
        const loginFormEl = document.getElementById('login-form');    
        const resetFormEl = document.getElementById('reset-form');      
        const emailVerifyNotice = document.getElementById('email-verify-notice');
        const switchToLogin = document.getElementById('switch-to-login');
        const switchToRegister = document.getElementById('switch-to-register');
        const forgotPassword = document.getElementById('forgot-password');
        const switchToLoginFromReset = document.getElementById('switch-to-login-from-reset');
        const submitRegister = document.getElementById('submit-register');
        const submitLogin = document.getElementById('submit-login');
        const submitReset = document.getElementById('submit-reset');
        const verifyContinue = document.getElementById('verify-continue');
        const resendVerify = document.getElementById('resend-verify');
        const verifyEmailAddressEl = document.getElementById('verify-email-address');

        const termsLink = document.getElementById('terms-link');
        const termsModal = document.getElementById('terms-modal');
        const termsAccept = document.getElementById('terms-accept');
        const menuToggle = document.getElementById('menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        const menuItems = document.querySelectorAll('.menu-item');
        const pages = document.querySelectorAll('.page');
        const logoutBtn = document.getElementById('logout-btn');
        const notificationContainer = document.getElementById('notification-container');
        const confirmationModalEl = document.getElementById('confirmation-modal');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        const loadingOverlay = document.getElementById('loading-overlay');
        const refreshBalance = document.getElementById('refresh-balance');
        const quickDeposit = document.getElementById('quick-deposit');
        const quickWithdraw = document.getElementById('quick-withdraw');
        const quickInvite = document.getElementById('quick-invite');

        // Referral Program Elements
        const milestonesListEl = document.getElementById('milestones-list');
        const nextMilestoneInfoEl = document.getElementById('next-milestone-info');
        const milestoneProgressBarEl = document.getElementById('milestone-progress-bar');


        // User data
        let currentUser = null;
        let userData = null;
        let earningsInterval = null;
        let lastEarningsUpdate = null;
        let earningsChartInstance = null;
        let referralMilestonesConfig = []; // To be loaded from Firebase


        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
            loadReferralConfig(); // Load referral settings early
        }

        async function loadReferralConfig() {
            try {
                const snapshot = await database.ref('admin/referralSettings/milestones').once('value');
                if (snapshot.exists()) {
                    referralMilestonesConfig = snapshot.val();
                    // Sort milestones by required referrals to ensure correct progression
                    referralMilestonesConfig.sort((a, b) => a.requiredReferrals - b.requiredReferrals);
                } else {
                    // Default milestones if not set in Firebase
                    referralMilestonesConfig = [
                        { id: "milestone1", requiredReferrals: 3, rewardAmount: 50, name: "Bronze Referrer" },
                        { id: "milestone2", requiredReferrals: 7, rewardAmount: 150, name: "Silver Referrer" },
                        { id: "milestone3", requiredReferrals: 15, rewardAmount: 350, name: "Gold Referrer" }
                    ];
                    console.warn("Referral milestones not found in Firebase, using defaults.");
                }
            } catch (error) {
                console.error("Error loading referral config:", error);
                 referralMilestonesConfig = [ // Fallback defaults
                        { id: "milestone1", requiredReferrals: 3, rewardAmount: 50, name: "Bronze Referrer" },
                        { id: "milestone2", requiredReferrals: 7, rewardAmount: 150, name: "Silver Referrer" },
                        { id: "milestone3", requiredReferrals: 15, rewardAmount: 350, name: "Gold Referrer" }
                    ];
            }
        }


        // Set up event listeners (existing setupEventListeners function remains largely the same)
        function setupEventListeners() {
            registerBtn.addEventListener('click', () => showAuthForm(registerFormEl));
            loginBtn.addEventListener('click', () => showAuthForm(loginFormEl));
            switchToLogin.addEventListener('click', () => showAuthForm(loginFormEl));
            switchToRegister.addEventListener('click', () => showAuthForm(registerFormEl));
            forgotPassword.addEventListener('click', () => showAuthForm(resetFormEl));
            switchToLoginFromReset.addEventListener('click', () => showAuthForm(loginFormEl));
            
            submitRegister.addEventListener('click', registerUser);
            submitLogin.addEventListener('click', loginUser);
            submitReset.addEventListener('click', resetUserPassword);
            
            verifyContinue.addEventListener('click', () => {
                authContainer.classList.remove('hidden');
                emailVerifyNotice.classList.add('hidden');
                if (currentUser) {
                    currentUser.reload().then(() => {
                        if (currentUser.emailVerified) checkAuthState();
                        else showNotification('Email not yet verified. Please check your inbox.', 'warning');
                    });
                }
            });
            resendVerify.addEventListener('click', resendVerificationEmail);
            
            termsLink.addEventListener('click', (e) => {
                e.preventDefault();
                termsModal.classList.add('active');
                termsModal.classList.remove('hidden');
            });
            termsAccept.addEventListener('click', () => {
                termsModal.classList.remove('active');
                termsModal.classList.add('hidden');
            });
            
            document.addEventListener('click', (event) => {
                if (event.target === termsModal) {
                    termsModal.classList.remove('active');
                    termsModal.classList.add('hidden');
                }
                if (event.target === confirmationModalEl) {
                    confirmationModalEl.classList.remove('active');
                    confirmationModalEl.classList.add('hidden');
                }
                const screenshotModalEl = document.getElementById('screenshot-modal');
                if (event.target === screenshotModalEl) {
                    screenshotModalEl.classList.remove('active');
                    screenshotModalEl.classList.add('hidden');
                }
            });

            menuToggle.addEventListener('click', () => sideMenu.classList.toggle('active'));
            
            menuItems.forEach(item => {
                if (item.id !== 'logout-btn') {
                    item.addEventListener('click', () => navigateToPage(item.dataset.page));
                }
            });
            
            logoutBtn.addEventListener('click', logoutUser);
            
            modalCancel.addEventListener('click', () => {
                confirmationModalEl.classList.remove('active');
                confirmationModalEl.classList.add('hidden');
            });
            
            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const input = this.closest('.password-container').querySelector('input');
                    const icon = this.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.replace('fa-eye', 'fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.replace('fa-eye-slash', 'fa-eye');
                    }
                });
            });
            
            const passwordInput = document.getElementById('reg-password');
            if (passwordInput) passwordInput.addEventListener('input', checkPasswordStrength);
            
            const depositAmountSelect = document.getElementById('deposit-amount');
            if (depositAmountSelect) {
                depositAmountSelect.addEventListener('change', function() {
                    const customAmountContainer = document.getElementById('custom-amount-container');
                    if (this.value === 'other') customAmountContainer.classList.remove('hidden');
                    else customAmountContainer.classList.add('hidden');
                });
            }
            
            const fileUploadInput = document.getElementById('deposit-screenshot');
            if (fileUploadInput) {
                fileUploadInput.addEventListener('change', function() {
                    const fileNameSpan = document.getElementById('file-name');
                    const screenshotModal = document.getElementById('screenshot-modal');
                    const screenshotPreview = document.getElementById('screenshot-preview');

                    if (this.files.length > 0) {
                        fileNameSpan.textContent = this.files[0].name;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            screenshotPreview.innerHTML = `<img src="${e.target.result}" alt="Payment Screenshot">`;
                            screenshotModal.classList.add('active');
                            screenshotModal.classList.remove('hidden');
                        };
                        reader.readAsDataURL(this.files[0]);
                    } else {
                        fileNameSpan.textContent = 'No file chosen';
                        screenshotPreview.innerHTML = '<p>No image selected or preview not available.</p>';
                    }
                });
            }
            
            const screenshotCancelBtn = document.getElementById('screenshot-cancel');
            const screenshotConfirmBtn = document.getElementById('screenshot-confirm');
            const screenshotModalEl = document.getElementById('screenshot-modal');

            if (screenshotCancelBtn) {
                screenshotCancelBtn.addEventListener('click', () => {
                    screenshotModalEl.classList.remove('active');
                    screenshotModalEl.classList.add('hidden');
                    if(fileUploadInput) fileUploadInput.value = '';
                    const fileNameSpan = document.getElementById('file-name');
                    if(fileNameSpan) fileNameSpan.textContent = 'No file chosen';
                    document.getElementById('screenshot-preview').innerHTML = '<p>No image selected or preview not available.</p>';
                });
            }
            if (screenshotConfirmBtn) {
                screenshotConfirmBtn.addEventListener('click', () => {
                    screenshotModalEl.classList.remove('active');
                    screenshotModalEl.classList.add('hidden');
                });
            }

            if (quickDeposit) quickDeposit.addEventListener('click', () => navigateToPage('deposit'));
            if (quickWithdraw) quickWithdraw.addEventListener('click', () => navigateToPage('withdraw'));
            if (quickInvite) quickInvite.addEventListener('click', () => navigateToPage('team'));
            
            if (refreshBalance) refreshBalance.addEventListener('click', refreshUserBalance);
            
            initSlideshow();
            initPlanButtons();
            initTransactionButtons();
            initCopyButton();
            initRankingButton();
            initShareButtons();
            initAmountButtons();
            initContactForm();
            initHistoryFilters();
        }

        function showAuthForm(formToShow) {
            [registerFormEl, loginFormEl, resetFormEl, emailVerifyNotice].forEach(form => {
                if (form) form.classList.add('hidden');
            });
            if (formToShow) formToShow.classList.remove('hidden');
            const authOptions = document.getElementById('auth-options');
            if (formToShow !== emailVerifyNotice && formToShow !== null && authOptions) {
                 authOptions.classList.add('hidden');
            } else if (authOptions) {
                 authOptions.classList.remove('hidden');
            }
        }

        function navigateToPage(pageName) {
            pages.forEach(p => p.classList.add('hidden'));
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) targetPage.classList.remove('hidden');
            else {
                console.error(`Page with ID ${pageName}-page not found.`);
                document.getElementById('home-page').classList.remove('hidden');
            }

            menuItems.forEach(item => item.classList.remove('active'));
            const activeMenuItem = document.querySelector(`.menu-item[data-page="${pageName}"]`);
            if (activeMenuItem) activeMenuItem.classList.add('active');
            
            sideMenu.classList.remove('active');

            if (pageName === 'team') initTeamPage();
            else if (pageName === 'plans') initPlansPage();
            else if (pageName === 'deposit') initDepositPage();
            else if (pageName === 'withdraw') initWithdrawPage();
            else if (pageName === 'earnings') initEarningsPage();
            else if (pageName === 'deposit-history') loadDepositHistory();
            else if (pageName === 'withdraw-history') loadWithdrawHistory();
        }

        function checkAuthState() {
            showLoading();
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    if (!user.emailVerified) {
                        showEmailVerificationNotice(user.email);
                        hideLoading();
                        return;
                    }
                    loadUserData(user.uid);
                    authContainer.classList.add('hidden');
                    document.getElementById('auth-options').classList.add('hidden');
                    appContainer.classList.remove('hidden');
                } else {
                    currentUser = null;
                    userData = null;
                    authContainer.classList.remove('hidden');
                    document.getElementById('auth-options').classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    showAuthForm(loginFormEl); 
                    if (earningsInterval) clearInterval(earningsInterval);
                    earningsInterval = null;
                    hideLoading();
                }
            });
        }

        function showEmailVerificationNotice(email) {
            [registerFormEl, loginFormEl, resetFormEl].forEach(form => form.classList.add('hidden'));
            document.getElementById('auth-options').classList.add('hidden');
            authContainer.classList.remove('hidden'); 

            emailVerifyNotice.classList.remove('hidden');
            if (verifyEmailAddressEl) verifyEmailAddressEl.textContent = email;
            
            setTimeout(() => {
                if (verifyContinue) verifyContinue.classList.remove('hidden');
            }, 5000);
        }

        function resendVerificationEmail() {
            if (!currentUser) return;
            showLoadingButton(resendVerify, true);
            currentUser.sendEmailVerification()
                .then(() => showNotification('Verification email sent! Check your inbox and spam folder.', 'success'))
                .catch(error => showNotification(`Error sending email: ${error.message}`, 'error'))
                .finally(() => showLoadingButton(resendVerify, false, "Resend Email"));
        }

        function loadUserData(userId) {
            showLoading();
            database.ref('users/' + userId).on('value', snapshot => {
                userData = snapshot.val();
                if (userData) {
                    updateUI();
                    startEarningsCalculation();
                    updateReferralMilestonesUI(); // Update referral UI after data load
                    if (!authContainer.classList.contains('hidden')) {
                         showNotification('Login successful!', 'success');
                    }
                } else {
                    console.warn("User data not found for UID:", userId);
                }
                hideLoading();
            }, error => {
                showNotification('Error loading user data: ' + error.message, 'error');
                logoutUser();
                hideLoading();
            });
        }

        function refreshUserBalance() {
            if (!currentUser) return;
            showLoading();
            database.ref('users/' + currentUser.uid).once('value')
                .then(snapshot => {
                    userData = snapshot.val();
                    if (userData) {
                        updateUI();
                        updateReferralMilestonesUI();
                        showNotification('Balance refreshed!', 'success');
                    }
                })
                .catch(error => showNotification('Error refreshing balance: ' + error.message, 'error'))
                .finally(() => hideLoading());
        }

        function updateUI() {
            if (!currentUser || !userData) return;
            
            document.getElementById('menu-username').textContent = userData.name || 'User';
            document.getElementById('menu-user-email').textContent = currentUser.email;
            document.getElementById('menu-user-img').src = userData.profileImage || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            
            updateBalanceDisplay();
            
            const activePlanName = userData.activePlan ? `${getPlanName(userData.activePlan)} (${userData.activePlan} Rs)` : 'None';
            document.getElementById('active-plan').textContent = activePlanName;
            
            const dailyEarningsVal = userData.activePlan ? (userData.activePlan * 0.05) : 0;
            document.getElementById('daily-earnings').textContent = `${dailyEarningsVal.toFixed(2)} Rs`;
            
            document.getElementById('invite-code').value = userData.inviteCode || currentUser.uid.slice(0, 8).toUpperCase();
            
            const referralsCount = userData.investingReferralsCount || 0; // Use new count for investing referrals
            const referralEarningsTotal = userData.referralCommissionTotal || 0;
            document.getElementById('total-referrals').textContent = referralsCount;
            document.getElementById('referral-earnings').textContent = `${referralEarningsTotal.toFixed(2)} Rs`;
             document.getElementById('referral-user-level-display').textContent = userData.referralLevel || "Starter";


            const today = new Date().toISOString().split('T')[0];
            let todayReferralCommission = 0;
            if (userData.referralHistory) {
                Object.values(userData.referralHistory).forEach(entry => {
                    if (entry.type === 'commission' && entry.date && entry.date.startsWith(today)) {
                        todayReferralCommission += entry.amount || 0;
                    }
                });
            }
            document.getElementById('today-referral-earnings').textContent = `${todayReferralCommission.toFixed(2)} Rs`;
            
            // User rank
            document.getElementById('user-rank-badge').innerHTML = `<span>#${userData.rank || 'N/A'}</span> <i class="fas fa-trophy"></i>`;

            let level = "Standard";
            if (userData.activePlan >= 8400) level = "Diamond Investor";
            else if (userData.activePlan >= 5600) level = "Platinum Investor";
            else if (userData.activePlan >= 2800) level = "Gold Investor";
            else if (userData.activePlan >= 1400) level = "Silver Investor";
            else if (userData.activePlan >= 550) level = "Basic Investor";
            document.getElementById('user-level-badge').textContent = level;
        }

        function getPlanName(amount) {
            if (amount === 550) return "Basic Plan";
            if (amount === 1400) return "Silver Plan";
            if (amount === 2800) return "Gold Plan";
            if (amount === 5600) return "Platinum Plan";
            if (amount === 8400) return "Diamond Plan";
            return "Custom Plan";
        }

        function updateBalanceDisplay() {
            if (!userData) return;
            const currentBalance = userData.balance || 0;
            const currentEarnings = userData.earnings || 0; // This now includes plan earnings, referral commissions, and milestone rewards
            const totalAvailable = currentBalance + currentEarnings;

            document.getElementById('user-balance').textContent = `${totalAvailable.toFixed(2)} Rs`;
            document.getElementById('total-balance').textContent = `${totalAvailable.toFixed(2)} Rs`;
            const withdrawAvailEl = document.getElementById('withdraw-available-balance');
            if (withdrawAvailEl) withdrawAvailEl.textContent = `${totalAvailable.toFixed(2)} Rs`;
        }

        function registerUser() {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            const phone = document.getElementById('reg-phone').value.trim();
            const referredByInviteCode = document.getElementById('reg-invite').value.trim();
            const termsAccepted = document.getElementById('reg-terms').checked;
            
            if (!name || !email || !password || !confirmPassword || !phone) {
                showNotification('Please fill all required fields.', 'error'); return;
            }
            if (!validateEmail(email)) {
                showNotification('Invalid email address.', 'error'); return;
            }
            if (password !== confirmPassword) {
                showNotification('Passwords do not match.', 'error'); return;
            }
            if (password.length < 8 || !validatePassword(password)) {
                showNotification('Password must be at least 8 characters and include uppercase, lowercase, number, and special character.', 'error'); return;
            }
            const phoneRegex = /^03\d{9}$/;
            if (!phoneRegex.test(phone)) {
                showNotification('Invalid phone number. Must be 11 digits starting with 03.', 'error'); return;
            }
            if (!termsAccepted) {
                showNotification('Please accept the Terms & Conditions.', 'error'); return;
            }
            
            showLoadingButton(submitRegister, true);
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => userCredential.user.sendEmailVerification().then(() => userCredential.user))
                .then(user => {
                    const newUserData = {
                        name: name, email: email, phone: phone,
                        balance: 0, earnings: 0,
                        activePlan: null, planStartDate: null, lastEarningsUpdate: null,
                        hasPurchasedFirstPlan: false, // New flag for referral commission
                        inviteCode: generateInviteCode(),
                        referredByInviteCode: referredByInviteCode || null, // Store referrer's invite code
                        referredByUid: null, // To be filled by linkReferrer
                        registrationDate: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        rank: "New",
                        // Referral program specific fields
                        investingReferralsCount: 0, // Count of referrals who invested
                        referralCommissionTotal: 0, // Sum of all commissions
                        referralLevel: "Starter",
                        achievedMilestones: {} // e.g., { milestone1_rewarded: true }
                    };
                    
                    return database.ref('users/' + user.uid).set(newUserData)
                        .then(() => {
                            if (referredByInviteCode) {
                                linkReferrer(user.uid, referredByInviteCode, name); // Pass new user's name
                            }
                            showEmailVerificationNotice(email);
                            showNotification('Registration successful! Please verify your email to login.', 'success');
                        });
                })
                .catch(error => showNotification(error.message, 'error'))
                .finally(() => showLoadingButton(submitRegister, false, "Register"));
        }

        async function linkReferrer(newUserId, referrerInviteCode, newUserName) {
            if (!referrerInviteCode) return;
            try {
                const snapshot = await database.ref('users').orderByChild('inviteCode').equalTo(referrerInviteCode).once('value');
                if (snapshot.exists()) {
                    const referrerUid = Object.keys(snapshot.val())[0];
                    // Update the new user's record with the referrer's UID
                    await database.ref(`users/${newUserId}/referredByUid`).set(referrerUid);
                    // Add this new user to the referrer's list of general referrals (not yet investing)
                    // This could be a simple list or more detailed. For now, just linking by UID.
                    // Note: The main tracking of "investingReferralsCount" happens when commission is paid.
                    await database.ref(`users/${referrerUid}/referralsList/${newUserId}`).set({
                        name: newUserName,
                        date: new Date().toISOString(),
                        status: "registered" 
                    });
                    console.log(`User ${newUserId} linked to referrer ${referrerUid}`);
                } else {
                    console.warn("Referrer with invite code not found:", referrerInviteCode);
                    // Optionally, clear the referredByInviteCode from the new user if invalid
                    await database.ref(`users/${newUserId}/referredByInviteCode`).set(null);
                }
            } catch (error) {
                console.error("Error linking referrer:", error);
            }
        }


        function generateInviteCode() {
            return 'VT' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase());
        }
        function validatePassword(password) {
            return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(password);
        }

        function checkPasswordStrength() {
            const password = document.getElementById('reg-password').value;
            const strengthBars = document.querySelectorAll('#register-form .strength-bar');
            const strengthText = document.querySelector('#register-form .strength-text');
            
            let score = 0;
            if (!password) {
                strengthBars.forEach(bar => bar.style.backgroundColor = 'var(--border-color)');
                strengthText.textContent = '';
                return;
            }

            if (password.length >= 8) score++;
            if (password.length >= 10) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;

            strengthBars.forEach((bar, index) => {
                bar.className = 'strength-bar'; 
                if (score === 0) bar.style.backgroundColor = 'var(--border-color)';
                else if (score <= 2 && index === 0) bar.classList.add('weak');
                else if (score > 2 && score <= 4) {
                    if (index <=1) bar.classList.add('medium');
                    else bar.style.backgroundColor = 'var(--border-color)';
                } else if (score >= 5) bar.classList.add('strong');
                else bar.style.backgroundColor = 'var(--border-color)';
            });
            
            if (score <= 2) { strengthText.textContent = 'Weak'; strengthText.style.color = 'var(--danger-color)'; }
            else if (score <= 4) { strengthText.textContent = 'Medium'; strengthText.style.color = 'var(--warning-color)'; }
            else { strengthText.textContent = 'Strong'; strengthText.style.color = 'var(--success-color)'; }
        }
        
        function loginUser() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            if (!email || !password) { showNotification('Please fill all fields.', 'error'); return; }
            showLoadingButton(submitLogin, true);
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => database.ref('users/' + userCredential.user.uid).update({ lastLogin: new Date().toISOString() }))
                .catch(error => showNotification(error.message, 'error'))
                .finally(() => showLoadingButton(submitLogin, false, "Login"));
        }

        function resetUserPassword() {
            const email = document.getElementById('reset-email').value.trim();
            if (!email || !validateEmail(email)) { showNotification('Please enter a valid email.', 'error'); return; }
            showLoadingButton(submitReset, true);
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showNotification('Password reset email sent! Check your inbox.', 'success');
                    showAuthForm(loginFormEl);
                })
                .catch(error => showNotification(error.message, 'error'))
                .finally(() => showLoadingButton(submitReset, false, "Send Reset Link"));
        }

        function logoutUser() {
            showLoading();
            auth.signOut().catch(error => showNotification(error.message, 'error'));
            // checkAuthState will handle UI update
        }

        function showLoadingButton(buttonElement, isLoading, defaultText = "Submit") {
            const btnText = buttonElement.querySelector('.btn-text');
            const btnLoader = buttonElement.querySelector('.btn-loader');
            if (isLoading) {
                if(btnText) btnText.classList.add('hidden');
                if(btnLoader) btnLoader.classList.remove('hidden');
                buttonElement.disabled = true;
            } else {
                if(btnText) { btnText.classList.remove('hidden'); btnText.textContent = defaultText; }
                if(btnLoader) btnLoader.classList.add('hidden');
                buttonElement.disabled = false;
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type} animate__animated`;
            let iconClass;
            switch (type) {
                case 'success': iconClass = 'fa-check-circle'; break;
                case 'error': iconClass = 'fa-times-circle'; break;
                case 'warning': iconClass = 'fa-exclamation-triangle'; break;
                case 'info': iconClass = 'fa-info-circle'; break;
                default: iconClass = 'fa-bell';
            }
            notification.innerHTML = `<i class="fas ${iconClass}"></i><span>${message}</span>`;
            notificationContainer.appendChild(notification);
            notification.classList.add('animate__fadeInRight');
            setTimeout(() => {
                notification.classList.remove('animate__fadeInRight');
                notification.classList.add('animate__fadeOutUp');
                setTimeout(() => notification.remove(), 500);
            }, 3500);
        }

        function showLoading() { if (loadingOverlay) loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { if (loadingOverlay) loadingOverlay.classList.add('hidden'); }

        let slideIndex = 1;
        let slideshowTimeout;
        function initSlideshow() { showSlides(slideIndex); }
        function plusSlides(n) { clearTimeout(slideshowTimeout); showSlides(slideIndex += n); }
        function currentSlide(n) { clearTimeout(slideshowTimeout); showSlides(slideIndex = n); }
        function showSlides(n) {
            const slides = document.getElementsByClassName("slide");
            const dots = document.getElementsByClassName("dot");
            if (n > slides.length) slideIndex = 1;
            if (n < 1) slideIndex = slides.length;
            for (let i = 0; i < slides.length; i++) slides[i].style.display = "none";
            for (let i = 0; i < dots.length; i++) dots[i].className = dots[i].className.replace(" active-dot", "");
            if (slides.length > 0 && dots.length > 0) {
                slides[slideIndex-1].style.display = "block";
                dots[slideIndex-1].className += " active-dot";
            }
            slideshowTimeout = setTimeout(() => plusSlides(1), 5000);
        }

        function initPlanButtons() {
            document.querySelectorAll('.buy-plan-btn').forEach(button => {
                button.addEventListener('click', function() {
                    purchasePlan(parseInt(this.dataset.plan), this);
                });
            });
        }
        
        function initPlansPage() {
            if (userData && userData.activePlan) {
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.querySelector('.btn-text').textContent = "Plan Active";
                });
            } else {
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.querySelector('.btn-text').textContent = "Buy Now";
                });
            }
        }

        async function purchasePlan(planAmount, buttonElement) {
            if (!currentUser || !userData) {
                showNotification('Please login to purchase a plan.', 'error'); return;
            }
            const totalBalance = (userData.balance || 0) + (userData.earnings || 0);
            if (totalBalance < planAmount) {
                showNotification('Insufficient balance. Please deposit funds.', 'error'); return;
            }
            if (userData.activePlan) {
                showNotification('You already have an active plan.', 'error'); return;
            }
            
            showConfirmationModal(
                `Confirm Plan Purchase`,
                `Purchase ${getPlanName(planAmount)} for ${planAmount} Rs? You'll earn 5% daily for 30 days.`,
                async () => {
                    showLoadingButton(buttonElement, true);
                    let newEarnings = userData.earnings || 0;
                    let newBalance = userData.balance || 0;
                    let amountFromEarnings = 0, amountFromBalance = 0;

                    if (newEarnings >= planAmount) {
                        amountFromEarnings = planAmount; newEarnings -= planAmount;
                    } else {
                        amountFromEarnings = newEarnings;
                        const remaining = planAmount - newEarnings;
                        newEarnings = 0; amountFromBalance = remaining; newBalance -= remaining;
                    }
                    
                    const updates = {
                        balance: newBalance, earnings: newEarnings,
                        activePlan: planAmount, planStartDate: new Date().toISOString(),
                        lastEarningsUpdate: new Date().toISOString(),
                        hasPurchasedFirstPlan: true // Mark first plan purchased
                    };
                    
                    try {
                        await database.ref('users/' + currentUser.uid).update(updates);
                        const logEntry = {
                            type: 'plan_purchase', amount: planAmount, planName: getPlanName(planAmount),
                            date: new Date().toISOString(), deductedFromBalance: amountFromBalance,
                            deductedFromEarnings: amountFromEarnings
                        };
                        await database.ref(`users/${currentUser.uid}/transactions`).push(logEntry);

                        // Handle referral commission if this is the first plan
                        if (userData.referredByUid && !userData.hasPurchasedFirstPlan) {
                            await awardReferralCommission(userData.referredByUid, planAmount, currentUser.uid, userData.name);
                        }

                        showNotification(`${getPlanName(planAmount)} purchased! Daily earnings: ${(planAmount * 0.05).toFixed(2)} Rs.`, 'success');
                        if (document.getElementById('plans-page') && !document.getElementById('plans-page').classList.contains('hidden')) {
                            initPlansPage();
                        }
                        startEarningsCalculation();
                    } catch (error) {
                        showNotification(`Purchase error: ${error.message}`, 'error');
                    } finally {
                        showLoadingButton(buttonElement, false, "Buy Now");
                    }
                }, 'success'
            );
        }

        async function awardReferralCommission(referrerUid, planAmount, referredUserId, referredUserName) {
            const commissionRateSnapshot = await database.ref('admin/referralSettings/commissionRate').once('value');
            const commissionRate = commissionRateSnapshot.exists() ? commissionRateSnapshot.val() : 0.10; // Default 10%
            const commissionAmount = planAmount * commissionRate;

            const referrerRef = database.ref(`users/${referrerUid}`);
            const referrerSnapshot = await referrerRef.once('value');
            if (!referrerSnapshot.exists()) {
                console.error("Referrer not found:", referrerUid);
                return;
            }
            const referrerData = referrerSnapshot.val();

            const updates = {
                earnings: (referrerData.earnings || 0) + commissionAmount,
                referralCommissionTotal: (referrerData.referralCommissionTotal || 0) + commissionAmount,
                investingReferralsCount: (referrerData.investingReferralsCount || 0) + 1
            };

            await referrerRef.update(updates);
            
            // Log commission for referrer
            await database.ref(`users/${referrerUid}/referralHistory`).push({
                type: 'commission',
                amount: commissionAmount,
                referredUserId: referredUserId,
                referredUserName: referredUserName,
                planPurchased: planAmount,
                date: new Date().toISOString(),
                status: 'credited'
            });

            // Check for milestone rewards for the referrer
            await checkAndApplyReferralMilestones(referrerUid);
            showNotification(`Referral commission of ${commissionAmount.toFixed(2)} Rs credited to your referrer!`, 'info', referrerUid); // Notify referrer (if possible through other means)
             console.log(`Commission of ${commissionAmount} awarded to referrer ${referrerUid} for referral ${referredUserId}`);
        }

        async function checkAndApplyReferralMilestones(referrerUid) {
            const referrerRef = database.ref(`users/${referrerUid}`);
            const snapshot = await referrerRef.once('value');
            if (!snapshot.exists()) return;
            
            const referrerData = snapshot.val();
            const currentInvestingReferrals = referrerData.investingReferralsCount || 0;
            let newLevel = referrerData.referralLevel || "Starter";
            let milestoneRewardApplied = false;

            for (const milestone of referralMilestonesConfig) { // Assumes referralMilestonesConfig is sorted
                if (currentInvestingReferrals >= milestone.requiredReferrals && 
                    !(referrerData.achievedMilestones && referrerData.achievedMilestones[milestone.id + '_rewarded'])) {
                    
                    // Award milestone
                    const updates = {
                        earnings: (referrerData.earnings || 0) + milestone.rewardAmount,
                        referralLevel: milestone.name,
                        [`achievedMilestones/${milestone.id}_rewarded`]: true
                    };
                    await referrerRef.update(updates);
                    newLevel = milestone.name; // Update level for subsequent checks within this loop if any
                    
                    // Log milestone reward
                     await database.ref(`users/${referrerUid}/referralHistory`).push({
                        type: 'milestone_reward',
                        amount: milestone.rewardAmount,
                        milestoneName: milestone.name,
                        date: new Date().toISOString(),
                        status: 'credited'
                    });
                    // Notify user (this will be seen on their next data load/refresh)
                    showNotification(`Congratulations! You've reached ${milestone.name} & earned ${milestone.rewardAmount} Rs!`, 'success', referrerUid); // Tag for potential specific user notification
                    milestoneRewardApplied = true;
                }
            }
             if (milestoneRewardApplied) { // If any milestone was applied, force a refresh of their UI if they are current user
                if (currentUser && currentUser.uid === referrerUid) {
                    refreshUserBalance(); // This will re-fetch data and update UI including milestones
                }
            }
        }


        function startEarningsCalculation() {
            if (earningsInterval) clearInterval(earningsInterval);

            if (!currentUser || !userData || !userData.activePlan || !userData.planStartDate) return;
            
            const planStartDate = new Date(userData.planStartDate);
            const planEndDate = new Date(planStartDate);
            planEndDate.setDate(planEndDate.getDate() + 30); 
            
            const now = new Date();

            if (now > planEndDate) {
                const principal = userData.activePlan;
                const updates = {
                    balance: (userData.balance || 0) + principal,
                    activePlan: null, planStartDate: null, lastEarningsUpdate: null,
                    planCompletedOn: now.toISOString()
                };
                database.ref('users/' + currentUser.uid).update(updates)
                    .then(() => {
                        database.ref(`users/${currentUser.uid}/transactions`).push({
                            type: 'plan_completion', amount: principal,
                            description: `Principal for ${getPlanName(principal)} returned.`,
                            date: now.toISOString()
                        });
                        showNotification(`Your ${getPlanName(principal)} plan has completed! ${principal} Rs principal returned to balance.`, 'success');
                    });
                return;
            }
            
            const lastUpdate = userData.lastEarningsUpdate ? new Date(userData.lastEarningsUpdate) : planStartDate;
            const hoursPassedSinceLastUpdate = (now - lastUpdate) / (1000 * 60 * 60);
            
            if (hoursPassedSinceLastUpdate >= 1) {
                const planAmount = userData.activePlan;
                const hourlyEarnings = (planAmount * 0.05) / 24;
                const missedEarnings = hourlyEarnings * Math.floor(hoursPassedSinceLastUpdate);
                
                if (missedEarnings > 0) {
                    const earningsUpdate = {
                        earnings: (userData.earnings || 0) + missedEarnings,
                        lastEarningsUpdate: now.toISOString()
                    };
                    database.ref(`users/${currentUser.uid}/earningsHistory`).push({
                        type: 'investment_earning', amount: missedEarnings, plan: planAmount,
                        date: now.toISOString(), description: `Hourly earnings catch-up`
                    });
                    database.ref('users/' + currentUser.uid).update(earningsUpdate);
                }
            }
            
            earningsInterval = setInterval(() => {
                if (!currentUser || !userData || !userData.activePlan) {
                    clearInterval(earningsInterval); return;
                }
                const currentActivePlan = userData.activePlan;
                const currentPlanStartDate = new Date(userData.planStartDate);
                const currentPlanEndDate = new Date(currentPlanStartDate);
                currentPlanEndDate.setDate(currentPlanEndDate.getDate() + 30);

                if (new Date() > currentPlanEndDate) {
                    clearInterval(earningsInterval);
                    startEarningsCalculation(); return;
                }

                const hourlyRate = (currentActivePlan * 0.05) / 24;
                const updateData = {
                    earnings: (userData.earnings || 0) + hourlyRate,
                    lastEarningsUpdate: new Date().toISOString()
                };
                database.ref(`users/${currentUser.uid}/earningsHistory`).push({
                    type: 'investment_earning', amount: hourlyRate, plan: currentActivePlan,
                    date: new Date().toISOString(), description: `Regular hourly earning`
                });
                database.ref('users/' + currentUser.uid).update(updateData)
                    .catch(err => console.error("Error updating hourly earnings:", err));
            }, 3600000);
        }

        function initTransactionButtons() {
            const depositButton = document.getElementById('submit-deposit');
            if (depositButton) depositButton.addEventListener('click', submitDepositRequest);
            const withdrawButton = document.getElementById('submit-withdraw');
            if (withdrawButton) withdrawButton.addEventListener('click', submitWithdrawalRequest);
        }

        function initDepositPage() {
            const methodCards = document.querySelectorAll('#deposit-page .method-card');
            methodCards.forEach(card => {
                card.addEventListener('click', function() {
                    methodCards.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    if (this.dataset.method === 'easypaisa') {
                        document.getElementById('deposit-account-number').textContent = '03130552446';
                        document.getElementById('deposit-account-name').textContent = 'NIDA ZAHRA';
                    } 
                });
            });
            const easypaisaCard = document.querySelector('#deposit-page .method-card[data-method="easypaisa"]');
            if (easypaisaCard) easypaisaCard.click();
        }

        function submitDepositRequest() {
            const amountSelect = document.getElementById('deposit-amount');
            let amount = amountSelect.value === 'other' ? 
                parseFloat(document.getElementById('custom-amount').value) : 
                parseFloat(amountSelect.value);
            
            const transactionId = document.getElementById('deposit-transaction').value.trim();
            const senderNumber = document.getElementById('deposit-sender').value.trim();
            const method = document.querySelector('#deposit-page .method-card.active')?.dataset.method;
            
            if (!amount || isNaN(amount) || amount < 550) {
                showNotification('Invalid amount. Minimum deposit is 550 Rs.', 'error'); return;
            }
            if (!transactionId || !senderNumber || !method) {
                showNotification('Please fill all required fields.', 'error'); return;
            }
            if (!/^03\d{9}$/.test(senderNumber)) {
                showNotification('Sender mobile number must be 11 digits starting with 03.', 'error'); return;
            }
            
            const submitDepositBtn = document.getElementById('submit-deposit');
            showLoadingButton(submitDepositBtn, true);
            
            const depositData = {
                userId: currentUser.uid, userName: userData.name, amount: amount, method: method,
                transactionId: transactionId, senderNumber: senderNumber,
                date: new Date().toISOString(), status: 'pending', screenshotUrl: null
            };
            
            const depositKey = database.ref(`users/${currentUser.uid}/deposits`).push().key;
            database.ref(`users/${currentUser.uid}/deposits/${depositKey}`).set({...depositData, id: depositKey})
            .then(() => {
                database.ref(`admin/pending_deposits/${depositKey}`).set({...depositData, userUid: currentUser.uid, depositId: depositKey });
                showNotification('Deposit request submitted! Processing takes 5-15 mins.', 'success');
                document.getElementById('deposit-form').reset();
                document.getElementById('custom-amount-container').classList.add('hidden');
                document.getElementById('file-name').textContent = 'No file chosen';
                document.getElementById('screenshot-preview').innerHTML = '<p>No image selected.</p>';
            })
            .catch(error => showNotification(`Deposit error: ${error.message}`, 'error'))
            .finally(() => showLoadingButton(submitDepositBtn, false, "Submit Deposit"));
        }

        function initWithdrawPage() { if (userData) updateBalanceDisplay(); }
        function initAmountButtons() {
            const withdrawAmountInput = document.getElementById('withdraw-amount');
            document.querySelectorAll('#withdraw-page .amount-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    if(withdrawAmountInput) withdrawAmountInput.value = this.dataset.amount;
                });
            });
        }

        function submitWithdrawalRequest() {
            const method = document.getElementById('withdraw-method').value;
            const account = document.getElementById('withdraw-account').value.trim();
            const name = document.getElementById('withdraw-name').value.trim();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            
            if (!method || !account || !name || !amount || isNaN(amount)) {
                showNotification('Please fill all fields correctly.', 'error'); return;
            }
            if (!/^\d{11}$/.test(account)) {
                showNotification('Account number must be 11 digits.', 'error'); return;
            }
            if (amount < 200 || amount > 20000) {
                showNotification('Withdrawal amount must be between 200 and 20,000 Rs.', 'error'); return;
            }
            
            const totalAvailableBalance = (userData.balance || 0) + (userData.earnings || 0);
            if (amount > totalAvailableBalance) {
                showNotification('Insufficient balance.', 'error'); return;
            }
            
            const feeAmount = amount * 0.05;
            const netAmountToReceive = amount - feeAmount;

            const withdrawalData = {
                userId: currentUser.uid, userName: userData.name, method: method, account: account, name: name,
                requestedAmount: amount, fee: feeAmount, netAmount: netAmountToReceive,
                date: new Date().toISOString(), status: 'pending'
            };
            
            showConfirmationModal(
                'Confirm Withdrawal',
                `Withdraw ${amount.toFixed(2)} Rs to ${account} (${method})? Fee: ${feeAmount.toFixed(2)} Rs. You receive: ${netAmountToReceive.toFixed(2)} Rs.`,
                () => {
                    const submitWithdrawBtn = document.getElementById('submit-withdraw');
                    showLoadingButton(submitWithdrawBtn, true);
                    let newEarnings = userData.earnings || 0;
                    let newBalance = userData.balance || 0;
                    if (newEarnings >= amount) newEarnings -= amount;
                    else { const rem = amount - newEarnings; newEarnings = 0; newBalance -= rem; }
                    
                    database.ref('users/' + currentUser.uid).update({ earnings: newEarnings, balance: newBalance })
                    .then(() => {
                        const key = database.ref(`users/${currentUser.uid}/withdrawals`).push().key;
                        return database.ref(`users/${currentUser.uid}/withdrawals/${key}`).set({...withdrawalData, id: key})
                            .then(() => database.ref(`admin/pending_withdrawals/${key}`).set({...withdrawalData, userUid: currentUser.uid, withdrawalId: key}));
                    })
                    .then(() => {
                        showNotification('Withdrawal request submitted!', 'success');
                        document.getElementById('withdraw-form').reset();
                    })
                    .catch(error => showNotification(`Withdrawal error: ${error.message}`, 'error'))
                    .finally(() => showLoadingButton(submitWithdrawBtn, false, "Request Withdrawal"));
                }, 'warning'
            );
        }

        function initCopyButton() {
            const copyButton = document.getElementById('copy-invite');
            const inviteCodeInput = document.getElementById('invite-code');
            if (copyButton && inviteCodeInput) {
                copyButton.addEventListener('click', () => {
                    inviteCodeInput.select();
                    inviteCodeInput.setSelectionRange(0, 99999);
                    try {
                        document.execCommand('copy');
                        showNotification('Invite code copied!', 'success');
                    } catch (err) { showNotification('Failed to copy code.', 'error'); }
                });
            }
        }
        function initShareButtons() {
            const inviteCodeEl = document.getElementById('invite-code');
            const baseAppUrl = window.location.origin + window.location.pathname; 

            document.querySelector('.share-btn.whatsapp')?.addEventListener('click', () => {
                const code = inviteCodeEl ? inviteCodeEl.value : (currentUser?.uid.slice(0,8).toUpperCase() || "DEMOCODE");
                const msg = `Join Video Treasure Pro with my invite code: ${code} and earn daily! Sign up: ${baseAppUrl}?ref=${code}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            });
            document.querySelector('.share-btn.facebook')?.addEventListener('click', () => {
                const code = inviteCodeEl ? inviteCodeEl.value : (currentUser?.uid.slice(0,8).toUpperCase() || "DEMOCODE");
                const link = `${baseAppUrl}?ref=${code}`;
                const msg = `Join Video Treasure Pro with code: ${code}!`;
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}&quote=${encodeURIComponent(msg)}`, '_blank');
            });
            document.querySelector('.share-btn.copy-link')?.addEventListener('click', () => {
                const code = inviteCodeEl ? inviteCodeEl.value : (currentUser?.uid.slice(0,8).toUpperCase() || "DEMOCODE");
                navigator.clipboard.writeText(`${baseAppUrl}?ref=${code}`)
                    .then(() => showNotification('Referral link copied!', 'success'))
                    .catch(() => showNotification('Failed to copy link.', 'error'));
            });
        }
        function initRankingButton() {
            const btn = document.getElementById('view-ranking-btn');
            const tableDiv = document.getElementById('ranking-table-container');
            if (btn && tableDiv) {
                btn.addEventListener('click', () => {
                    const isHidden = tableDiv.classList.contains('hidden');
                    if (isHidden) { loadUserRankings(); tableDiv.classList.remove('hidden'); btn.innerHTML = `<i class="fas fa-eye-slash"></i> Hide Ranking`; }
                    else { tableDiv.classList.add('hidden'); btn.innerHTML = `<i class="fas fa-list-ol"></i> View Full Ranking`; }
                });
            }
        }

        function initTeamPage() {
            loadReferralHistory();
            updateReferralMilestonesUI(); // Call this to display milestones
        }

        function updateReferralMilestonesUI() {
            if (!milestonesListEl || !nextMilestoneInfoEl || !milestoneProgressBarEl || !userData) return;

            milestonesListEl.innerHTML = '';
            const currentReferrals = userData.investingReferralsCount || 0;
            let nextMilestone = null;
            let achievedAll = true;

            referralMilestonesConfig.forEach(milestone => {
                const li = document.createElement('li');
                const achieved = userData.achievedMilestones && userData.achievedMilestones[milestone.id + '_rewarded'];
                
                li.innerHTML = `${milestone.name} (${milestone.requiredReferrals} Referrals): `;
                if (achieved) {
                    li.innerHTML += `<span class="status-completed">Achieved! +${milestone.rewardAmount} Rs</span>`;
                } else {
                    achievedAll = false;
                    const needed = milestone.requiredReferrals - currentReferrals;
                    li.innerHTML += `<span class="status-pending">${needed > 0 ? `${needed} more needed` : 'Ready to claim (auto)'}</span>`;
                    if (!nextMilestone) nextMilestone = milestone;
                }
                milestonesListEl.appendChild(li);
            });

            if (achievedAll) {
                nextMilestoneInfoEl.textContent = "Congratulations! You've achieved all referral milestones!";
                milestoneProgressBarEl.style.width = '100%';
                milestoneProgressBarEl.textContent = '100%';
            } else if (nextMilestone) {
                const prevMilestoneReferrals = referralMilestonesConfig
                    .filter(m => m.requiredReferrals < nextMilestone.requiredReferrals)
                    .pop()?.requiredReferrals || 0;
                
                const progressRange = nextMilestone.requiredReferrals - prevMilestoneReferrals;
                const progressInCurrentTier = currentReferrals - prevMilestoneReferrals;
                const percentage = progressRange > 0 ? Math.min(100, Math.max(0, (progressInCurrentTier / progressRange) * 100)) : (currentReferrals >= nextMilestone.requiredReferrals ? 100: 0);

                nextMilestoneInfoEl.textContent = `Next: ${nextMilestone.name} (${nextMilestone.requiredReferrals} Referrals for ${nextMilestone.rewardAmount} Rs reward)`;
                milestoneProgressBarEl.style.width = `${percentage.toFixed(0)}%`;
                milestoneProgressBarEl.textContent = `${percentage.toFixed(0)}%`;
            } else {
                 nextMilestoneInfoEl.textContent = "Start referring to unlock milestones!";
                 milestoneProgressBarEl.style.width = '0%';
                 milestoneProgressBarEl.textContent = '0%';
            }
        }


        function loadUserRankings() {
            showLoading();
            database.ref('users').orderByChild('activePlan').limitToLast(20).once('value')
                .then(snapshot => {
                    const rankings = [];
                    snapshot.forEach(userSnapshot => {
                        const user = userSnapshot.val();
                        if (user.name && user.activePlan && user.activePlan > 0) { 
                            rankings.push({
                                id: userSnapshot.key, name: user.name,
                                investment: user.activePlan,
                                earnings: (user.earnings || 0) + (user.referralCommissionTotal || 0)
                            });
                        }
                    });
                    rankings.sort((a, b) => b.investment - a.investment || b.earnings - a.earnings);
                    const rankingBody = document.getElementById('ranking-body');
                    if (!rankingBody) { hideLoading(); return; }
                    rankingBody.innerHTML = '';
                    if (rankings.length === 0) {
                        rankingBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No active investors.</td></tr>';
                    } else {
                        rankings.slice(0, 10).forEach((user, index) => {
                            const row = document.createElement('tr');
                            if (currentUser && user.id === currentUser.uid) row.classList.add('current-user');
                            row.innerHTML = `
                                <td>${index + 1}</td> <td>${user.name}</td>
                                <td>${user.investment.toFixed(0)} Rs</td> <td>${user.earnings.toFixed(2)} Rs</td>
                            `;
                            rankingBody.appendChild(row);
                        });
                    }
                })
                .catch(error => showNotification('Error loading rankings: ' + error.message, 'error'))
                .finally(() => hideLoading());
        }

        function loadDepositHistory() {
            const body = document.getElementById('deposit-history-body');
            if (!body) return;
            if (!currentUser || !userData || !userData.deposits) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No deposit history.</td></tr>';
                updateDepositSummary(0,0,0); return;
            }
            const filter = document.getElementById('deposit-filter')?.value || 'all';
            const arr = Object.values(userData.deposits);
            body.innerHTML = '';
            const filtered = arr.filter(d => filter === 'all' || d.status === filter)
                                .sort((a,b) => new Date(b.date) - new Date(a.date));
            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="5" style="text-align:center;">No deposits for '${filter}'.</td></tr>`;
            } else {
                filtered.forEach(d => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${d.amount.toFixed(2)} Rs</td> <td>${d.method||'N/A'}</td>
                        <td>${formatDate(d.date)}</td> <td class="status-${d.status}">${d.status}</td>
                        <td>${d.status === 'pending' ? `<span class="action-link" data-id="${d.id}" data-type="deposit">Cancel</span>` : '--'}</td>
                    `;
                    body.appendChild(row);
                });
            }
            let sT=0, sP=0, sC=0;
            arr.forEach(d => { sT += d.amount; if(d.status==='completed')sC+=d.amount; if(d.status==='pending')sP+=d.amount; });
            updateDepositSummary(sT,sP,sC);
            attachCancelListeners(body, 'deposit');
        }
        function updateDepositSummary(t,p,c) {
            document.getElementById('total-deposits').textContent = `${t.toFixed(2)} Rs`;
            document.getElementById('pending-deposits').textContent = `${p.toFixed(2)} Rs`;
            document.getElementById('completed-deposits').textContent = `${c.toFixed(2)} Rs`;
        }

        function loadWithdrawHistory() {
            const body = document.getElementById('withdraw-history-body');
            if (!body) return;
            if (!currentUser || !userData || !userData.withdrawals) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No withdrawal history.</td></tr>';
                updateWithdrawalSummary(0,0,0); return;
            }
            const filter = document.getElementById('withdraw-filter')?.value || 'all';
            const arr = Object.values(userData.withdrawals);
            body.innerHTML = '';
            const filtered = arr.filter(w => filter === 'all' || w.status === filter)
                                .sort((a,b) => new Date(b.date) - new Date(a.date));
            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="5" style="text-align:center;">No withdrawals for '${filter}'.</td></tr>`;
            } else {
                filtered.forEach(w => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${w.requestedAmount.toFixed(2)} Rs</td> <td>${w.method||'N/A'}</td>
                        <td>${formatDate(w.date)}</td> <td class="status-${w.status}">${w.status}</td>
                        <td>${w.status === 'pending' ? `<span class="action-link" data-id="${w.id}" data-type="withdrawal" data-amount="${w.requestedAmount}">Cancel</span>`:'--'}</td>
                    `;
                    body.appendChild(row);
                });
            }
            let sT=0, sP=0, sC=0;
            arr.forEach(w => { sT += w.requestedAmount; if(w.status==='completed')sC+=w.requestedAmount; if(w.status==='pending')sP+=w.requestedAmount; });
            updateWithdrawalSummary(sT,sP,sC);
            attachCancelListeners(body, 'withdrawal');
        }
        function updateWithdrawalSummary(t,p,c) {
            document.getElementById('total-withdrawals').textContent = `${t.toFixed(2)} Rs`;
            document.getElementById('pending-withdrawals').textContent = `${p.toFixed(2)} Rs`;
            document.getElementById('completed-withdrawals').textContent = `${c.toFixed(2)} Rs`;
        }
        function attachCancelListeners(tableBody, type) {
            tableBody.querySelectorAll('.action-link').forEach(link => {
                link.addEventListener('click', function() {
                    cancelTransaction(this.dataset.id, type, parseFloat(this.dataset.amount) || 0);
                });
            });
        }
        function cancelTransaction(id, type, amountToRefund = 0) {
            const CType = type.charAt(0).toUpperCase() + type.slice(1);
            showConfirmationModal(
                `Cancel ${CType}`,
                `Cancel this ${type} request? ${type==='withdrawal'?'Amount refunded.':''}`,
                () => {
                    showLoading();
                    const path = `users/${currentUser.uid}/${type}s/${id}`;
                    const adminPath = `admin/pending_${type}s/${id}`;
                    database.ref(path).update({ status: 'cancelled' })
                    .then(() => database.ref(adminPath).update({ status: 'cancelled_by_user' }))
                    .then(() => {
                        if (type === 'withdrawal' && amountToRefund > 0) {
                            // Refund to earnings as it's the main source of withdrawable funds
                            return database.ref(`users/${currentUser.uid}`).update({ earnings: (userData.earnings || 0) + amountToRefund });
                        } return Promise.resolve();
                    })
                    .then(() => {
                        showNotification(`${CType} request cancelled.`, 'success');
                        if(type === 'deposit') loadDepositHistory(); else loadWithdrawHistory();
                    })
                    .catch(error => showNotification(`Error cancelling ${type}: ${error.message}`, 'error'))
                    .finally(() => hideLoading());
                }, 'warning'
            );
        }

        function loadReferralHistory() {
            const body = document.getElementById('referral-body');
            if (!body) return;
            if (!currentUser || !userData || !userData.referralHistory) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No referral commission history.</td></tr>';
                return;
            }
            const arr = Object.values(userData.referralHistory)
                            .filter(entry => entry.type === 'commission') // Only show commissions here
                            .sort((a, b) => new Date(b.date) - new Date(a.date));
            body.innerHTML = '';
            if (arr.length === 0) {
                 body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No commissions earned yet.</td></tr>';
            } else {
                arr.forEach(ref => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ref.referredUserName || 'Referred User'}</td>
                        <td>${ref.planPurchased ? getPlanName(ref.planPurchased) + ` (${ref.planPurchased} Rs)` : 'N/A'}</td>
                        <td>${ref.amount.toFixed(2)} Rs</td>
                        <td>${formatDate(ref.date)}</td>
                        <td class="status-${ref.status || 'completed'}">${ref.status || 'Credited'}</td>
                    `;
                    body.appendChild(row);
                });
            }
        }

        function initEarningsPage() { loadEarningsHistory(); setupEarningsChart(); }
        function loadEarningsHistory() {
            const body = document.getElementById('earnings-body');
            if (!body) return;
            if (!currentUser || !userData) {
                body.innerHTML = '<tr><td colspan="4" style="text-align:center;">No earnings.</td></tr>';
                updateEarningsSummary(0,0,0); return;
            }
            const period = document.getElementById('earnings-period')?.value || 'all';
            const entries = [];
            if (userData.earningsHistory) Object.values(userData.earningsHistory).forEach(e => entries.push({date: e.date, type: 'Investment', amount: e.amount, description: `From ${e.plan ? getPlanName(e.plan) : 'Plan'}`}));
            if (userData.referralHistory) Object.values(userData.referralHistory).forEach(e => entries.push({date: e.date, type: e.type === 'commission' ? 'Referral' : 'Milestone', amount: e.amount, description: e.type === 'commission' ? `From ${e.referredUserName || 'Referral'}` : `Milestone: ${e.milestoneName}`}));
            
            entries.sort((a,b) => new Date(b.date) - new Date(a.date));
            const now = new Date();
            const filtered = entries.filter(e => {
                const d = new Date(e.date);
                if (period === 'today') return d.toDateString() === now.toDateString();
                if (period === 'week') { const wS = new Date(now); wS.setDate(now.getDate() - now.getDay()); return d >= wS; }
                if (period === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                return true;
            });
            let totalP=0, todayT=0, totalR=0;
            entries.forEach(e => {
                if (e.type === 'Referral' || e.type === 'Milestone') totalR += e.amount;
                if (new Date(e.date).toDateString() === now.toDateString()) todayT += e.amount;
            });
            totalP = filtered.reduce((s,e) => s + e.amount, 0);
            updateEarningsSummary(entries.reduce((s,e) => s+e.amount,0), todayT, totalR);
            
            body.innerHTML = '';
            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="4" style="text-align:center;">No earnings for this period.</td></tr>`;
            } else {
                filtered.slice(0,20).forEach(e => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(e.date)}</td>
                        <td><span class="badge ${e.type.toLowerCase()}">${e.type}</span></td>
                        <td>${e.amount.toFixed(2)} Rs</td> <td>${e.description}</td>
                    `;
                    body.appendChild(row);
                });
            }
            updateChartData(filtered, period);
        }
        function updateEarningsSummary(total, today, referral) {
            document.getElementById('total-earnings').textContent = `${total.toFixed(2)} Rs`;
            document.getElementById('today-earnings').textContent = `${today.toFixed(2)} Rs`;
            document.getElementById('all-referral-earnings').textContent = `${referral.toFixed(2)} Rs`;
        }
        function setupEarningsChart() {
            const ctx = document.getElementById('earnings-chart')?.getContext('2d');
            if (!ctx) return;
            if (earningsChartInstance) earningsChartInstance.destroy();
            earningsChartInstance = new Chart(ctx, {
                type: 'line', data: { labels: [], datasets: [{ label: 'Total Earnings', data: [], borderColor: 'var(--primary-color)', backgroundColor: 'rgba(0, 169, 157, 0.1)', fill: true, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Amount (Rs)' }}, x: { title: { display: true, text: 'Date/Period' }}}, plugins: { legend: { display: true }, title: { display: true, text: 'Earnings Trend' }}}
            });
        }
        function updateChartData(data, period) {
            if (!earningsChartInstance) return;
            let labels = [], points = [];
            if (period === 'today' || (period === 'all' && data.length > 10)) {
                const recent = data.slice(0,15).reverse();
                labels = recent.map(e => formatDate(e.date, true));
                points = recent.map(e => e.amount);
            } else {
                const daily = {};
                data.forEach(e => { const day = new Date(e.date).toLocaleDateString(); daily[day] = (daily[day]||0) + e.amount; });
                labels = Object.keys(daily).sort((a,b) => new Date(a) - new Date(b));
                points = labels.map(day => daily[day]);
            }
            earningsChartInstance.data.labels = labels;
            earningsChartInstance.data.datasets[0].data = points;
            earningsChartInstance.update();
        }

        function initHistoryFilters() {
            document.getElementById('deposit-filter')?.addEventListener('change', loadDepositHistory);
            document.getElementById('withdraw-filter')?.addEventListener('change', loadWithdrawHistory);
            document.getElementById('earnings-period')?.addEventListener('change', loadEarningsHistory);
        }
        function initContactForm() {
            const form = document.getElementById('contact-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const n=this.elements['contact-name'].value, em=this.elements['contact-email'].value, s=this.elements['contact-subject'].value, m=this.elements['contact-message'].value;
                    if (!n||!em||!s||!m||!validateEmail(em)) { showNotification('Fill all fields correctly.', 'error'); return; }
                    const btn = this.querySelector('.submit-btn');
                    showLoadingButton(btn, true);
                    database.ref('contact_messages').push({ name:n, email:em, subject:s, message:m, date: new Date().toISOString(), userId: currentUser?currentUser.uid:'guest' })
                    .then(() => { showNotification('Message sent!', 'success'); form.reset(); })
                    .catch(err => { showNotification('Failed to send. Try again.', 'error'); console.error(err); })
                    .finally(() => showLoadingButton(btn, false, "Send Message"));
                });
            }
        }
        function showConfirmationModal(title, message, confirmCallback, type = 'warning') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const iconContainer = confirmationModalEl.querySelector('.modal-icon');
            iconContainer.querySelectorAll('i').forEach(icon => icon.style.display = 'none');
            const iconShow = iconContainer.querySelector(`i.${type}`);
            if(iconShow) iconShow.style.display = 'block';
            confirmationModalEl.classList.add('active');
            confirmationModalEl.classList.remove('hidden');
            const newConfirmBtn = modalConfirm.cloneNode(true); // Recreate to avoid multiple listeners
            modalConfirm.parentNode.replaceChild(newConfirmBtn, modalConfirm);
            newConfirmBtn.onclick = () => {
                confirmationModalEl.classList.remove('active');
                confirmationModalEl.classList.add('hidden');
                if (typeof confirmCallback === 'function') confirmCallback();
            };
            document.getElementById('modal-cancel').onclick = () => { // Ensure cancel also has a fresh listener context or is simple enough
                 confirmationModalEl.classList.remove('active');
                 confirmationModalEl.classList.add('hidden');
            }
        }
        function formatDate(dateString, short = false) {
            if (!dateString) return 'N/A';
            const d = new Date(dateString);
            if (short) return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            return d.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
