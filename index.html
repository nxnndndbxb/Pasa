
<body html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Treasure Pro - Cyber Neon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* style.css */
        /* Global Styles - Cyber Neon Dark Theme */
        :root {
            /* Main Theme Colors - Cyber Neon Dark */
            --primary-color: #00CFE8; /* Bright Cyan - "Shining" */
            --primary-light: #67E8F9; /* Lighter Cyan */
            --primary-dark: #0891B2;  /* Darker Cyan */
            --primary-rgb-val: 0, 207, 232; /* For rgba() usage */

            --secondary-color: #A855F7; /* Vibrant Purple */
            --secondary-light: #C084FC;
            --secondary-dark: #7E22CE;

            --accent-color: #EC4899; /* Bright Pink/Magenta */
            --accent-light: #F9A8D4;
            --accent-dark: #BE185D;

            /* Status Colors (can remain similar, ensure text contrast) */
            --success-color: #10B981; /* Emerald Green */
            --warning-color: #F59E0B; /* Amber */
            --danger-color: #EF4444; /* Red */
            --danger-dark: #C02E2E; /* Darker Red */
            --info-color: #3B82F6;   /* Blue */

            /* Backgrounds - Dark */
            --bg-light: #111827; /* Very Dark Blue-Gray (Main Background) */
            --bg-dark: #0F172A;  /* Even Darker (e.g., for header/footer elements) */

            --card-bg: #1F2937; /* Dark Gray-Blue (Card Background) */

            /* Text Colors - Light on Dark */
            --text-light: #F3F4F6; /* Off-white (Primary Text) */
            --text-dark-on-dark: #6B7280;  /* For less prominent dark text on dark bg, or specific UI elements */
            --text-gray: #9CA3AF; /* Lighter Gray (Secondary Text on Dark) */

            /* Borders & Shadows */
            --border-color: #374151; /* Gray for borders */
            --border-radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3); /* Darker, more pronounced shadow for dark themes */
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            /* "Shining" shadow/glow for focus or important elements */
            --glow-shadow: 0 0 15px 2px rgba(var(--primary-rgb-val), 0.4);

            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            --font-primary: 'Inter', 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-primary);
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-light); /* Primary text color for dark theme */
            line-height: 1.6;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-light); /* Default heading color */
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-gray);
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition);
        }

        a:hover {
            color: var(--primary-light);
        }

        /* Auth Styles */
        #auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0a0f18 100%); /* Darker gradient */
            color: var(--text-light);
            padding: 20px;
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            text-align: center;
        }

        .logo {
            width: 90px;
            height: 90px;
            margin-bottom: 15px;
            animation: gentlePulse 2.5s infinite ease-in-out;
            filter: drop-shadow(0 0 12px rgba(var(--primary-rgb-val), 0.7)); /* Neon glow */
        }

        @keyframes gentlePulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 12px rgba(var(--primary-rgb-val), 0.7));}
            50% { transform: scale(1.03); filter: drop-shadow(0 0 18px rgba(var(--primary-rgb-val), 1));}
            100% { transform: scale(1); filter: drop-shadow(0 0 12px rgba(var(--primary-rgb-val), 0.7));}
        }

        .app-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(var(--primary-rgb-val), 0.5), 0 0 20px rgba(var(--primary-rgb-val), 0.3); /* Neon text shadow */
            color: var(--primary-light);
        }

        #auth-options {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 380px;
        }

        .auth-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--accent-color);
            color: var(--text-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2), 0 0 8px rgba(var(--accent-rgb-val, 236, 72, 153), 0.5); /* Added glow for accent */
            flex: 1;
            text-align: center;
        }
        :root { --accent-rgb-val: 236, 72, 153; } /* Define for auth-btn glow */


        .auth-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), 0 0 12px rgba(var(--accent-rgb-val), 0.7);
            background-color: var(--accent-light);
        }

        .auth-form {
            background-color: var(--card-bg);
            padding: 35px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow-hover);
            animation: fadeIn 0.5s ease-out;
            color: var(--text-light); /* Default text color inside form */
        }

        .auth-form h2 {
            color: var(--primary-light); /* Neon title for form */
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.7rem;
            text-shadow: 0 0 5px rgba(var(--primary-rgb-val),0.3);
        }

        .form-group {
            position: relative;
            margin-bottom: 20px;
        }

        .form-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-gray);
        }

        .form-group.password-container i.fas.fa-lock {
             left: 15px;
        }

        .password-container .password-toggle i {
            left: auto;
            right: 15px;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-gray);
            cursor: pointer;
        }
        .password-toggle:hover {
            color: var(--primary-light);
        }

        .password-strength {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }

        .strength-bar {
            height: 5px;
            flex: 1;
            background-color: var(--border-color); /* Darker base for dark theme */
            border-radius: 3px;
        }
        .strength-bar.weak { background-color: var(--danger-color); }
        .strength-bar.medium { background-color: var(--warning-color); }
        .strength-bar.strong { background-color: var(--success-color); }

        .strength-text {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-left: 5px;
        }

        .auth-form input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            margin-bottom: 5px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--bg-light); /* Dark input bg */
            color: var(--text-light); /* Light text in input */
        }
        .auth-form input::placeholder {
            color: var(--text-gray);
        }

        .password-container input {
            padding-right: 45px;
        }

        .password-container.has-strength input {
            padding-right: 70px;
        }


        .auth-form input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb-val), 0.25), var(--glow-shadow); /* Neon focus ring and glow */
            background-color: var(--card-bg); /* Slightly different bg on focus */
        }

        .terms {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .terms input {
            width: auto;
            margin-right: 10px;
            accent-color: var(--primary-color); /* Style checkbox */
        }

        .terms label {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        #terms-link {
            color: var(--primary-color);
            font-weight: 500;
        }
        #terms-link:hover {
            text-decoration: underline;
            color: var(--primary-light);
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
            color: var(--bg-dark); /* Dark text on bright button for contrast */
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 10px rgba(var(--primary-rgb-val),0.3);
        }

        .submit-btn:hover {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover), 0 0 15px rgba(var(--primary-rgb-val),0.5);
        }
        .submit-btn .btn-loader i {
            color: var(--bg-dark); /* Match button text color */
        }

        .submit-btn.danger-btn { /* Specific style for danger action buttons */
            background: var(--danger-color) !important;
            color: var(--text-light) !important;
        }
        .submit-btn.danger-btn:hover {
            background: var(--danger-dark) !important;
            box-shadow: var(--shadow-hover), 0 0 15px rgba(239, 68, 68, 0.5); /* Reddish glow */
        }


        .auth-switch {
            text-align: center;
            margin-top: 25px;
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        .auth-switch span {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
        }
        .auth-switch span:hover {
            text-decoration: underline;
            color: var(--primary-light);
        }

        .forgot-password {
            text-align: center;
            margin: 15px 0;
            color: var(--accent-color);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .forgot-password:hover {
            text-decoration: underline;
            color: var(--accent-light);
        }

        #email-verify-notice {
            text-align: center;
        }
         #email-verify-notice h2 {
            color: var(--primary-light);
         }

        .verify-icon {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        #verify-email-address {
            font-weight: 600;
            color: var(--primary-light);
        }

        #resend-verify {
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }
        #resend-verify:hover {
            color: var(--primary-light);
        }


        /* App Styles */
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--bg-light); /* Main dark background */
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 25px;
            background: var(--bg-dark); /* Solid darker header */
            color: var(--text-light);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--primary-dark); /* Subtle neon separator */
        }

        .menu-toggle {
            font-size: 1.6rem;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
            padding: 5px;
        }

        .menu-toggle:hover {
            transform: scale(1.1) rotate(90deg);
            color: var(--primary-light);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            filter: drop-shadow(0 0 5px rgba(var(--primary-rgb-val),0.5));
        }

        .app-logo h1 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0;
            text-shadow: 0 0 3px rgba(var(--primary-rgb-val),0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .balance-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(var(--primary-rgb-val), 0.1); /* Subtle neon bg */
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(var(--primary-rgb-val), 0.3);
        }

        #user-balance {
            font-weight: 600;
            color: var(--primary-light);
        }

        .refresh-balance {
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            color: var(--text-light);
        }

        .refresh-balance:hover {
            transform: rotate(360deg) scale(1.1);
            color: var(--primary-light);
        }

        .user-avatar {
            position: relative;
            cursor: pointer;
        }

        .user-avatar i {
            font-size: 2rem;
            color: var(--text-light);
        }
        .user-avatar i:hover {
            color: var(--primary-light);
        }

        .online-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background-color: var(--success-color); /* Green status */
            border-radius: 50%;
            border: 2px solid var(--bg-dark); /* Match header bg */
            box-shadow: 0 0 5px var(--success-color);
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background-color: var(--card-bg); /* Dark card bg for menu */
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        .side-menu.active {
            left: 0;
        }

        .menu-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, var(--secondary-dark), var(--secondary-color));
            color: var(--text-light);
            text-align: center;
            position: relative;
        }

        .menu-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 12px;
            border: 3px solid rgba(var(--primary-rgb-val),0.5);
            object-fit: cover;
            box-shadow: 0 0 10px rgba(var(--primary-rgb-val),0.3);
        }

        .menu-header h3 {
            color: var(--text-light);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .menu-header span {
            font-size: 0.85rem;
            opacity: 0.8;
            color: var(--text-gray);
        }

        .user-level {
            margin-top: 10px;
        }

        #user-level-badge {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--text-light);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 0 8px rgba(var(--accent-rgb-val),0.4);
        }

        .menu-items {
            list-style: none;
            padding: 15px 0;
            flex: 1;
        }

        .menu-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 18px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            color: var(--text-gray);
            font-weight: 500;
        }

        .menu-item span {
            flex: 1;
        }

        .menu-item i {
            width: 22px;
            text-align: center;
            font-size: 1.15rem;
            color: var(--text-gray);
            transition: var(--transition);
        }

        .menu-item:hover {
            background-color: var(--bg-light); /* Darker hover bg */
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }
         .menu-item:hover i {
            color: var(--primary-color);
        }

        .menu-item.active {
            background-color: rgba(var(--primary-rgb-val), 0.1); /* Neon active bg */
            border-left: 4px solid var(--primary-color);
            color: var(--primary-light);
            font-weight: 600;
            box-shadow: inset 3px 0 8px -3px rgba(var(--primary-rgb-val),0.3);
        }
        .menu-item.active i {
            color: var(--primary-light);
        }


        .menu-footer {
            padding: 20px 15px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-gray);
            border-top: 1px solid var(--border-color);
        }

        .main-content {
            flex: 1;
            padding: 25px;
            margin-top: 60px; /* Height of app-header */
            transition: var(--transition);
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
        }

        /* Page Styles */
        .page {
            animation: fadeIn 0.5s ease;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .page-header h2 {
            margin-bottom: 0;
            color: var(--primary-light); /* Neon page titles */
            text-shadow: 0 0 5px rgba(var(--primary-rgb-val),0.3);
        }

        .page-description {
            color: var(--text-gray);
            margin-bottom: 25px;
            font-size: 0.95rem;
            width: 100%;
        }

        /* Card Style for general purpose cards */
        .card-style {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .card-style h3 {
            color: var(--primary-light); /* Neon card titles */
            margin-bottom: 20px;
            font-size: 1.25rem;
        }
        .card-style h3 i {
            margin-right: 10px;
            color: var(--primary-color);
        }

        /* Home Page */
        .slideshow-container {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            margin-bottom: 30px;
        }

        .slide {
            display: none;
            position: relative;
        }

        .slide img {
            width: 100%;
            vertical-align: middle;
            height: 350px;
            object-fit: cover;
            filter: brightness(0.7); /* Darken images slightly for text contrast */
        }

        .slide-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 20%, transparent);
            color: var(--text-light);
            padding: 40px 25px 25px;
        }

        .slide-content h3 {
            color: var(--primary-light); /* Neon slide title */
            margin-bottom: 8px;
            font-size: 1.6rem;
        }

        .slide-content p {
            color: var(--text-gray); /* Lighter gray for slide text */
            margin-bottom: 0;
            font-size: 1rem;
        }

        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 18px;
            margin-top: -25px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            transition: 0.6s ease;
            border-radius: 50%;
            user-select: none;
            background-color: rgba(var(--primary-rgb-val), 0.3); /* Neon controls */
            transform: translateY(-50%);
        }
        .prev { left: 15px; }
        .next { right: 15px; }


        .prev:hover, .next:hover {
            background-color: rgba(var(--primary-rgb-val), 0.6);
        }

        .dot-container {
            text-align: center;
            padding: 15px 0;
        }

        .dot {
            cursor: pointer;
            height: 13px;
            width: 13px;
            margin: 0 6px;
            background-color: var(--border-color); /* Darker inactive dots */
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.6s ease;
        }

        .active-dot, .dot:hover {
            background-color: var(--primary-color); /* Neon active dot */
        }
        .fade {
            animation-name: fade;
            animation-duration: 1.5s;
        }
        @keyframes fade {
            from {opacity: .4}
            to {opacity: 1}
        }


        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-hover), 0 0 10px rgba(var(--primary-rgb-val), 0.2); /* Subtle glow on hover */
            border-color: var(--primary-dark);
        }

        .stat-icon {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background-color: rgba(var(--primary-rgb-val), 0.15); /* Neon icon bg */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.7rem;
            color: var(--primary-color); /* Neon icon color */
        }

        .stat-card h3 { /* Label */
            font-size: 0.95rem;
            color: var(--text-gray);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .stat-card p { /* Value */
            font-size: 1.7rem;
            font-weight: 700;
            color: var(--text-light); /* Bright value text */
            margin-bottom: 0;
        }

        .quick-actions {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .quick-action {
            flex: 1 1 160px;
            min-width: 160px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            color: var(--text-gray);
            text-align: center;
        }

        .quick-action i {
            font-size: 1.8rem;
            color: var(--primary-color); /* Neon icon */
            transition: var(--transition);
        }

        .quick-action span {
            font-weight: 600;
            color: var(--text-light); /* Bright text */
            transition: var(--transition);
        }

        .quick-action:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover), var(--glow-shadow);
            background-color: var(--primary-color); /* Neon bg on hover */
            color: var(--bg-dark); /* Dark text on neon bg */
            border-color: var(--primary-color);
        }

        .quick-action:hover i, .quick-action:hover span {
            color: var(--bg-dark); /* Dark text/icon on neon bg */
        }

        /* Active Plan Management Card */
        #active-plan-management h3 { color: var(--secondary-light); }
        #active-plan-management p { color: var(--text-light); margin-bottom: 0.5rem; }
        #active-plan-management strong { color: var(--primary-light); }


        /* Added for bonus status on home page */
        #bonus-status-container {
             padding: 20px;
             border-width: 2px; /* Make border more prominent */
             transition: border-color 0.5s ease, box-shadow 0.5s ease;
        }
        #bonus-status-container h4 {
            font-size: 1.1rem;
            margin-bottom: 12px !important; /* Override general h4 margin */
        }
        #bonus-status-container p {
            color: var(--text-light);
            margin-bottom: 0px !important; /* Override general p margin */
        }
        #bonus-status-icon {
            display: block; /* Make icon block to center it properly with margin auto or ensure text-align works */
        }
        .fa-beat { /* Keyframes for fa-beat if not inherently supported by FA version or to customize */
            animation: fa-beat 1s infinite cubic-bezier(.17,.67,.49,1.25);
        }
        @keyframes fa-beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }


        .announcement-card {
            margin-top: 30px;
        }

        .announcement-card h3 i {
            color: var(--accent-color); /* Magenta icon */
        }

        .announcement-content {
            padding: 15px;
            background-color: var(--bg-light); /* Darker inner bg */
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
         .announcement-content p {
            color: var(--text-gray); /* Lighter gray for content */
        }


        /* Team Page */
        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .ranking-header h3 {
            color: var(--text-light); /* Bright sub-heading */
            font-size: 1.1rem;
            margin-bottom: 0;
        }

        .rank-badge {
            background-color: var(--accent-color); /* Magenta badge */
            color: var(--text-light);
            padding: 8px 18px;
            border-radius: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 0 8px rgba(var(--accent-rgb-val), 0.5);
        }

        .rank-badge i {
            font-size: 1.3rem;
        }

        .action-btn {
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
            color: var(--bg-dark); /* Dark text on neon button */
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 10px rgba(var(--primary-rgb-val),0.3);
        }

        .action-btn:hover {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover), 0 0 15px rgba(var(--primary-rgb-val),0.5);
        }

        .ranking-table {
            margin-bottom: 30px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th, td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        td { color: var(--text-gray); } /* Default TD text color */

        th {
            background-color: var(--bg-dark); /* Darker header bg */
            color: var(--primary-light); /* Neon text for th */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: rgba(var(--primary-rgb-val), 0.08); /* Subtle neon hover */
        }
         tr:hover td {
            color: var(--primary-light); /* Brighter text on hover */
        }


        .current-user {
            background-color: rgba(var(--primary-rgb-val), 0.15) !important;
            font-weight: 600;
        }
        .current-user td {
            color: var(--primary-color) !important; /* Neon text for current user */
        }


        .invitation-section {
            margin-bottom: 30px;
        }

        .invite-code-container {
            display: flex;
            margin: 20px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 0 0 1px var(--border-color);
        }

        #invite-code {
            flex: 1;
            padding: 12px 15px;
            border: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-light); /* Neon invite code */
            background-color: var(--bg-light); /* Darker input bg */
        }

        .copy-btn {
            padding: 12px 20px;
            background-color: var(--primary-color); /* Neon button */
            color: var(--bg-dark); /* Dark text */
            border: none;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .copy-btn:hover {
            background-color: var(--primary-dark);
        }

        .invite-note {
            font-style: italic;
            color: var(--text-gray);
            margin-bottom: 20px;
            font-size: 0.9rem;
            background-color: var(--bg-light); /* Darker note bg */
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--primary-color); /* Neon accent border */
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .referral-stat {
            background-color: var(--bg-light); /* Darker stat card bg */
            padding: 20px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border-color);
        }
        .referral-stat .stat-icon {
            width: 45px;
            height: 45px;
            font-size: 1.3rem;
            background-color: rgba(var(--primary-rgb-val), 0.15); /* Neon icon bg */
            color: var(--primary-color); /* Neon icon */
        }

        .referral-stat h4 { /* Label */
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .referral-stat p { /* Value */
            font-weight: 700;
            color: var(--text-light); /* Bright value */
            margin-bottom: 0;
            font-size: 1.2rem;
        }

        .referral-share {
            margin: 25px 0;
        }

        .referral-share h4 {
            margin-bottom: 15px;
            color: var(--text-light); /* Bright heading */
            font-size: 1.05rem;
        }

        .share-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            box-shadow: var(--shadow);
        }

        .share-btn i {
            font-size: 1.2rem;
        }

        /* Specific share button colors remain, text should be light for contrast */
        .share-btn.whatsapp { background-color: #25D366; color: white; }
        .share-btn.facebook { background-color: #1877F2; color: white; }
        .share-btn.copy-link {
            background-color: var(--card-bg);
            color: var(--text-light); /* Light text on dark button */
            border: 1px solid var(--border-color);
        }

        .share-btn:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: var(--shadow-hover);
            opacity: 0.9;
        }
        .share-btn.copy-link:hover {
            background-color: var(--border-color); /* Slightly lighter dark on hover */
            color: var(--primary-light);
        }


        .referral-table th, .referral-table td {
            padding: 12px 15px;
            font-size: 0.9rem;
        }
         .referral-table td { color: var(--text-gray); }


        /* Status Badges for Tables */
        .status-pending, .status-completed, .status-rejected, .status-cancelled, .status-active, .status-credited {
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-block;
            text-transform: capitalize;
        }
        /* Text color for badges needs to contrast with their new bg */
        .status-pending { background-color: var(--warning-color); color: var(--bg-dark); } /* Dark text on amber */
        .status-completed, .status-active, .status-credited { background-color: var(--success-color); color: var(--text-light); }
        .status-rejected, .status-cancelled { background-color: var(--danger-color); color: var(--text-light); }


        /* Plans Page */
        .plans-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .plan-card {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .plan-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: var(--shadow-hover), 0 0 15px rgba(var(--primary-rgb-val),0.2);
            border-color: var(--primary-color); /* Neon border on hover */
        }

        .plan-card h3 {
            color: var(--secondary-light); /* Purple plan title */
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.4rem;
        }

        .plan-price {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-light); /* Neon price */
            text-align: center;
            margin-bottom: 10px;
        }
        .plan-price span.currency {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-gray);
        }


        .plan-duration {
            text-align: center;
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .plan-duration i {
            color: var(--primary-color); /* Neon icon */
        }


        .plan-features {
            list-style: none;
            margin-bottom: 30px;
            flex: 1;
        }

        .plan-features li {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 0.95rem;
            color: var(--text-light); /* Brighter feature text */
        }

        .plan-features i {
            color: var(--success-color); /* Green check icon */
            margin-top: 4px;
            font-size: 1.1rem;
        }

        .buy-plan-btn {
            margin-top: auto;
        }
        .buy-plan-btn:disabled {
            background: var(--border-color); /* Darker disabled bg */
            color: var(--text-dark-on-dark); /* Muted text for disabled */
            cursor: not-allowed;
            box-shadow: none;
        }
        .buy-plan-btn:disabled:hover {
            transform: none;
            box-shadow: none;
            background: var(--border-color);
        }


        .popular {
            border: 2px solid var(--primary-color); /* Neon border for popular */
            transform: scale(1.02);
            box-shadow: var(--shadow), 0 0 20px rgba(var(--primary-rgb-val),0.3); /* Add glow to popular */
        }
        .popular:hover {
            transform: translateY(-6px) scale(1.03);
             box-shadow: var(--shadow-hover), 0 0 25px rgba(var(--primary-rgb-val),0.5);
        }

        .popular-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background-color: var(--accent-color); /* Magenta badge */
            color: var(--text-light);
            padding: 6px 18px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: var(--shadow), 0 0 8px rgba(var(--accent-rgb-val),0.5);
        }

        .plan-info-card {
            margin-top: 30px;
        }
        .plan-info-card h3 i {
            color: var(--info-color); /* Blue info icon */
        }

        .info-content {
            padding: 15px;
            background-color: var(--bg-light); /* Darker inner bg */
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .info-content p {
            margin-bottom: 12px;
            display: flex;
            flex-wrap: wrap;
        }

        .info-content p strong {
            min-width: 130px;
            color: var(--text-light); /* Bright label */
            margin-right: 8px;
        }
        .info-content p span {
            color: var(--text-gray); /* Lighter gray value */
        }

        /* Deposit Page */
        .deposit-methods {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .method-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            border: 2px solid transparent;
            min-width: 130px;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .method-card img {
            height: 45px;
            width: auto;
            max-width: 110px;
            object-fit: contain;
            margin-bottom: 5px;
            filter: drop-shadow(0 0 3px rgba(255,255,255,0.2)); /* Slight glow for logos */
        }
        .method-card span {
            font-weight: 500;
            color: var(--text-light); /* Bright text */
        }

        .method-card.active {
            border-color: var(--primary-color); /* Neon active border */
            background-color: rgba(var(--primary-rgb-val), 0.05);
            box-shadow: var(--shadow-hover), var(--glow-shadow); /* Neon glow for active */
            transform: scale(1.03);
        }

        .method-card:hover:not(.active) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-light);
        }

        .deposit-instructions {
            margin-bottom: 30px;
        }
        .deposit-instructions h3 i {
            color: var(--info-color); /* Blue info icon */
        }

        .account-details {
            background-color: var(--bg-light); /* Darker details block */
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .detail-item {
            display: flex;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            width: 150px;
            color: var(--text-light); /* Bright label */
            margin-bottom: 5px;
        }

        .detail-value {
            flex: 1;
            font-family: 'Roboto Mono', monospace;
            font-size: 1.15rem;
            color: var(--primary-light); /* Neon value */
            word-break: break-all;
            background-color: var(--card-bg); /* Match card bg for value block */
            padding: 5px 8px;
            border-radius: 4px;
        }

        .important-note {
            display: flex;
            gap: 15px;
            background-color: rgba(245, 158, 11, 0.1); /* Amber transparent for dark theme */
            padding: 18px;
            border-radius: var(--border-radius);
            margin-top: 25px;
            border-left: 4px solid var(--warning-color); /* Amber accent */
        }

        .important-note i {
            color: var(--warning-color); /* Amber icon */
            font-size: 1.3rem;
            margin-top: 3px;
        }

        .important-note p {
            margin-bottom: 0;
            color: var(--text-light); /* Bright text in note */
            font-size: 0.95rem;
        }

        .deposit-form {
        }
        .deposit-form h3 i {
            color: var(--primary-color); /* Neon icon */
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light); /* Bright label */
        }

        .form-select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); /* text-gray arrow */
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 1em;
            transition: var(--transition);
            background-color: var(--bg-light); /* Dark select bg */
            color: var(--text-light); /* Light text in select */
        }
        .form-select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb-val), 0.25), var(--glow-shadow);
        }

        #custom-amount-container {
            margin-top: 10px;
        }

        #custom-amount {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: var(--bg-light); /* Dark input */
            color: var(--text-light); /* Light text */
        }
        #custom-amount:focus {
             border-color: var(--primary-color);
             outline: none;
             box-shadow: 0 0 0 3px rgba(var(--primary-rgb-val), 0.25), var(--glow-shadow);
             background-color: var(--card-bg);
        }
        #custom-amount::placeholder { color: var(--text-gray); }


        .file-upload {
            position: relative;
            margin-bottom: 20px;
        }

        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 15px;
            background-color: var(--bg-light); /* Darker button bg */
            color: var(--text-gray); /* Lighter gray text */
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            border: 2px dashed var(--border-color);
            text-align: center;
            width: 100%;
        }
        .upload-btn i {
            font-size: 1.2rem;
        }

        .upload-btn:hover {
            background-color: var(--border-color); /* Slightly lighter dark */
            border-color: var(--primary-color); /* Neon border */
            color: var(--primary-light); /* Neon text */
        }

        #file-name {
            display: block;
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--text-gray);
            font-style: italic;
            text-align: center;
        }

        /* Withdraw Page */
        .withdraw-info-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            border: 1px solid var(--border-color);
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 15px;
            background-color: var(--bg-light); /* Darker item bg */
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .info-item i {
            font-size: 1.6rem;
            color: var(--primary-color); /* Neon icon */
            flex-shrink: 0;
            width: 40px;
            text-align: center;
        }

        .info-content h4 { /* Label */
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .info-content p { /* Value */
            font-weight: 600;
            color: var(--text-light); /* Bright value */
            margin-bottom: 0;
            font-size: 1.05rem;
        }

        .withdraw-form {
        }
        .withdraw-form h3 i {
            color: var(--primary-color); /* Neon icon */
        }

        .amount-buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .amount-btn {
            padding: 8px 15px;
            background-color: var(--bg-light); /* Darker button bg */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--primary-light); /* Neon text on button */
            font-weight: 500;
        }

        .amount-btn:hover {
            background-color: var(--primary-color); /* Neon bg on hover */
            color: var(--bg-dark); /* Dark text on neon bg */
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        /* History Pages */
        .history-filter {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .history-filter select, .earnings-filter select {
            min-width: 180px;
            margin-bottom: 0;
            /* Uses .form-select styling (already dark theme adapted) */
        }

        .history-table {
            padding: 0;
            overflow: hidden;
        }
        .history-table table {
             margin-bottom: 0;
        }

        .history-table th {
            background-color: var(--primary-dark); /* Dark neon for history th */
            color: var(--text-light); /* Light text on dark neon bg */
        }
         .history-table td { color: var(--text-gray); }

        .history-table tr:nth-child(even) {
            background-color: var(--bg-light); /* Slightly darker even rows */
        }
        .history-table tr:hover {
            background-color: rgba(var(--primary-rgb-val), 0.08); /* Neon hover */
        }
         .history-table tr:hover td {
            color: var(--primary-light); /* Brighter text on hover */
        }

        .history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .summary-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .summary-card h4 { /* Label */
            color: var(--text-gray);
            font-size: 0.95rem;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .summary-card p { /* Value */
            font-weight: 700;
            color: var(--primary-light); /* Neon value */
            margin-bottom: 0;
            font-size: 1.3rem;
        }

        .action-link {
            color: var(--primary-color); /* Neon link */
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: var(--transition);
        }

        .action-link:hover {
            color: var(--primary-light);
            text-decoration: underline;
        }
        td .action-link {
            font-size: 0.9em;
        }

        /* Earnings Page */
        .earnings-stats {
            margin-bottom: 30px;
        }

        .earnings-chart-container {
            margin-bottom: 30px;
        }
        .earnings-chart-container h3 i {
            color: var(--primary-color); /* Neon icon */
        }

        #earnings-chart {
            width: 100% !important;
            max-height: 380px;
        }
        /* Chart.js usually handles its own colors, but if not: */
        canvas { background-color: transparent; }


        .earnings-table-container {
        }
        .earnings-table-container h3 i {
            color: var(--primary-color); /* Neon icon */
        }

        .earnings-table th, .earnings-table td {
            font-size: 0.9rem;
        }
         .earnings-table td { color: var(--text-gray); }

        .earnings-table .badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-light); /* Default light text for badges */
        }
        .earnings-table .badge.investment { background-color: var(--primary-color); color:var(--bg-dark); } /* Dark text on neon */
        .earnings-table .badge.referral { background-color: var(--secondary-color); }
        .earnings-table .badge.milestone { background-color: var(--accent-color); }
        .earnings-table .badge.bonus { background-color: var(--info-color); }


        /* Contact Page */
        .contact-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .contact-card {
            background-color: var(--card-bg);
            padding: 35px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .contact-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: var(--shadow-hover), 0 0 15px rgba(var(--primary-rgb-val),0.2);
            border-color: var(--primary-color); /* Neon border on hover */
        }

        .contact-icon {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            font-size: 2rem;
        }

        /* Specific icon colors for contact methods */
        .contact-card.whatsapp .contact-icon { color: #25D366; background-color: rgba(37, 211, 102, 0.1); }
        .contact-card.email .contact-icon { color: var(--primary-color); background-color: rgba(var(--primary-rgb-val), 0.1); }
        .contact-card.phone .contact-icon { color: var(--info-color); background-color: rgba(59, 130, 246, 0.1); } /* Blue from --info-color */

        .contact-card h3 {
            margin-bottom: 12px;
            font-size: 1.3rem;
            color: var(--secondary-light); /* Purple title */
        }

        .contact-card p {
            margin-bottom: 25px;
            flex: 1;
            color: var(--text-gray);
            font-size: 0.95rem;
        }

        .contact-btn {
            margin-top: auto;
            padding: 12px 28px;
            font-size: 1rem;
            /* Uses .action-btn styling which is already neon */
        }
        .contact-btn:hover {
             color: var(--bg-dark); /* Ensure text stays dark on neon hover */
        }


        .contact-form-container {
        }
        .contact-form-container h3 i {
            color: var(--primary-color); /* Neon icon */
        }

        #contact-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light); /* Bright label */
        }

        #contact-form input,
        #contact-form textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--bg-light); /* Dark input bg */
            color: var(--text-light); /* Light text in input */
        }
        #contact-form input::placeholder,
        #contact-form textarea::placeholder {
            color: var(--text-gray);
        }


        #contact-form textarea {
            resize: vertical;
            min-height: 130px;
        }

        #contact-form input:focus,
        #contact-form textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb-val), 0.25), var(--glow-shadow);
            background-color: var(--card-bg); /* Slightly different bg on focus */
        }
        #contact-form .submit-btn {
            /* Uses general submit-btn styling */
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.85); /* Darker overlay, matches --bg-light with alpha */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(3px);
        }

        .loader-content {
            background-color: var(--card-bg); /* Dark card bg for loader box */
            padding: 35px 45px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-hover);
            color: var(--text-light); /* Light text in loader */
        }

        .loader-content i { /* Spinner icon */
            font-size: 2.8rem;
            color: var(--primary-color); /* Neon spinner */
            margin-bottom: 20px;
            display: block;
        }

        .loader-content p { /* Loading text */
            font-weight: 500;
            color: var(--text-light); /* Light text */
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        /* Notification System */
        #notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: calc(100% - 40px);
            max-width: 400px;
        }

        .notification {
            padding: 18px 22px;
            border-radius: var(--border-radius);
            color: var(--text-light);
            box-shadow: var(--shadow-hover);
            /* animation: slideInRight 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), fadeOut 0.5s ease-in 3.5s forwards; */ /* Default auto-fade */
            animation: slideInRight 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; /* Only slide in initially */
            display: flex;
            align-items: center;
            gap: 18px;
            font-size: 1rem;
            line-height: 1.5;
            border: 1px solid rgba(255,255,255,0.1); /* Subtle border for notifications */
            opacity: 0; /* Start hidden for animation */
        }
         .notification.fade-out { /* Class to trigger fade out */
            animation: fadeOut 0.5s ease-in forwards;
        }


        @keyframes slideInRight {
            from { transform: translateX(120%) translateY(-10px) scale(0.95); opacity: 0; }
            to { transform: translateX(0) translateY(0) scale(1); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1) translateY(0); }
            to { opacity: 0; transform: scale(0.9) translateY(-10px); }
        }

        .notification i {
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        /* Notification types with gradients */
        .notification.success { background: linear-gradient(to right, var(--success-color), #34D399); } /* Emerald */
        .notification.error { background: linear-gradient(to right, var(--danger-color), #F87171); } /* Red */
        .notification.warning { background: linear-gradient(to right, var(--warning-color), #FBBF24); color: var(--bg-dark); } /* Dark text on amber */
        .notification.info { background: linear-gradient(to right, var(--info-color), #60A5FA); } /* Blue */

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.75); /* Dark backdrop, --bg-light with alpha */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--card-bg); /* Dark modal bg */
            padding: 35px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 480px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35); /* Stronger shadow for dark */
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease;
            position: relative;
            opacity: 0;
            border: 1px solid var(--border-color);
        }

        .modal.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal-icon {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-icon i {
            font-size: 3.8rem;
            display: none;
        }
        .modal-icon i.success { display: block; color: var(--success-color); }
        .modal-icon i.warning { display: block; color: var(--warning-color); }
        .modal-icon i.error { display: block; color: var(--danger-color); }
        .modal-icon i.danger { display: block; color: var(--danger-color); } /* Alias for error */


        .modal h3 {
            text-align: center;
            margin-bottom: 18px;
            color: var(--primary-light); /* Neon modal title */
            font-size: 1.5rem;
        }

        .modal p {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-gray); /* Lighter gray modal text */
            line-height: 1.6;
            font-size: 1rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 18px;
            margin-top: 15px;
        }

        .modal-btn {
            padding: 10px 28px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 120px;
            font-size: 0.95rem;
            box-shadow: var(--shadow);
        }

        .modal-btn.cancel {
            background-color: var(--card-bg); /* Dark cancel button */
            color: var(--text-light); /* Light text */
            border: 1px solid var(--border-color);
        }

        .modal-btn.cancel:hover {
            background-color: var(--border-color); /* Slightly lighter dark */
            box-shadow: var(--shadow-hover);
        }

        .modal-btn.confirm {
            background-color: var(--primary-color); /* Neon confirm */
            color: var(--bg-dark); /* Dark text on neon */
        }
        .modal-btn.confirm.error, .modal-btn.confirm.danger { background-color: var(--danger-color); color:var(--text-light); }
        .modal-btn.confirm.warning { background-color: var(--warning-color); color: var(--bg-dark); } /* Dark text on amber */

        .modal-btn.confirm:hover {
            background-color: var(--primary-dark);
            box-shadow: var(--shadow-hover), 0 0 10px rgba(var(--primary-rgb-val),0.3);
            transform: translateY(-1px);
        }
        .modal-btn.confirm.error:hover, .modal-btn.confirm.danger:hover { background-color: var(--danger-dark); }
        .modal-btn.confirm.warning:hover { background-color: var(--accent-light); }


        .terms-content {
            max-height: 80vh;
            overflow-y: auto;
        }
         .terms-content h3 { color: var(--primary-light); } /* Neon title in terms */

        .terms-text {
            margin-bottom: 25px;
            font-size: 0.95rem;
            line-height: 1.7;
        }
        .terms-text p {
            color: var(--text-gray); /* Lighter gray terms text */
        }
        .terms-text h4 {
            margin-top: 25px;
            color: var(--primary-light); /* Neon subheadings */
            font-size: 1.15rem;
        }
        .terms-content #terms-accept.submit-btn {
             width: auto;
             margin: 20px auto 0;
             display: block;
             padding: 12px 30px;
             /* Uses submit-btn styling (already neon) */
        }

        .screenshot-content {
            max-width: 550px;
        }
        .screenshot-content h3 { color: var(--primary-light); } /* Neon title */


        #screenshot-preview {
            min-height: 280px;
            max-height: 450px;
            background-color: var(--bg-light); /* Dark preview bg */
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        #screenshot-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 5px;
        }
         #screenshot-preview p {
            color: var(--text-gray);
            font-style: italic;
            padding: 20px;
        }

        /* Referral Invites Block - Team Page */
        .invites-block {
            margin-top: 30px;
        }
        .invites-block h3 {
            color: var(--secondary-light); /* Purple title */
        }
        .invites-block h3 i {
            color: var(--secondary-color);
        }
        .referral-level-info p {
            font-size: 1.05rem;
            margin-bottom: 0.5rem;
            color: var(--text-light); /* Bright text */
        }
        .referral-level-info p strong {
            color: var(--primary-light); /* Neon emphasis */
        }
        .referral-milestones {
            margin-top: 20px;
        }
        .referral-milestones h4 {
            font-size: 1rem;
            color: var(--text-light); /* Bright heading */
            margin-bottom: 10px;
        }
        .referral-milestones ul {
            list-style: none;
            padding-left: 0;
        }
        .referral-milestones li {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.95rem;
            color: var(--text-gray); /* Lighter gray text */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .referral-milestones li:last-child {
            border-bottom: none;
        }
        .referral-milestones li .status-completed { /* Badge styling already handled */
             margin-left: 5px;
        }
        .referral-milestones li .status-pending { /* Text styling, not badge */
            margin-left: 5px;
            background-color: transparent;
            color: var(--text-gray);
            padding: 0;
            font-style: italic;
            font-weight: normal;
            font-size: 0.85rem;
        }

        .next-milestone-progress {
            margin-top: 20px;
        }
        .next-milestone-progress p {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 8px;
        }
        .progress-bar-container {
            width: 100%;
            background-color: var(--border-color); /* Darker progress bg */
            border-radius: var(--border-radius);
            overflow: hidden;
            height: 12px;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color); /* Neon progress */
            transition: width 0.5s ease-in-out;
            border-radius: var(--border-radius);
            text-align: center;
            line-height: 12px;
            font-size: 0.7rem;
            color: var(--bg-dark); /* Dark text on neon bar */
        }


        /* Responsive Styles */
        @media (max-width: 992px) {
            .stat-card.large {
                grid-column: span 1;
            }
            .side-menu {
                width: 260px;
                left: -270px;
            }
        }

        @media (max-width: 768px) {
            .stats-container, .referral-stats, .earnings-stats {
                grid-template-columns: 1fr;
            }
            .app-title { font-size: 1.8rem; }
            .auth-form { padding: 25px; }
            .main-content {
                padding: 20px;
                margin-top: 56px;
            }
            .quick-actions {
                justify-content: space-around;
            }
            .quick-action {
                flex-basis: calc(48% - 10px);
            }
            .contact-methods {
                grid-template-columns: 1fr;
            }
            #notification-container {
                top: 70px;
                width: calc(100% - 30px);
            }
            .slide img { height: 280px; }
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .history-filter, .earnings-filter {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            #auth-options { flex-direction: column; gap: 15px; }
            .auth-btn { width: 100%; }
            .auth-form { padding: 20px; }
            .modal-content {
                padding: 25px;
                margin: 0 10px;
            }
            .modal-buttons {
                flex-direction: column-reverse;
                gap: 12px;
            }
            .modal-btn { width: 100%; }
            .history-filter, .earnings-filter {
                flex-direction: column;
                align-items: stretch;
            }
            .history-filter select, .earnings-filter select {
                width: 100%;
            }
            .quick-action {
                flex-basis: 100%;
            }
            .app-logo h1 { font-size: 1.1rem; }
            .slide img { height: 220px; }
            .prev, .next { padding: 14px; font-size: 18px; }
            .dot { height: 11px; width: 11px; }
            .deposit-methods .method-card {
                min-width: calc(50% - 10px);
                padding: 15px;
            }
            .deposit-methods .method-card img { height: 35px; }
            .detail-label, .detail-value {
                width: 100%;
            }
            .detail-value { font-size: 1.05rem;}
            .plans-container {
                grid-template-columns: 1fr;
            }
            .referral-stats {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="auth-container" class="container">
        <div class="logo-container">
            <img src="https://cdn-icons-png.flaticon.com/512/2936/2936886.png" alt="Video Treasure Logo" class="logo">
            <h1 class="app-title">Video Treasure Pro</h1>
        </div>

        <div id="auth-options">
            <button id="register-btn" class="auth-btn animate__animated animate__fadeInUp">Register</button>
            <button id="login-btn" class="auth-btn animate__animated animate__fadeInUp">Login</button>
        </div>

        <div id="register-form" class="auth-form hidden">
            <h2>Create Account</h2>
            <div class="form-group">
                <i class="fas fa-user"></i>
                <input type="text" id="reg-name" placeholder="Full Name" required>
            </div>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="reg-email" placeholder="Email" required>
            </div>
            <div class="form-group password-container has-strength">
                <i class="fas fa-lock"></i>
                <input type="password" id="reg-password" placeholder="Password" required>
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
                <div class="password-strength">
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-bar"></span>
                    <span class="strength-text"></span>
                </div>
            </div>
            <div class="form-group password-container">
                <i class="fas fa-lock"></i>
                <input type="password" id="reg-confirm-password" placeholder="Confirm Password" required>
            </div>
            <div class="form-group">
                <i class="fas fa-phone"></i>
                <input type="text" id="reg-phone" placeholder="Phone Number (e.g., 03xxxxxxxxx)" required>
            </div>
            <div class="form-group">
                <i class="fas fa-user-plus"></i>
                <input type="text" id="reg-invite" placeholder="Invitation Code (Optional)">
            </div>
            <div class="form-group terms">
                <input type="checkbox" id="reg-terms">
                <label for="reg-terms">I agree to the <a href="#" id="terms-link">Terms & Conditions</a></label>
            </div>
            <button id="submit-register" class="submit-btn">
                <span class="btn-text">Register</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="auth-switch">Already have an account? <span id="switch-to-login">Login</span></p>
        </div>

        <div id="login-form" class="auth-form hidden">
            <h2>Login</h2>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="login-email" placeholder="Email" required>
            </div>
            <div class="form-group password-container">
                <i class="fas fa-lock"></i>
                <input type="password" id="login-password" placeholder="Password" required>
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
            </div>
            <button id="submit-login" class="submit-btn">
                <span class="btn-text">Login</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="forgot-password" id="forgot-password">Forgot Password?</p>
            <p class="auth-switch">Don't have an account? <span id="switch-to-register">Register</span></p>
        </div>

        <div id="reset-form" class="auth-form hidden">
            <h2>Reset Password</h2>
            <div class="form-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="reset-email" placeholder="Enter your email" required>
            </div>
            <button id="submit-reset" class="submit-btn">
                <span class="btn-text">Send Reset Link</span>
                <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <p class="auth-switch">Remember your password? <span id="switch-to-login-from-reset">Login</span></p>
        </div>

        <div id="email-verify-notice" class="auth-form hidden">
            <h2>Verify Your Email</h2>
            <i class="fas fa-envelope-open-text verify-icon"></i>
            <p>We've sent a verification email to <strong id="verify-email-address">your.email@example.com</strong>. Please check your inbox (and spam folder) and click the verification link to activate your account.</p>
            <p>Didn't receive the email? <span id="resend-verify" class="auth-switch">Resend Email</span></p>
            <button id="verify-continue" class="submit-btn hidden" style="margin-top:20px;">Continue (after verification)</button>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <div class="app-logo">
                <img src="https://cdn-icons-png.flaticon.com/512/2936/2936886.png" alt="Video Treasure Logo">
                <h1>Video Treasure Pro</h1>
            </div>
            <div class="user-info">
                <div class="balance-container">
                    <i class="fas fa-wallet" style="font-size: 0.9em; opacity: 0.8;"></i>
                    <span id="user-balance">0 Rs</span>
                    <i class="fas fa-sync-alt refresh-balance" id="refresh-balance" title="Refresh Balance"></i>
                </div>
                <div class="user-avatar" id="user-profile"> <!-- Could be a dropdown trigger -->
                    <i class="fas fa-user-circle"></i>
                    <span class="online-status"></span>
                </div>
            </div>
        </header>

        <!-- Side Menu -->
        <div class="side-menu" id="side-menu">
            <div class="menu-header">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User Profile" id="menu-user-img">
                <h3 id="menu-username">User Name</h3>
                <span id="menu-user-email">user@example.com</span>
                <div class="user-level">
                    <span id="user-level-badge">Standard</span>
                </div>
            </div>
            <ul class="menu-items">
                <li class="menu-item active" data-page="home"><i class="fas fa-home"></i> <span>Home</span></li>
                <li class="menu-item" data-page="team"><i class="fas fa-users"></i> <span>Team & Rewards</span></li>
                <li class="menu-item" data-page="plans"><i class="fas fa-box-open"></i> <span>Plans</span></li>
                <li class="menu-item" data-page="deposit"><i class="fas fa-money-bill-wave"></i> <span>Deposit</span></li>
                <li class="menu-item" data-page="withdraw"><i class="fas fa-wallet"></i> <span>Withdraw</span></li>
                <li class="menu-item" data-page="deposit-history"><i class="fas fa-history"></i> <span>Deposit History</span></li>
                <li class="menu-item" data-page="withdraw-history"><i class="fas fa-clock"></i> <span>Withdraw History</span></li>
                <li class="menu-item" data-page="earnings"><i class="fas fa-chart-line"></i> <span>Earnings</span></li>
                <li class="menu-item" data-page="contact"><i class="fas fa-headset"></i> <span>Contact Us</span></li>
                <li class="menu-item" id="logout-btn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></li>
            </ul>
            <div class="menu-footer">
                <p>&copy; 2024 Video Treasure Pro</p>
                <p>Version 2.2.0</p> <!-- Version bump for new features -->
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden">
                <div class="loader-content">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading...</p>
                </div>
            </div>

            <!-- Home Page -->
            <div class="page" id="home-page">
                <div class="slideshow-container">
                    <div class="slide fade">
                        <img src="https://images.unsplash.com/photo-1620714223084-8fcacc6dfd8d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGludmVzdG1lbnQlMjBncm93dGh8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=800&q=60" style="width:100%">
                        <div class="slide-content">
                            <h3>Maximize Your Earnings</h3>
                            <p>Invest in our diverse plans and watch your capital grow with daily 25% returns.</p>
                        </div>
                    </div>
                    <div class="slide fade">
                        <img src="https://images.unsplash.com/photo-1556761175-5973dc0f32e7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8cmVmZXJyYWwlMjBwcm9ncmFtfGVufDB8fDB8fHww&auto=format&fit=crop&w=800&q=60" style="width:100%">
                        <div class="slide-content">
                            <h3>Unlock Referral Rewards</h3>
                            <p>Invite friends and earn commissions, plus exciting milestone bonuses!</p>
                        </div>
                    </div>
                    <div class="slide fade">
                        <img src="https://images.pexels.com/photos/50987/money-card-business-credit-card-50987.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" style="width:100%">
                        <div class="slide-content">
                            <h3>Swift & Secure Withdrawals</h3>
                            <p>Access your earnings easily via Easypaisa or JazzCash.</p>
                        </div>
                    </div>
                    <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                    <a class="next" onclick="plusSlides(1)">&#10095;</a>
                </div>
                <br>
                <div class="dot-container" style="text-align:center">
                    <span class="dot" onclick="currentSlide(1)"></span>
                    <span class="dot" onclick="currentSlide(2)"></span>
                    <span class="dot" onclick="currentSlide(3)"></span>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Balance</h3>
                            <p id="total-balance">0 Rs</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Active Plan</h3>
                            <p id="active-plan">None</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Daily Earnings</h3>
                            <p id="daily-earnings">0 Rs</p>
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" id="quick-deposit">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Deposit</span>
                    </button>
                    <button class="quick-action" id="quick-withdraw">
                        <i class="fas fa-wallet"></i>
                        <span>Withdraw</span>
                    </button>
                    <button class="quick-action" id="quick-invite">
                        <i class="fas fa-user-plus"></i>
                        <span>Invite Friends</span>
                    </button>
                </div>

                <!-- Active Plan Management -->
                <div id="active-plan-management" class="card-style hidden" style="margin-top: 20px;">
                    <h3><i class="fas fa-cogs"></i> Manage Active Plan</h3>
                    <p>Your current active plan: <strong id="manage-active-plan-name">None</strong></p>
                    <p>Original End Date: <strong id="manage-active-plan-end-date">N/A</strong></p>
                    <button id="delete-plan-btn" class="submit-btn danger-btn">
                        <span class="btn-text">Cancel Current Plan</span>
                        <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                    <p style="font-size:0.85em; margin-top:10px; color: var(--text-gray);">Note: Cancelling your plan will stop future daily earnings. Your initial principal will still be returned at the original end date of the plan's 30-day term.</p>
                </div>


                <!-- Bonus Status Display -->
                <div id="bonus-status-container" class="card-style hidden" style="margin-top: 20px; text-align: center;">
                    <h4 id="bonus-status-title" style="color: var(--secondary-light); margin-bottom: 10px;">Registration Bonus Status</h4>
                    <p id="bonus-status-message" style="font-size: 0.95rem;"></p>
                    <i id="bonus-status-icon" class="fas" style="font-size: 2rem; margin-top: 10px;"></i>
                </div>

                <div class="announcement-card card-style">
                    <h3><i class="fas fa-bullhorn"></i> Platform Updates</h3>
                    <div class="announcement-content">
                        <p id="announcement-text">Welcome to the enhanced Video Treasure Pro! Explore new referral rewards and enjoy our updated platform look. Invest wisely!</p>
                    </div>
                </div>
            </div>

            <!-- Team Page -->
            <div class="page hidden" id="team-page">
                <div class="page-header">
                    <h2>Your Team & Rewards</h2>
                </div>
                <p class="page-description">Manage your referrals, track commissions, and aim for exciting milestone rewards by growing your team.</p>

                <div class="invitation-section card-style">
                    <h3><i class="fas fa-user-plus"></i> Your Invitation Code</h3>
                    <div class="invite-code-container">
                        <input type="text" id="invite-code" readonly>
                        <button id="copy-invite" class="copy-btn">
                            <i class="far fa-copy"></i> Copy
                        </button>
                    </div>
                    <p class="invite-note">Share this code with friends. You'll earn commission on their first plan purchase, and unlock milestone rewards as your team grows!</p>

                    <div class="referral-stats">
                        <div class="referral-stat">
                            <div class="stat-icon"> <i class="fas fa-users"></i> </div>
                            <div class="stat-info">
                                <h4>Total Referrals</h4>
                                <p id="total-referrals">0</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                             <div class="stat-icon"> <i class="fas fa-hand-holding-usd"></i> </div>
                            <div class="stat-info">
                                <h4>Commission Earned</h4>
                                <p id="referral-earnings">0 Rs</p>
                            </div>
                        </div>
                        <div class="referral-stat">
                           <div class="stat-icon"> <i class="fas fa-calendar-day"></i> </div>
                            <div class="stat-info">
                                <h4>Today's Commission</h4>
                                <p id="today-referral-earnings">0 Rs</p>
                            </div>
                        </div>
                         <div class="referral-stat">
                           <div class="stat-icon"> <i class="fas fa-star"></i> </div>
                            <div class="stat-info">
                                <h4>Referral Level</h4>
                                <p id="referral-user-level-display">Starter</p>
                            </div>
                        </div>
                    </div>

                    <div class="referral-share">
                        <h4>Share Your Link:</h4>
                        <div class="share-buttons">
                            <button class="share-btn whatsapp"> <i class="fab fa-whatsapp"></i> WhatsApp </button>
                            <button class="share-btn facebook"> <i class="fab fa-facebook"></i> Facebook </button>
                            <button class="share-btn copy-link"> <i class="fas fa-link"></i> Copy Link </button>
                        </div>
                    </div>
                </div>

                <div class="invites-block card-style">
                    <h3><i class="fas fa-gifts"></i> Referral Milestones</h3>
                    <div class="referral-milestones">
                        <ul id="milestones-list">
                            <!-- JS will populate this:
                            <li>Bronze Referrer (3 Refs): <span class="status-completed">Achieved! +50 Rs</span></li>
                            <li>Silver Referrer (7 Refs): <span class="status-pending">3 more needed</span></li>
                            -->
                        </ul>
                    </div>
                    <div class="next-milestone-progress">
                        <p id="next-milestone-info">Loading next milestone...</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="milestone-progress-bar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                </div>

                <div class="ranking-header" style="margin-top:30px;">
                    <h3>Your Current Rank</h3>
                    <div class="rank-badge" id="user-rank-badge">
                        <span>#0</span>
                        <i class="fas fa-trophy"></i>
                    </div>
                </div>

                <button id="view-ranking-btn" class="action-btn">
                    <i class="fas fa-list-ol"></i> View Full Ranking
                </button>

                <div class="ranking-table card-style hidden" id="ranking-table-container"> <!-- Renamed ID -->
                    <h3>Top Investors</h3>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Investment</th>
                                    <th>Total Earnings</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="referral-history-section card-style" style="margin-top:30px;"> <!-- New wrapper -->
                    <h3><i class="fas fa-history"></i> Referral Commission History</h3>
                    <div class="table-responsive">
                        <table class="referral-table history-table">
                            <thead>
                                <tr>
                                    <th>Referred User</th>
                                    <th>Plan Purchased</th>
                                    <th>Commission</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="referral-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Plans Page -->
            <div class="page hidden" id="plans-page">
                <div class="page-header">
                    <h2>Investment Plans</h2>
                </div>
                <p class="page-description">Choose a plan to start earning daily 25% returns for 30 days. Principal returned at end of term.</p>

                <div class="plans-container">
                    <div class="plan-card">
                        <h3>Basic Plan</h3>
                        <div class="plan-price">550 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 25%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 850%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="550">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>

                    <div class="plan-card popular">
                        <div class="popular-badge">Most Popular</div>
                        <h3>Silver Plan</h3>
                        <div class="plan-price">1400 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 25%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 850%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="1400">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>

                    <div class="plan-card">
                        <h3>Gold Plan</h3>
                        <div class="plan-price">2800 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 25%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 850%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="2800">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>

                    <div class="plan-card">
                        <h3>Platinum Plan</h3>
                        <div class="plan-price">5600 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 25%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 850%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="5600">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>

                    <div class="plan-card">
                        <h3>Diamond Plan</h3>
                        <div class="plan-price">8400 <span class="currency">Rs</span></div>
                        <div class="plan-duration"> <i class="fas fa-calendar-alt"></i> 30 Days Duration </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> Daily Earnings: 25%</li>
                            <li><i class="fas fa-check-circle"></i> Total Return: 850%</li>
                            <li><i class="fas fa-check-circle"></i> Principal Included</li>
                            <li><i class="fas fa-check-circle"></i> 24/7 Support</li>
                        </ul>
                        <button class="buy-plan-btn submit-btn" data-plan="8400">
                            <span class="btn-text">Buy Now</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                </div>

                <div class="plan-info-card card-style">
                    <h3><i class="fas fa-info-circle"></i> Plan Information</h3>
                    <div class="info-content">
                        <p><strong>Daily Earnings:</strong> <span>25% of your investment amount</span></p>
                        <p><strong>Duration:</strong> <span>30 days (including weekends)</span></p>
                        <p><strong>Total Return:</strong> <span>850% (Principal + 750% profit)</span></p>
                        <p><strong>Withdrawals:</strong> <span>Daily earnings can be withdrawn anytime (Min. 200 Rs)</span></p>
                        <p><strong>Principal:</strong> <span>Returned to your balance at the end of the plan period</span></p>
                    </div>
                </div>
            </div>

            <!-- Deposit Page -->
            <div class="page hidden" id="deposit-page">
                <div class="page-header">
                    <h2>Deposit Funds</h2>
                </div>
                 <p class="page-description">Add funds to your account to purchase investment plans. Currently, Easypaisa is supported for deposits.</p>

                <div class="deposit-methods">
                    <div class="method-card active" data-method="easypaisa">
                        <img src="https://www.easypaisa.com.pk/wp-content/uploads/2022/02/Easypaisa-Logo.png" alt="Easypaisa">
                        <span>Easypaisa</span>
                    </div>
                     <!-- Add other methods here if needed, e.g.,
                     <div class="method-card" data-method="jazzcash">
                        <img src="path/to/jazzcash-logo.png" alt="JazzCash">
                        <span>JazzCash</span>
                    </div>
                    -->
                </div>

                <div class="deposit-instructions card-style">
                    <h3><i class="fas fa-info-circle"></i> Deposit Instructions (Easypaisa)</h3>
                    <p>Send money to the following Easypaisa account details. Ensure you enter the correct Transaction ID when submitting the form.</p>
                    <div class="account-details">
                        <div class="detail-item">
                            <span class="detail-label">Account Number:</span>
                            <span class="detail-value" id="deposit-account-number">03709912807</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Account Holder:</span>
                            <span class="detail-value" id="deposit-account-name">Memoona zohra</span>
                        </div>
                    </div>
                    <div class="important-note">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>After sending money, please fill out the form below accurately to verify your deposit. Processing typically takes 5-15 minutes. An incorrect Transaction ID will delay verification.</p>
                    </div>
                </div>

                <div class="deposit-form card-style">
                    <h3><i class="fas fa-edit"></i> Submit Deposit Details</h3>
                    <form id="deposit-form-element"> <!-- Added form tag for easier reset -->
                        <div class="form-group">
                            <label for="deposit-amount">Amount (Rs)</label>
                            <select id="deposit-amount" class="form-select">
                                <option value="">Select Amount or Plan</option>
                                <option value="550">550 Rs (Basic Plan)</option>
                                <option value="1400">1400 Rs (Silver Plan)</option>
                                <option value="2800">2800 Rs (Gold Plan)</option>
                                <option value="5600">5600 Rs (Platinum Plan)</option>
                                <option value="8400">8400 Rs (Diamond Plan)</option>
                                <option value="other">Other Amount</option>
                            </select>
                            <div id="custom-amount-container" class="hidden form-group" style="margin-top: 10px;">
                                <label for="custom-amount">Custom Amount (Min 550 Rs)</label>
                                <input type="number" id="custom-amount" placeholder="Enter custom amount" min="550">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="deposit-transaction">Transaction ID (TID / TrxID)</label>
                            <input type="text" id="deposit-transaction" placeholder="Enter the exact transaction ID from Easypaisa" required>
                        </div>

                        <div class="form-group">
                            <label for="deposit-sender">Your Easypaisa Mobile Number</label>
                            <input type="text" id="deposit-sender" placeholder="Enter your 11-digit Easypaisa number" required>
                        </div>

                        <div class="form-group">
                            <label for="deposit-screenshot">Payment Screenshot (Optional but Recommended)</label>
                            <div class="file-upload">
                                <input type="file" id="deposit-screenshot" accept="image/*">
                                <label for="deposit-screenshot" class="upload-btn">
                                    <i class="fas fa-cloud-upload-alt"></i> <span>Choose Screenshot</span>
                                </label>
                                <span id="file-name">No file chosen</span>
                            </div>
                        </div>

                        <button id="submit-deposit" type="button" class="submit-btn"> <!-- Changed to type="button" to prevent default form submission -->
                            <span class="btn-text">Submit Deposit</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Withdraw Page -->
            <div class="page hidden" id="withdraw-page">
                <div class="page-header">
                    <h2>Withdraw Funds</h2>
                </div>
                <p class="page-description">Minimum withdrawal: 200 Rs. Maximum withdrawal per transaction: 20,000 Rs. A 5% fee applies.</p>

                <div class="withdraw-info-card">
                    <div class="info-item">
                        <i class="fas fa-wallet"></i>
                        <div class="info-content">
                            <h4>Available Balance</h4>
                            <p id="withdraw-available-balance">0 Rs</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-clock"></i>
                        <div class="info-content">
                            <h4>Processing Time</h4>
                            <p>1-6 hours (Business Hours)</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-percentage"></i>
                        <div class="info-content">
                            <h4>Withdrawal Fee</h4>
                            <p>5% (Standard)</p>
                        </div>
                    </div>
                </div>

                <div class="withdraw-form card-style">
                    <h3><i class="fas fa-money-bill-wave"></i> Withdrawal Request</h3>
                    <form id="withdraw-form-element"> <!-- Added form tag for easier reset -->
                        <div class="form-group">
                            <label for="withdraw-method">Withdrawal Method</label>
                            <select id="withdraw-method" class="form-select">
                                <option value="">Select Method</option>
                                <option value="easypaisa">Easypaisa</option>
                                <option value="jazzcash">JazzCash</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="withdraw-account">Account Number (11 Digits)</label>
                            <input type="text" id="withdraw-account" placeholder="Enter your Easypaisa/JazzCash number" required>
                        </div>

                        <div class="form-group">
                            <label for="withdraw-name">Account Holder Name</label>
                            <input type="text" id="withdraw-name" placeholder="Enter the name registered with the account" required>
                        </div>

                        <div class="form-group">
                            <label for="withdraw-amount">Amount to Withdraw (Rs)</label>
                            <input type="number" id="withdraw-amount" placeholder="Min 200, Max 20000" min="200" max="20000" required>
                            <div class="amount-buttons">
                                <button class="amount-btn" data-amount="200">200</button>
                                <button class="amount-btn" data-amount="500">500</button>
                                <button class="amount-btn" data-amount="1000">1000</button>
                                <button class="amount-btn" data-amount="2000">2000</button>
                                <button class="amount-btn" data-amount="5000">5000</button>
                            </div>
                        </div>

                        <button id="submit-withdraw" type="button" class="submit-btn"> <!-- Changed to type="button" -->
                            <span class="btn-text">Request Withdrawal</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Deposit History Page -->
            <div class="page hidden" id="deposit-history-page">
                <div class="page-header">
                    <h2>Deposit History</h2>
                    <div class="history-filter">
                        <select id="deposit-filter" class="form-select">
                            <option value="all">All Deposits</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <div class="history-table card-style">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="deposit-history-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="history-summary">
                    <div class="summary-card">
                        <h4>Total Deposits</h4>
                        <p id="total-deposits">0 Rs</p>
                    </div>
                    <div class="summary-card">
                        <h4>Pending Deposits</h4>
                        <p id="pending-deposits">0 Rs</p>
                    </div>
                    <div class="summary-card">
                        <h4>Completed Deposits</h4>
                        <p id="completed-deposits">0 Rs</p>
                    </div>
                </div>
            </div>

            <!-- Withdraw History Page -->
            <div class="page hidden" id="withdraw-history-page">
                <div class="page-header">
                    <h2>Withdrawal History</h2>
                    <div class="history-filter">
                        <select id="withdraw-filter" class="form-select">
                            <option value="all">All Withdrawals</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <div class="history-table card-style">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="withdraw-history-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="history-summary">
                    <div class="summary-card">
                        <h4>Total Withdrawals</h4>
                        <p id="total-withdrawals">0 Rs</p>
                    </div>
                    <div class="summary-card">
                        <h4>Pending Withdrawals</h4>
                        <p id="pending-withdrawals">0 Rs</p>
                    </div>
                    <div class="summary-card">
                        <h4>Completed Withdrawals</h4>
                        <p id="completed-withdrawals">0 Rs</p>
                    </div>
                </div>
            </div>

            <!-- Earnings Page -->
            <div class="page hidden" id="earnings-page">
                <div class="page-header">
                    <h2>Your Earnings Overview</h2>
                    <div class="earnings-filter">
                        <select id="earnings-period" class="form-select">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                </div>

                <div class="earnings-stats stats-container"> <!-- Re-used stats-container styling -->
                    <div class="stat-card large"> <!-- Example of a larger stat card if needed -->
                        <div class="stat-icon"> <i class="fas fa-coins"></i> </div>
                        <div class="stat-info">
                            <h3>Total Earnings (All Time)</h3>
                            <p id="total-earnings">0 Rs</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon"> <i class="fas fa-calendar-day"></i> </div>
                        <div class="stat-info">
                            <h3>Today's Earnings</h3>
                            <p id="today-earnings">0 Rs</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon"> <i class="fas fa-user-friends"></i> </div>
                        <div class="stat-info">
                            <h3>Referral & Bonus Earnings</h3>
                            <p id="all-referral-earnings">0 Rs</p>
                        </div>
                    </div>
                </div>

                <div class="earnings-chart-container card-style">
                    <h3><i class="fas fa-chart-line"></i> Earnings Trend</h3>
                    <canvas id="earnings-chart"></canvas>
                </div>

                <div class="earnings-table-container card-style history-table"> <!-- Added history-table for styling consistency -->
                    <h3><i class="fas fa-list"></i> Recent Earnings History</h3>
                    <div class="table-responsive">
                        <table class="earnings-table"> <!-- Removed history-table from <table> for specific overrides if needed -->
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="earnings-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contact Page -->
            <div class="page hidden" id="contact-page">
                <div class="page-header">
                    <h2>Contact Support</h2>
                </div>
                 <p class="page-description">Have questions or need assistance? Our support team is here to help. Choose your preferred method to get in touch.</p>

                <div class="contact-methods">
                    <div class="contact-card whatsapp"> <!-- Added class for specific styling -->
                        <div class="contact-icon"> <i class="fab fa-whatsapp"></i> </div>
                        <h3>WhatsApp Support</h3>
                        <p>Chat with us directly on WhatsApp for quick answers and support.</p>
                        <a href="https://wa.me/923359408248" target="_blank" class="contact-btn action-btn">Chat Now</a>
                    </div>

                    <div class="contact-card email"> <!-- Added class -->
                        <div class="contact-icon"> <i class="fas fa-envelope"></i> </div>
                        <h3>Email Support</h3>
                        <p>Send us an email with your query. We aim to respond within 24 hours.</p>
                        <a href="mailto:hteh34641557@gmail.com" class="contact-btn action-btn">Email Us</a>
                    </div>

                    <div class="contact-card phone"> <!-- Added class -->
                        <div class="contact-icon"> <i class="fas fa-phone-alt"></i> </div>
                        <h3>Call Support</h3>
                        <p>Reach us by phone during business hours (10 AM - 6 PM, Mon-Fri).</p>
                        <a href="tel:+923359408248" class="contact-btn action-btn">Call Now</a>
                    </div>
                </div>

                <div class="contact-form-container card-style">
                    <h3><i class="fas fa-paper-plane"></i> Send us a Message Directly</h3>
                    <form id="contact-form">
                        <div class="form-group">
                            <label for="contact-name">Your Name</label>
                            <input type="text" id="contact-name" name="contact-name" placeholder="Enter your full name" required>
                        </div>

                        <div class="form-group">
                            <label for="contact-email">Your Email Address</label>
                            <input type="email" id="contact-email" name="contact-email" placeholder="Enter your email for our reply" required>
                        </div>

                        <div class="form-group">
                            <label for="contact-subject">Subject</label>
                            <input type="text" id="contact-subject" name="contact-subject" placeholder="Briefly describe your query" required>
                        </div>

                        <div class="form-group">
                            <label for="contact-message">Message</label>
                            <textarea id="contact-message" name="contact-message" rows="5" placeholder="Please provide details here..." required></textarea>
                        </div>

                        <button type="submit" class="submit-btn">
                            <span class="btn-text">Send Message</span>
                            <span class="btn-loader hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification System -->
    <div id="notification-container"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content animate__animated animate__fadeInDown animate__faster">
            <div class="modal-icon">
                <i class="fas fa-check-circle success"></i>
                <i class="fas fa-exclamation-circle warning"></i>
                <i class="fas fa-times-circle error"></i> <!-- Also used for 'danger' -->
            </div>
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-message">Are you sure you want to perform this action?</p>
            <div class="modal-buttons">
                <button id="modal-cancel" class="modal-btn cancel">Cancel</button>
                <button id="modal-confirm" class="modal-btn confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="terms-modal" class="modal hidden">
        <div class="modal-content terms-content animate__animated animate__fadeInUp animate__faster">
            <h3>Terms & Conditions</h3>
            <div class="terms-text">
                <p><strong>Last Updated: July 2024</strong></p>

                <h4>1. Investment Plans</h4>
                <p>All investment plans offered by Video Treasure Pro have a fixed duration of 30 days. Daily earnings are calculated at a rate of 25% of the principal investment amount. These earnings are credited daily to your account balance. The principal amount is returned to your balance at the end of the 30-day plan term. Users may choose to cancel their active plan at any time; however, cancelling a plan will only stop future daily earnings. The original principal will still only be returned at the end of the original 30-day term.</p>

                <h4>2. Withdrawals</h4>
                <p>The minimum amount for withdrawal is 200 Rs. Withdrawal requests are typically processed within 1 to 6 hours during standard business hours (10:00 AM to 6:00 PM, Monday to Friday). A standard withdrawal fee of 5% applies to all transactions. Maximum withdrawal per transaction is 20,000 Rs.</p>

                <h4>3. Referral Program</h4>
                <p>Users can earn a commission (typically 25%, subject to change) on the first investment amount of their directly referred users. Additional milestone rewards may be available for achieving specific numbers of active referrals. All referral earnings are added to the user's withdrawable balance. Video Treasure Pro reserves the right to modify the referral program terms at any time.</p>

                <h4>4. Account Security</h4>
                <p>You are solely responsible for maintaining the confidentiality of your account credentials, including your password. Video Treasure Pro is not liable for any loss or damage arising from your failure to protect your account. You must notify us immediately of any unauthorized use of your account or any other breach of security.</p>

                <h4>5. Amendments to Terms</h4>
                <p>Video Treasure Pro reserves the right to modify these Terms & Conditions at any time without prior notice. Any changes will be effective immediately upon posting the revised terms on the platform. Your continued use of the platform after such modifications constitutes your acceptance of the new Terms & Conditions.</p>

                <h4>6. Prohibited Activities</h4>
                <p>Users are prohibited from creating multiple accounts for exploiting the referral system, using automated scripts or bots, engaging in fraudulent activities, or attempting to exploit any vulnerabilities in the system. Violation of these terms may result in account suspension or termination and forfeiture of funds.</p>

                <h4>7. Disclaimer of Liability</h4>
                <p>Video Treasure Pro provides its services "as is" and makes no warranties regarding the platform's reliability or profitability. Investment involves risk, and past performance is not indicative of future results. We are not responsible for any financial losses incurred by users.</p>
            </div>
            <button id="terms-accept" class="submit-btn">I Understand & Accept</button>
        </div>
    </div>

    <!-- Screenshot Preview Modal -->
    <div id="screenshot-modal" class="modal hidden">
        <div class="modal-content screenshot-content animate__animated animate__zoomIn animate__faster">
            <h3>Payment Screenshot Preview</h3>
            <div id="screenshot-preview"> <!-- Corrected from class to id -->
                <p>No image selected or preview not available.</p>
            </div>
            <div class="modal-buttons">
                <button id="screenshot-cancel" class="modal-btn cancel">Change Image</button>
                <button id="screenshot-confirm" class="modal-btn confirm">Use This Image</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // app.js
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCDJDsUZ-RwkC5h2LH7mRql1SSixINGT-8", // Replace with your actual API key
            authDomain: "video-apk-8af78.firebaseapp.com",
            databaseURL: "https://video-apk-8af78-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "video-apk-8af78",
            storageBucket: "video-apk-8af78.appspot.com",
            messagingSenderId: "272112220572", // Replace with your actual Sender ID
            appId: "1:272112220572:android:d5f72b22ea35d714a47059" // Replace with your actual Web App ID
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const registerBtn = document.getElementById('register-btn');
        const loginBtn = document.getElementById('login-btn');
        const registerFormEl = document.getElementById('register-form');
        const loginFormEl = document.getElementById('login-form');
        const resetFormEl = document.getElementById('reset-form');
        const emailVerifyNotice = document.getElementById('email-verify-notice');
        const switchToLogin = document.getElementById('switch-to-login');
        const switchToRegister = document.getElementById('switch-to-register');
        const forgotPassword = document.getElementById('forgot-password');
        const switchToLoginFromReset = document.getElementById('switch-to-login-from-reset');
        const submitRegister = document.getElementById('submit-register');
        const submitLogin = document.getElementById('submit-login');
        const submitReset = document.getElementById('submit-reset');
        const verifyContinue = document.getElementById('verify-continue');
        const resendVerify = document.getElementById('resend-verify');
        const verifyEmailAddressEl = document.getElementById('verify-email-address');

        const termsLink = document.getElementById('terms-link');
        const termsModal = document.getElementById('terms-modal');
        const termsAccept = document.getElementById('terms-accept');
        const menuToggle = document.getElementById('menu-toggle');
        const sideMenu = document.getElementById('side-menu');
        const menuItems = document.querySelectorAll('.menu-item');
        const pages = document.querySelectorAll('.page');
        const logoutBtn = document.getElementById('logout-btn');
        const notificationContainer = document.getElementById('notification-container');
        const confirmationModalEl = document.getElementById('confirmation-modal');
        const modalCancel = document.getElementById('modal-cancel');
        let modalConfirm = document.getElementById('modal-confirm'); // Use let for reassignment
        const loadingOverlay = document.getElementById('loading-overlay');
        const refreshBalance = document.getElementById('refresh-balance');
        const quickDeposit = document.getElementById('quick-deposit');
        const quickWithdraw = document.getElementById('quick-withdraw');
        const quickInvite = document.getElementById('quick-invite');

        // Referral Program Elements
        const milestonesListEl = document.getElementById('milestones-list');
        const nextMilestoneInfoEl = document.getElementById('next-milestone-info');
        const milestoneProgressBarEl = document.getElementById('milestone-progress-bar');

        // Active Plan Management Elements
        const activePlanManagementDiv = document.getElementById('active-plan-management');
        const manageActivePlanNameEl = document.getElementById('manage-active-plan-name');
        const manageActivePlanEndDateEl = document.getElementById('manage-active-plan-end-date');
        const deletePlanBtn = document.getElementById('delete-plan-btn');


        // User data
        let currentUser = null;
        let userData = null;
        let earningsInterval = null;
        let lastEarningsUpdate = null;
        let earningsChartInstance = null;
        let referralMilestonesConfig = []; // To be loaded from Firebase


        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
            loadReferralConfig(); // Load referral settings early
        }

        async function loadReferralConfig() {
            try {
                const snapshot = await database.ref('admin/referralSettings/milestones').once('value');
                if (snapshot.exists()) {
                    referralMilestonesConfig = snapshot.val();
                    // Sort milestones by required referrals to ensure correct progression
                    if (Array.isArray(referralMilestonesConfig)) {
                       referralMilestonesConfig.sort((a, b) => a.requiredReferrals - b.requiredReferrals);
                    } else { // If it's an object, convert to array and sort
                        referralMilestonesConfig = Object.values(referralMilestonesConfig)
                                                        .sort((a, b) => a.requiredReferrals - b.requiredReferrals);
                    }
                } else {
                    // Default milestones if not set in Firebase
                    referralMilestonesConfig = [
                        { id: "milestone1", requiredReferrals: 3, rewardAmount: 50, name: "Bronze Referrer" },
                        { id: "milestone2", requiredReferrals: 7, rewardAmount: 150, name: "Silver Referrer" },
                        { id: "milestone3", requiredReferrals: 15, rewardAmount: 350, name: "Gold Referrer" }
                    ];
                    console.warn("Referral milestones not found in Firebase, using defaults.");
                }
            } catch (error) {
                console.error("Error loading referral config:", error);
                 referralMilestonesConfig = [ // Fallback defaults
                        { id: "milestone1", requiredReferrals: 3, rewardAmount: 50, name: "Bronze Referrer" },
                        { id: "milestone2", requiredReferrals: 7, rewardAmount: 150, name: "Silver Referrer" },
                        { id: "milestone3", requiredReferrals: 15, rewardAmount: 350, name: "Gold Referrer" }
                    ];
            }
        }


        // Set up event listeners
        function setupEventListeners() {
            registerBtn.addEventListener('click', () => showAuthForm(registerFormEl));
            loginBtn.addEventListener('click', () => showAuthForm(loginFormEl));
            switchToLogin.addEventListener('click', () => showAuthForm(loginFormEl));
            switchToRegister.addEventListener('click', () => showAuthForm(registerFormEl));
            forgotPassword.addEventListener('click', () => showAuthForm(resetFormEl));
            switchToLoginFromReset.addEventListener('click', () => showAuthForm(loginFormEl));

            submitRegister.addEventListener('click', registerUser);
            submitLogin.addEventListener('click', loginUser);
            submitReset.addEventListener('click', resetUserPassword);

            verifyContinue.addEventListener('click', () => {
                authContainer.classList.remove('hidden'); // This might be redundant if already visible
                emailVerifyNotice.classList.add('hidden');
                if (currentUser) {
                    currentUser.reload().then(() => {
                        if (currentUser.emailVerified) checkAuthState();
                        else showNotification('Email not yet verified. Please check your inbox.', 'warning');
                    });
                } else { // Fallback if currentUser is somehow null
                    showAuthForm(loginFormEl);
                }
            });
            resendVerify.addEventListener('click', resendVerificationEmail);

            termsLink.addEventListener('click', (e) => {
                e.preventDefault();
                termsModal.classList.add('active');
                termsModal.classList.remove('hidden');
            });
            termsAccept.addEventListener('click', () => {
                termsModal.classList.remove('active');
                termsModal.classList.add('hidden');
            });

            // Modal closing on backdrop click
            document.addEventListener('click', (event) => {
                if (event.target === termsModal) {
                    termsModal.classList.remove('active');
                    termsModal.classList.add('hidden');
                }
                if (event.target === confirmationModalEl) {
                    confirmationModalEl.classList.remove('active');
                    confirmationModalEl.classList.add('hidden');
                }
                const screenshotModalEl = document.getElementById('screenshot-modal');
                if (event.target === screenshotModalEl) {
                    screenshotModalEl.classList.remove('active');
                    screenshotModalEl.classList.add('hidden');
                }
            });

            menuToggle.addEventListener('click', () => sideMenu.classList.toggle('active'));

            menuItems.forEach(item => {
                if (item.id !== 'logout-btn') {
                    item.addEventListener('click', () => navigateToPage(item.dataset.page));
                }
            });

            logoutBtn.addEventListener('click', logoutUser);

            modalCancel.addEventListener('click', () => {
                confirmationModalEl.classList.remove('active');
                confirmationModalEl.classList.add('hidden');
            });

            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const input = this.closest('.password-container').querySelector('input');
                    const icon = this.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.replace('fa-eye', 'fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.replace('fa-eye-slash', 'fa-eye');
                    }
                });
            });

            const passwordInput = document.getElementById('reg-password');
            if (passwordInput) passwordInput.addEventListener('input', checkPasswordStrength);

            const depositAmountSelect = document.getElementById('deposit-amount');
            if (depositAmountSelect) {
                depositAmountSelect.addEventListener('change', function() {
                    const customAmountContainer = document.getElementById('custom-amount-container');
                    if (this.value === 'other') customAmountContainer.classList.remove('hidden');
                    else customAmountContainer.classList.add('hidden');
                });
            }

            const fileUploadInput = document.getElementById('deposit-screenshot');
            if (fileUploadInput) {
                fileUploadInput.addEventListener('change', function() {
                    const fileNameSpan = document.getElementById('file-name');
                    const screenshotModal = document.getElementById('screenshot-modal');
                    const screenshotPreview = document.getElementById('screenshot-preview');

                    if (this.files.length > 0) {
                        fileNameSpan.textContent = this.files[0].name;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            screenshotPreview.innerHTML = `<img src="${e.target.result}" alt="Payment Screenshot">`;
                            screenshotModal.classList.add('active');
                            screenshotModal.classList.remove('hidden');
                        };
                        reader.readAsDataURL(this.files[0]);
                    } else {
                        fileNameSpan.textContent = 'No file chosen';
                        screenshotPreview.innerHTML = '<p>No image selected or preview not available.</p>';
                    }
                });
            }

            const screenshotCancelBtn = document.getElementById('screenshot-cancel');
            const screenshotConfirmBtn = document.getElementById('screenshot-confirm');
            const screenshotModalEl = document.getElementById('screenshot-modal');

            if (screenshotCancelBtn) {
                screenshotCancelBtn.addEventListener('click', () => {
                    screenshotModalEl.classList.remove('active');
                    screenshotModalEl.classList.add('hidden');
                    if(fileUploadInput) fileUploadInput.value = ''; // Clear file input
                    const fileNameSpan = document.getElementById('file-name');
                    if(fileNameSpan) fileNameSpan.textContent = 'No file chosen';
                    document.getElementById('screenshot-preview').innerHTML = '<p>No image selected or preview not available.</p>';
                });
            }
            if (screenshotConfirmBtn) {
                screenshotConfirmBtn.addEventListener('click', () => {
                    screenshotModalEl.classList.remove('active');
                    screenshotModalEl.classList.add('hidden');
                    // File is already selected, user just confirmed preview
                });
            }

            if (quickDeposit) quickDeposit.addEventListener('click', () => navigateToPage('deposit'));
            if (quickWithdraw) quickWithdraw.addEventListener('click', () => navigateToPage('withdraw'));
            if (quickInvite) quickInvite.addEventListener('click', () => navigateToPage('team'));

            if (refreshBalance) refreshBalance.addEventListener('click', refreshUserBalance);

            if (deletePlanBtn) deletePlanBtn.addEventListener('click', () => deleteActivePlan(deletePlanBtn));

            initSlideshow();
            initPlanButtons();
            initTransactionButtons();
            initCopyButton();
            initRankingButton();
            initShareButtons();
            initAmountButtons();
            initContactForm();
            initHistoryFilters();
        }

        function showAuthForm(formToShow) {
            [registerFormEl, loginFormEl, resetFormEl, emailVerifyNotice].forEach(form => {
                if (form) form.classList.add('hidden');
            });
            if (formToShow) formToShow.classList.remove('hidden');

            const authOptions = document.getElementById('auth-options');
            if (formToShow === registerFormEl || formToShow === loginFormEl || formToShow === resetFormEl) {
                 if (authOptions) authOptions.classList.add('hidden');
            } else if (formToShow === null || formToShow === undefined) { // No form shown, means show options
                 if (authOptions) authOptions.classList.remove('hidden');
            }
            // emailVerifyNotice does not hide authOptions by default
        }

        function navigateToPage(pageName) {
            pages.forEach(p => p.classList.add('hidden'));
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) targetPage.classList.remove('hidden');
            else {
                console.error(`Page with ID ${pageName}-page not found.`);
                document.getElementById('home-page').classList.remove('hidden'); // Fallback to home
            }

            menuItems.forEach(item => item.classList.remove('active'));
            const activeMenuItem = document.querySelector(`.menu-item[data-page="${pageName}"]`);
            if (activeMenuItem) activeMenuItem.classList.add('active');

            sideMenu.classList.remove('active'); // Close menu on navigation

            // Specific page initializations
            if (pageName === 'team') initTeamPage();
            else if (pageName === 'plans') initPlansPage();
            else if (pageName === 'deposit') initDepositPage();
            else if (pageName === 'withdraw') initWithdrawPage();
            else if (pageName === 'earnings') initEarningsPage();
            else if (pageName === 'deposit-history') loadDepositHistory();
            else if (pageName === 'withdraw-history') loadWithdrawHistory();
        }

        function checkAuthState() {
            showLoading();
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    if (!user.emailVerified) {
                        showEmailVerificationNotice(user.email);
                        hideLoading();
                        return;
                    }
                    loadUserData(user.uid); // This will handle showing the app container
                    // Hide auth container elements explicitly after successful verification path
                    authContainer.classList.add('hidden');
                    document.getElementById('auth-options').classList.add('hidden');
                    emailVerifyNotice.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                } else {
                    currentUser = null;
                    userData = null;
                    authContainer.classList.remove('hidden');
                    document.getElementById('auth-options').classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    emailVerifyNotice.classList.add('hidden'); // Ensure verify notice is hidden on logout
                    showAuthForm(loginFormEl); // Show login form by default on logout
                    if (earningsInterval) clearInterval(earningsInterval);
                    earningsInterval = null;
                    hideLoading();
                }
            });
        }

        function showEmailVerificationNotice(email) {
            authContainer.classList.remove('hidden'); // Ensure auth container is visible
            [registerFormEl, loginFormEl, resetFormEl].forEach(form => {
                if(form) form.classList.add('hidden');
            });
            document.getElementById('auth-options').classList.add('hidden'); // Hide login/register buttons

            emailVerifyNotice.classList.remove('hidden');
            if (verifyEmailAddressEl) verifyEmailAddressEl.textContent = email;

            // Show continue button after a delay
            setTimeout(() => {
                if (verifyContinue) verifyContinue.classList.remove('hidden');
            }, 5000); // 5 seconds
        }

        function resendVerificationEmail() {
            if (!currentUser || !auth.currentUser) {
                showNotification('No user logged in to resend email.', 'error');
                return;
            }
            const resendBtnTextSpan = resendVerify.querySelector('.btn-text') || resendVerify;
            const originalText = resendBtnTextSpan.textContent;
            showLoadingButton(resendVerify, true, "Sending..."); // Assuming resendVerify can be a button

            auth.currentUser.sendEmailVerification()
                .then(() => showNotification('Verification email sent! Check your inbox and spam folder.', 'success'))
                .catch(error => showNotification(`Error sending email: ${error.message}`, 'error'))
                .finally(() => showLoadingButton(resendVerify, false, originalText));
        }

        function loadUserData(userId) {
            showLoading();
            database.ref('users/' + userId).on('value', snapshot => {
                userData = snapshot.val();
                if (userData) {
                    updateUI();
                    updateBonusStatusDisplay(); // For registration bonus
                    startEarningsCalculation(); // Recalculate/check earnings state
                    updateReferralMilestonesUI(); // Update referral UI after data load
                    // Show success notification only on initial login, not every data update
                    if (!authContainer.classList.contains('hidden') && appContainer.classList.contains('hidden')) {
                        // This implies it's the transition from auth to app
                         showNotification('Login successful!', 'success');
                         appContainer.classList.remove('hidden');
                         authContainer.classList.add('hidden'); // Explicitly hide auth container
                    }
                } else {
                    console.warn("User data not found for UID:", userId, "Logging out.");
                    logoutUser(); // If user data is missing, log out to prevent errors
                }
                hideLoading();
            }, error => {
                showNotification('Error loading user data: ' + error.message, 'error');
                logoutUser(); // Logout on critical data load error
                hideLoading();
            });
        }

        function refreshUserBalance() {
            if (!currentUser) return;
            const refreshIcon = refreshBalance.classList.contains('fa-sync-alt') ? refreshBalance : refreshBalance.querySelector('.fa-sync-alt');
            if (refreshIcon) refreshIcon.classList.add('fa-spin'); // Add spin animation

            database.ref('users/' + currentUser.uid).once('value')
                .then(snapshot => {
                    userData = snapshot.val(); // Update local userData
                    if (userData) {
                        updateUI(); // This will call updateBalanceDisplay
                        updateBonusStatusDisplay(); // For registration bonus
                        updateReferralMilestonesUI(); // Also update milestones
                        startEarningsCalculation(); // Re-evaluate earnings logic after refresh
                        showNotification('Balance refreshed!', 'success');
                    } else {
                        showNotification('Could not refresh data.', 'error');
                    }
                })
                .catch(error => showNotification('Error refreshing balance: ' + error.message, 'error'))
                .finally(() => {
                    if (refreshIcon) refreshIcon.classList.remove('fa-spin'); // Remove spin
                });
        }

        function updateUI() {
            if (!currentUser || !userData) return;

            document.getElementById('menu-username').textContent = userData.name || 'User';
            document.getElementById('menu-user-email').textContent = currentUser.email;
            document.getElementById('menu-user-img').src = userData.profileImage || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";

            updateBalanceDisplay(); // Centralized balance update

            const activePlanName = userData.activePlan ? `${getPlanName(userData.activePlan)} (${userData.activePlan} Rs)` : 'None';
            document.getElementById('active-plan').textContent = activePlanName;

            // Daily earnings display based on 25% if plan is active and not cancelled
            const dailyEarningsVal = (userData.activePlan && !userData.planCancelledDate) ? (userData.activePlan * 0.25) : 0;
            document.getElementById('daily-earnings').textContent = `${dailyEarningsVal.toFixed(2)} Rs`;

            document.getElementById('invite-code').value = userData.inviteCode || currentUser.uid.slice(0, 8).toUpperCase();

            const referralsCount = userData.investingReferralsCount || 0;
            const referralEarningsTotal = userData.referralCommissionTotal || 0;
            document.getElementById('total-referrals').textContent = referralsCount;
            document.getElementById('referral-earnings').textContent = `${referralEarningsTotal.toFixed(2)} Rs`;
            document.getElementById('referral-user-level-display').textContent = userData.referralLevel || "Starter";

            const today = new Date().toISOString().split('T')[0];
            let todayReferralCommission = 0;
            if (userData.referralHistory) {
                Object.values(userData.referralHistory).forEach(entry => {
                    // Ensure entry.date is a string and valid before calling startsWith
                    if (entry.type === 'commission' && typeof entry.date === 'string' && entry.date.startsWith(today)) {
                        todayReferralCommission += entry.amount || 0;
                    }
                });
            }
            document.getElementById('today-referral-earnings').textContent = `${todayReferralCommission.toFixed(2)} Rs`;

            // User rank - Assuming rank is directly stored or calculated elsewhere
            const rankDisplay = document.getElementById('user-rank-badge').querySelector('span');
            if (rankDisplay) rankDisplay.textContent = `#${userData.rank || 'N/A'}`;

            let level = "Standard"; // Default level
            if (userData.activePlan >= 8400) level = "Diamond Investor";
            else if (userData.activePlan >= 5600) level = "Platinum Investor";
            else if (userData.activePlan >= 2800) level = "Gold Investor";
            else if (userData.activePlan >= 1400) level = "Silver Investor";
            else if (userData.activePlan >= 550) level = "Basic Investor";
            document.getElementById('user-level-badge').textContent = level;

            showActivePlanManagement(); // Update active plan management UI

            // Ensure current page specific UI is updated if necessary
            const currentPageId = document.querySelector('.page:not(.hidden)')?.id;
            if (currentPageId) {
                const pageName = currentPageId.replace('-page', '');
                if (pageName === 'plans') initPlansPage();
                else if (pageName === 'withdraw') initWithdrawPage();
                // Add other pages that need UI refresh on data change
            }
        }

        function updateBonusStatusDisplay() {
            const bonusContainer = document.getElementById('bonus-status-container');
            const bonusMessage = document.getElementById('bonus-status-message');
            const bonusIcon = document.getElementById('bonus-status-icon');

            if (!bonusContainer || !bonusMessage || !bonusIcon || !userData || !userData.registrationBonus) {
                if(bonusContainer) bonusContainer.classList.add('hidden');
                return;
            }

            const bonus = userData.registrationBonus;
            bonusContainer.classList.remove('hidden');
            bonusIcon.className = 'fas'; // Reset icon classes

            if (bonus.status === 'pending') {
                bonusMessage.textContent = `Activate any plan to unlock and credit your ${bonus.amount} PKR registration bonus to your earnings!`;
                bonusIcon.classList.add('fa-gift', 'fa-beat');
                bonusIcon.style.color = 'var(--warning-color)';
                bonusContainer.style.borderColor = 'var(--warning-color)';
            } else if (bonus.status === 'credited') {
                bonusMessage.textContent = `Your ${bonus.amount} PKR registration bonus has been credited to your earnings!`;
                bonusIcon.classList.add('fa-check-circle');
                bonusIcon.style.color = 'var(--success-color)';
                bonusContainer.style.borderColor = 'var(--success-color)';
            } else {
                bonusContainer.classList.add('hidden'); // Hide if status is unknown
            }
        }


        function getPlanName(amount) {
            amount = parseInt(amount); // Ensure amount is number
            if (amount === 550) return "Basic Plan";
            if (amount === 1400) return "Silver Plan";
            if (amount === 2800) return "Gold Plan";
            if (amount === 5600) return "Platinum Plan";
            if (amount === 8400) return "Diamond Plan";
            return "Custom Plan";
        }

        function updateBalanceDisplay() {
            if (!userData) return;
            const currentBalance = userData.balance || 0;
            // Earnings now represent accumulated, withdrawable funds (plan earnings, commissions, milestone rewards, credited registration bonus)
            const currentEarnings = userData.earnings || 0;
            const totalAvailable = currentBalance + currentEarnings; // Total withdrawable is sum of general balance and earnings

            document.getElementById('user-balance').textContent = `${totalAvailable.toFixed(2)} Rs`;
            document.getElementById('total-balance').textContent = `${totalAvailable.toFixed(2)} Rs`; // Home page stat

            const withdrawAvailEl = document.getElementById('withdraw-available-balance');
            if (withdrawAvailEl) withdrawAvailEl.textContent = `${totalAvailable.toFixed(2)} Rs`;
        }

        function registerUser() {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            const phone = document.getElementById('reg-phone').value.trim();
            const referredByInviteCode = document.getElementById('reg-invite').value.trim();
            const termsAccepted = document.getElementById('reg-terms').checked;

            if (!name || !email || !password || !confirmPassword || !phone) {
                showNotification('Please fill all required fields.', 'error'); return;
            }
            if (!validateEmail(email)) {
                showNotification('Invalid email address.', 'error'); return;
            }
            if (password !== confirmPassword) {
                showNotification('Passwords do not match.', 'error'); return;
            }
            if (password.length < 8 || !validatePassword(password)) {
                showNotification('Password: 8+ chars, upper, lower, num, special.', 'error'); return;
            }
            const phoneRegex = /^03\d{9}$/;
            if (!phoneRegex.test(phone)) {
                showNotification('Invalid phone: 11 digits, start with 03.', 'error'); return;
            }
            if (!termsAccepted) {
                showNotification('Please accept the Terms & Conditions.', 'error'); return;
            }

            showLoadingButton(submitRegister, true);

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Send verification email first
                    return userCredential.user.sendEmailVerification().then(() => userCredential.user);
                })
                .then(user => {
                    const newUserData = {
                        name: name, email: email, phone: phone,
                        balance: 0,
                        earnings: 0,
                        activePlan: null,
                        originalPlanAmount: null, // For principal return logic
                        planStartDate: null,
                        originalPlanEndDate: null, // For principal return logic
                        planCancelledDate: null, // New field
                        principalReturned: false, // New field
                        lastEarningsUpdate: null,
                        hasPurchasedFirstPlan: false,
                        inviteCode: generateInviteCode(),
                        referredByInviteCode: referredByInviteCode || null,
                        referredByUid: null,
                        registrationDate: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        rank: "New",
                        investingReferralsCount: 0,
                        referralCommissionTotal: 0,
                        referralLevel: "Starter",
                        achievedMilestones: {},
                        registrationBonus: {
                            amount: 250, // Standard bonus amount
                            status: 'pending', // 'pending', 'credited'
                            awardedDate: null // Will be set when credited
                        },
                        firstWithdrawalMade: false
                    };

                    return database.ref('users/' + user.uid).set(newUserData)
                        .then(() => {
                            if (referredByInviteCode) {
                                return linkReferrer(user.uid, referredByInviteCode, name);
                            }
                            return Promise.resolve();
                        })
                        .then(() => {
                            showEmailVerificationNotice(email);
                            showNotification('Registration successful! Please verify your email to login.', 'success');
                        });
                })
                .catch(error => {
                    if (error.code === 'auth/email-already-in-use') {
                        showNotification('This email is already registered. Please login or use a different email.', 'error');
                    } else {
                        showNotification(error.message, 'error');
                    }
                })
                .finally(() => showLoadingButton(submitRegister, false, "Register"));
        }

        async function linkReferrer(newUserId, referrerInviteCode, newUserName) {
            if (!referrerInviteCode) return;
            try {
                const snapshot = await database.ref('users').orderByChild('inviteCode').equalTo(referrerInviteCode).once('value');
                if (snapshot.exists()) {
                    const referrerUid = Object.keys(snapshot.val())[0];
                    await database.ref(`users/${newUserId}/referredByUid`).set(referrerUid);
                    // Add to referrer's list for their own tracking (optional detail)
                    await database.ref(`users/${referrerUid}/referralsList/${newUserId}`).set({
                        name: newUserName,
                        email: document.getElementById('reg-email').value, // Get email from form
                        date: new Date().toISOString(),
                        status: "registered" // Initial status
                    });
                    console.log(`User ${newUserId} linked to referrer ${referrerUid}`);
                } else {
                    console.warn("Referrer with invite code not found:", referrerInviteCode);
                    await database.ref(`users/${newUserId}/referredByInviteCode`).set(null); // Clear if invalid
                }
            } catch (error) {
                console.error("Error linking referrer:", error);
            }
        }


        function generateInviteCode() {
            return 'VT' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase());
        }
        function validatePassword(password) {
            // At least 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special char
            return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&._-])[A-Za-z\d@$!%*?&._-]{8,}$/.test(password);
        }

        function checkPasswordStrength() {
            const password = document.getElementById('reg-password').value;
            const strengthBars = document.querySelectorAll('#register-form .strength-bar');
            const strengthText = document.querySelector('#register-form .strength-text');

            let score = 0;
            if (!password) {
                strengthBars.forEach(bar => bar.className = 'strength-bar'); // Reset class
                strengthText.textContent = '';
                return;
            }

            if (password.length >= 8) score++;
            if (password.length >= 10) score++; // Bonus for longer
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[@$!%*?&._-]/.test(password)) score++; // Expanded special chars

            strengthBars.forEach(bar => bar.className = 'strength-bar'); // Reset classes

            if (score <= 2) {
                strengthBars[0].classList.add('weak');
                strengthText.textContent = 'Weak'; strengthText.style.color = 'var(--danger-color)';
            } else if (score <= 4) {
                strengthBars[0].classList.add('medium');
                strengthBars[1].classList.add('medium');
                strengthText.textContent = 'Medium'; strengthText.style.color = 'var(--warning-color)';
            } else {
                strengthBars.forEach(bar => bar.classList.add('strong'));
                strengthText.textContent = 'Strong'; strengthText.style.color = 'var(--success-color)';
            }
        }

        function loginUser() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            if (!email || !password) { showNotification('Please fill all fields.', 'error'); return; }
            showLoadingButton(submitLogin, true);
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // checkAuthState will handle the rest if email is verified
                    // If not verified, checkAuthState will show the verification notice
                    // Update lastLogin after successful sign-in attempt, before full data load
                    return database.ref('users/' + userCredential.user.uid).update({ lastLogin: new Date().toISOString() });
                })
                .catch(error => {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        showNotification('Invalid email or password.', 'error');
                    } else {
                        showNotification(error.message, 'error');
                    }
                })
                .finally(() => showLoadingButton(submitLogin, false, "Login"));
        }

        function resetUserPassword() {
            const email = document.getElementById('reset-email').value.trim();
            if (!email || !validateEmail(email)) { showNotification('Please enter a valid email.', 'error'); return; }
            showLoadingButton(submitReset, true);
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showNotification('Password reset email sent! Check your inbox.', 'success');
                    showAuthForm(loginFormEl); // Switch back to login form
                })
                .catch(error => showNotification(error.message, 'error'))
                .finally(() => showLoadingButton(submitReset, false, "Send Reset Link"));
        }

        function logoutUser() {
            showLoading();
            auth.signOut()
                .then(() => {
                    // checkAuthState will be triggered and handle UI update to login screen
                    console.log("User logged out.");
                })
                .catch(error => showNotification(error.message, 'error'))
                .finally(() => {
                    // Ensure loading is hidden even if checkAuthState is slow or fails
                     hideLoading();
                });
        }

        function showLoadingButton(buttonElement, isLoading, defaultText = "Submit") {
            const btnText = buttonElement.querySelector('.btn-text');
            const btnLoader = buttonElement.querySelector('.btn-loader');

            // For elements like resendVerify which might not have .btn-text/.btn-loader
            let targetTextElement = btnText || buttonElement;

            if (isLoading) {
                if(btnText) btnText.classList.add('hidden');
                else targetTextElement.dataset.originalText = targetTextElement.textContent; // Store original for non-structured buttons

                if(btnLoader) btnLoader.classList.remove('hidden');
                else targetTextElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Simple loader for others

                buttonElement.disabled = true;
            } else {
                if(btnText) {
                    btnText.classList.remove('hidden');
                    btnText.textContent = defaultText;
                } else {
                    targetTextElement.textContent = targetTextElement.dataset.originalText || defaultText;
                }

                if(btnLoader) btnLoader.classList.add('hidden');
                buttonElement.disabled = false;
            }
        }

        function showNotification(message, type, duration = 4000) { // Added duration parameter
            const notification = document.createElement('div');
            notification.className = `notification ${type} animate__animated`;
            let iconClass;
            switch (type) {
                case 'success': iconClass = 'fa-check-circle'; break;
                case 'error': iconClass = 'fa-times-circle'; break;
                case 'warning': iconClass = 'fa-exclamation-triangle'; break;
                case 'info': iconClass = 'fa-info-circle'; break;
                default: iconClass = 'fa-bell';
            }
            notification.innerHTML = `<i class="fas ${iconClass}"></i><span>${message}</span>`;
            notificationContainer.appendChild(notification);

            // Auto-remove after duration
            setTimeout(() => {
                notification.classList.add('fade-out'); // Add class to trigger fadeOut animation
                // Remove from DOM after fadeOut animation completes
                notification.addEventListener('animationend', () => {
                    if (notification.classList.contains('fade-out')) {
                        notification.remove();
                    }
                });
            }, duration - 500); // Start fadeOut 0.5s before total duration
        }


        function showLoading() { if (loadingOverlay) loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { if (loadingOverlay) loadingOverlay.classList.add('hidden'); }

        let slideIndex = 1;
        let slideshowTimeout;
        function initSlideshow() {
            if (document.getElementsByClassName("slide").length > 0) {
                showSlides(slideIndex);
            }
        }
        function plusSlides(n) { clearTimeout(slideshowTimeout); showSlides(slideIndex += n); }
        function currentSlide(n) { clearTimeout(slideshowTimeout); showSlides(slideIndex = n); }
        function showSlides(n) {
            const slides = document.getElementsByClassName("slide");
            const dots = document.getElementsByClassName("dot");
            if (slides.length === 0) return; // No slides to show

            if (n > slides.length) slideIndex = 1;
            if (n < 1) slideIndex = slides.length;
            for (let i = 0; i < slides.length; i++) slides[i].style.display = "none";
            for (let i = 0; i < dots.length; i++) dots[i].className = dots[i].className.replace(" active-dot", "");

            slides[slideIndex-1].style.display = "block";
            if (dots.length >= slideIndex) { // Check if dot exists
                 dots[slideIndex-1].className += " active-dot";
            }
            slideshowTimeout = setTimeout(() => plusSlides(1), 5000); // Auto slide
        }

        function initPlanButtons() {
            document.querySelectorAll('.buy-plan-btn').forEach(button => {
                button.addEventListener('click', function() {
                    purchasePlan(parseInt(this.dataset.plan), this);
                });
            });
        }

        function initPlansPage() {
             // Update button states based on whether user has an active plan OR a cancelled plan whose term isn't over
            if (userData && (userData.activePlan || (userData.planCancelledDate && !userData.principalReturned))) {
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = true;
                    const btnText = btn.querySelector('.btn-text');
                    let message = "Plan Active";
                    if (userData.planCancelledDate && !userData.principalReturned) {
                        message = "Plan Cancelled";
                    }
                    if (btnText) btnText.textContent = message;
                    else btn.textContent = message;
                });
            } else { // No active plan, and no pending principal return from a cancelled one
                document.querySelectorAll('.buy-plan-btn').forEach(btn => {
                    btn.disabled = false;
                    const btnText = btn.querySelector('.btn-text');
                    if (btnText) btnText.textContent = "Buy Now";
                    else btn.textContent = "Buy Now";
                });
            }
        }

        async function purchasePlan(planAmount, buttonElement) {
            if (!currentUser || !userData) {
                showNotification('Please login to purchase a plan.', 'error'); return;
            }
            // Use combined balance for purchase
            const totalAvailableForPurchase = (userData.balance || 0) + (userData.earnings || 0);
            if (totalAvailableForPurchase < planAmount) {
                showNotification('Insufficient balance. Please deposit funds.', 'error'); return;
            }
             // Check if there's an active plan OR if a plan was cancelled but its term isn't over yet (principal not yet returned)
            if (userData.activePlan || (userData.planCancelledDate && !userData.principalReturned)) {
                showNotification('You currently have a plan processing (active or awaiting principal return). You can purchase a new plan once the current one fully concludes.', 'error', 6000); return;
            }

            showConfirmationModal(
                `Confirm Plan Purchase`,
                `Purchase ${getPlanName(planAmount)} for ${planAmount} Rs? You'll earn 25% daily for 30 days.`,
                async () => {
                    showLoadingButton(buttonElement, true);
                    let newEarnings = userData.earnings || 0;
                    let newBalance = userData.balance || 0;
                    let amountFromEarnings = 0, amountFromBalance = 0;
                    let bonusCreditedThisTime = false;
                    let bonusAmountToCredit = 0;

                    // Prioritize deducting from earnings, then balance for plan cost
                    if (newEarnings >= planAmount) {
                        amountFromEarnings = planAmount;
                        newEarnings -= planAmount;
                    } else {
                        amountFromEarnings = newEarnings;
                        const remainingToDeduct = planAmount - newEarnings;
                        newEarnings = 0;
                        amountFromBalance = remainingToDeduct;
                        newBalance -= remainingToDeduct;
                    }

                    const planStartDateObj = new Date();
                    const originalPlanEndDateObj = new Date(planStartDateObj);
                    originalPlanEndDateObj.setDate(originalPlanEndDateObj.getDate() + 30);

                    const updates = {
                        balance: newBalance,
                        earnings: newEarnings,
                        activePlan: planAmount,
                        originalPlanAmount: planAmount,
                        planStartDate: planStartDateObj.toISOString(),
                        originalPlanEndDate: originalPlanEndDateObj.toISOString(),
                        planCancelledDate: null, // Explicitly reset
                        principalReturned: false, // Explicitly reset
                        lastEarningsUpdate: planStartDateObj.toISOString(),
                        hasPurchasedFirstPlan: userData.hasPurchasedFirstPlan || false // Preserve existing, or set if first time
                    };

                    if (!userData.hasPurchasedFirstPlan && userData.registrationBonus && userData.registrationBonus.status === 'pending') {
                        bonusAmountToCredit = userData.registrationBonus.amount;
                        updates.earnings += bonusAmountToCredit;
                        updates.registrationBonus = {
                            ...userData.registrationBonus,
                            status: 'credited',
                            awardedDate: new Date().toISOString()
                        };
                        updates.hasPurchasedFirstPlan = true; // Set it true here
                        bonusCreditedThisTime = true;
                    }


                    try {
                        await database.ref('users/' + currentUser.uid).update(updates);

                        const logEntry = {
                            type: 'plan_purchase',
                            amount: planAmount,
                            planName: getPlanName(planAmount),
                            date: new Date().toISOString(),
                            deductedFromBalance: amountFromBalance,
                            deductedFromEarnings: amountFromEarnings
                        };
                        await database.ref(`users/${currentUser.uid}/transactions`).push(logEntry);

                        if (bonusCreditedThisTime) {
                            await database.ref(`users/${currentUser.uid}/transactions`).push({
                                type: 'bonus_credit',
                                amount: bonusAmountToCredit,
                                description: 'Registration Bonus Credited',
                                date: new Date().toISOString()
                            });
                            showNotification(`Your ${bonusAmountToCredit} PKR registration bonus has been credited to your earnings!`, 'success', 7000);
                        }

                        if (userData.referredByUid && !userData.hasPurchasedFirstPlan) { // Award commission only on first purchase by referred user
                            await awardReferralCommission(userData.referredByUid, planAmount, currentUser.uid, userData.name);
                        }

                        showNotification(`${getPlanName(planAmount)} purchased! Daily earnings: ${(planAmount * 0.25).toFixed(2)} Rs.`, 'success');

                        refreshUserBalance(); // Explicitly refresh data to reflect all changes
                    } catch (error) {
                        showNotification(`Purchase error: ${error.message}`, 'error');
                        refreshUserBalance();
                    } finally {
                        showLoadingButton(buttonElement, false, "Buy Now");
                    }
                }, 'success'
            );
        }

        async function awardReferralCommission(referrerUid, planAmount, referredUserId, referredUserName) {
            const commissionRateSnapshot = await database.ref('admin/referralSettings/commissionRate').once('value');
            const commissionRate = commissionRateSnapshot.exists() ? commissionRateSnapshot.val() : 0.25;
            const commissionAmount = planAmount * commissionRate;

            const referrerRef = database.ref(`users/${referrerUid}`);
            const referrerSnapshot = await referrerRef.once('value');
            if (!referrerSnapshot.exists()) {
                console.error("Referrer not found:", referrerUid);
                return;
            }
            const referrerData = referrerSnapshot.val();

            const updates = {
                earnings: (referrerData.earnings || 0) + commissionAmount,
                referralCommissionTotal: (referrerData.referralCommissionTotal || 0) + commissionAmount,
                investingReferralsCount: (referrerData.investingReferralsCount || 0) + 1
            };
             await database.ref(`users/${referrerUid}/referralsList/${referredUserId}/status`).set("invested");


            await referrerRef.update(updates);

            await database.ref(`users/${referrerUid}/referralHistory`).push({
                type: 'commission',
                amount: commissionAmount,
                referredUserId: referredUserId,
                referredUserName: referredUserName,
                planPurchased: planAmount,
                date: new Date().toISOString(),
                status: 'credited'
            });

            await checkAndApplyReferralMilestones(referrerUid);

            console.log(`Commission of ${commissionAmount.toFixed(2)} Rs awarded to referrer ${referrerUid}`);
        }

        async function checkAndApplyReferralMilestones(referrerUid) {
            const referrerRef = database.ref(`users/${referrerUid}`);
            const snapshot = await referrerRef.once('value');
            if (!snapshot.exists()) return;

            const referrerData = snapshot.val();
            const currentInvestingReferrals = referrerData.investingReferralsCount || 0;
            let newLevel = referrerData.referralLevel || "Starter";
            let milestoneRewardApplied = false;

            for (const milestone of referralMilestonesConfig) {
                if (currentInvestingReferrals >= milestone.requiredReferrals &&
                    !(referrerData.achievedMilestones && referrerData.achievedMilestones[milestone.id + '_rewarded'])) {

                    const updates = {
                        earnings: (referrerData.earnings || 0) + milestone.rewardAmount, // Add to withdrawable earnings
                        referralLevel: milestone.name, // Update referral level display name
                        [`achievedMilestones/${milestone.id}_rewarded`]: true // Mark as rewarded
                    };
                    await referrerRef.update(updates);
                    newLevel = milestone.name; // For subsequent checks in this loop if any

                    await database.ref(`users/${referrerUid}/referralHistory`).push({
                        type: 'milestone_reward',
                        amount: milestone.rewardAmount,
                        milestoneName: milestone.name,
                        date: new Date().toISOString(),
                        status: 'credited'
                    });
                    milestoneRewardApplied = true;
                    if (currentUser && currentUser.uid === referrerUid) {
                         showNotification(`Congratulations! You've reached ${milestone.name} & earned ${milestone.rewardAmount} Rs!`, 'success');
                    }
                }
            }
             if (milestoneRewardApplied && currentUser && currentUser.uid === referrerUid) {
                refreshUserBalance();
            }
        }


        function startEarningsCalculation() {
            if (earningsInterval) clearInterval(earningsInterval);

            if (!currentUser || !userData || !userData.planStartDate) {
                 console.log("Earnings calculation not started: No plan start date or user data.");
                return;
            }

            const now = new Date();
            const originalPlanEndDate = userData.originalPlanEndDate ? new Date(userData.originalPlanEndDate) : null;
            const originalPlanAmount = userData.originalPlanAmount || 0;

            // 1. Check for Principal Return (if plan term is over and principal not yet returned)
            if (originalPlanEndDate && now > originalPlanEndDate && !userData.principalReturned && originalPlanAmount > 0) {
                const updates = {
                    balance: (userData.balance || 0) + originalPlanAmount,
                    principalReturned: true,
                    // Optionally clear plan-specific fields now that it's fully concluded
                    // activePlan: null, planStartDate: null, originalPlanEndDate: null, originalPlanAmount: null, planCancelledDate: null
                    // For simplicity, let's keep them for record unless they cause issues.
                    // activePlan would already be null if it was cancelled. If it ran its term, it might still hold the value.
                    activePlan: null // Ensure activePlan is null after principal return
                };
                database.ref('users/' + currentUser.uid).update(updates)
                    .then(() => {
                        database.ref(`users/${currentUser.uid}/transactions`).push({
                            type: 'plan_completion', amount: originalPlanAmount,
                            description: `Principal for ${getPlanName(originalPlanAmount)} plan returned.`,
                            date: now.toISOString()
                        });
                        showNotification(`Your ${getPlanName(originalPlanAmount)} plan has completed! ${originalPlanAmount} Rs principal returned.`, 'success');
                        refreshUserBalance(); // Refresh data and UI
                    }).catch(err => console.error("Error finalizing plan completion:", err));
                return; // Stop further processing for this cycle if principal was just returned
            }

            // 2. Check if earnings should accrue (plan active, not cancelled, term not over)
            if (userData.activePlan && !userData.planCancelledDate && originalPlanEndDate && now <= originalPlanEndDate) {
                const planAmount = userData.activePlan; // This is the current active plan amount
                const lastUpdate = userData.lastEarningsUpdate ? new Date(userData.lastEarningsUpdate) : new Date(userData.planStartDate);
                const hoursPassedSinceLastUpdate = Math.max(0, (now - lastUpdate) / (1000 * 60 * 60));
                const hourlyEarningsRate = (planAmount * 0.25) / 24; // 25% daily

                // Catch-up for missed earnings
                if (hoursPassedSinceLastUpdate >= 1) {
                    const missedEarnings = hourlyEarningsRate * Math.floor(hoursPassedSinceLastUpdate);
                    if (missedEarnings > 0.01) {
                        const earningsUpdate = {
                            earnings: (userData.earnings || 0) + missedEarnings,
                            lastEarningsUpdate: now.toISOString()
                        };
                        database.ref(`users/${currentUser.uid}/earningsHistory`).push({
                            type: 'investment_earning', amount: missedEarnings, plan: planAmount,
                            date: now.toISOString(), description: `Hourly earnings catch-up`
                        });
                        database.ref('users/' + currentUser.uid).update(earningsUpdate)
                            .then(() => {
                                console.log("Missed earnings updated.");
                                // Manually update local userData for immediate UI reflection if needed, or rely on 'on' listener
                                userData.earnings = (userData.earnings || 0) + missedEarnings;
                                userData.lastEarningsUpdate = now.toISOString();
                                updateBalanceDisplay();
                            })
                            .catch(err => console.error("Error updating missed earnings:", err));
                    }
                }

                // Regular hourly interval for future earnings
                earningsInterval = setInterval(() => {
                    // Re-check conditions inside interval as userData might change due to cancellation or data refresh
                    if (!currentUser || !userData || !userData.activePlan || userData.planCancelledDate) {
                        clearInterval(earningsInterval);
                        console.log("Earnings interval cleared: Plan no longer active or cancelled.");
                        return;
                    }

                    const currentIntervalNow = new Date();
                    const currentOriginalPlanEndDate = userData.originalPlanEndDate ? new Date(userData.originalPlanEndDate) : null;

                    if (currentOriginalPlanEndDate && currentIntervalNow > currentOriginalPlanEndDate) {
                        clearInterval(earningsInterval);
                        console.log("Plan term ended during interval. Principal return will be handled by main check.");
                        // Trigger a refresh to ensure the main startEarningsCalculation logic runs for principal return.
                        refreshUserBalance();
                        return;
                    }

                    const currentActivePlanAmount = userData.activePlan;
                    const currentHourlyRate = (currentActivePlanAmount * 0.25) / 24;
                    const updateData = {
                        earnings: (userData.earnings || 0) + currentHourlyRate,
                        lastEarningsUpdate: currentIntervalNow.toISOString()
                    };

                    database.ref(`users/${currentUser.uid}/earningsHistory`).push({
                        type: 'investment_earning', amount: currentHourlyRate, plan: currentActivePlanAmount,
                        date: currentIntervalNow.toISOString(), description: `Regular hourly earning`
                    });

                    database.ref('users/' + currentUser.uid).update(updateData)
                        .catch(err => console.error("Error updating hourly earnings:", err));

                    // Update local userData for UI consistency
                     if(userData) {
                        userData.earnings = (userData.earnings || 0) + currentHourlyRate;
                        userData.lastEarningsUpdate = currentIntervalNow.toISOString();
                        updateBalanceDisplay();
                     }

                }, 3600000); // 1 hour
            } else if (userData.planCancelledDate) {
                console.log("Plan is cancelled. No earnings will accrue. Waiting for original term end for principal return.");
            } else {
                 console.log("No active plan eligible for earnings accrual at this time.");
            }
        }

        function showActivePlanManagement() {
            if (!activePlanManagementDiv || !manageActivePlanNameEl || !manageActivePlanEndDateEl) return;

            if (userData && userData.activePlan && !userData.planCancelledDate) {
                // Plan is active and not cancelled
                manageActivePlanNameEl.textContent = `${getPlanName(userData.activePlan)} (${userData.activePlan} Rs)`;
                manageActivePlanEndDateEl.textContent = userData.originalPlanEndDate ? formatDate(userData.originalPlanEndDate, false) : 'N/A';
                activePlanManagementDiv.classList.remove('hidden');
                deletePlanBtn.disabled = false;
                const btnText = deletePlanBtn.querySelector('.btn-text');
                if (btnText) btnText.textContent = "Cancel Current Plan";

            } else if (userData && userData.originalPlanAmount && userData.planCancelledDate && !userData.principalReturned) {
                // Plan was cancelled, principal not yet returned
                manageActivePlanNameEl.textContent = `${getPlanName(userData.originalPlanAmount)} (${userData.originalPlanAmount} Rs) - Cancelled`;
                manageActivePlanEndDateEl.textContent = `Principal returns on: ${userData.originalPlanEndDate ? formatDate(userData.originalPlanEndDate, false) : 'N/A'}`;
                activePlanManagementDiv.classList.remove('hidden');
                deletePlanBtn.disabled = true; // Cannot cancel an already cancelled plan
                 const btnText = deletePlanBtn.querySelector('.btn-text');
                if (btnText) btnText.textContent = "Plan Cancelled";
            } else {
                // No active plan, or plan fully concluded (principal returned)
                activePlanManagementDiv.classList.add('hidden');
            }
        }

        function deleteActivePlan(buttonElement) {
            if (!currentUser || !userData || !userData.activePlan) {
                showNotification('No active plan to cancel.', 'error'); return;
            }
             if (userData.planCancelledDate) {
                showNotification('This plan has already been cancelled.', 'info'); return;
            }

            showConfirmationModal(
                'Cancel Active Plan',
                `Are you sure you want to cancel your ${getPlanName(userData.activePlan)} plan? Future daily earnings will stop. Your principal of ${userData.activePlan} Rs will be returned at the original end date: ${formatDate(userData.originalPlanEndDate)}.`,
                async () => {
                    showLoadingButton(buttonElement, true);
                    const updates = {
                        activePlan: null, // Marks plan as no longer generating daily income
                        planCancelledDate: new Date().toISOString(),
                        lastEarningsUpdate: new Date().toISOString() // Record time earnings stopped
                        // originalPlanAmount, planStartDate, originalPlanEndDate, principalReturned remain for later processing
                    };

                    try {
                        await database.ref('users/' + currentUser.uid).update(updates);
                        if (earningsInterval) clearInterval(earningsInterval); // Stop earnings interval immediately

                        await database.ref(`users/${currentUser.uid}/transactions`).push({
                            type: 'plan_cancellation',
                            amount: userData.activePlan, // The amount of the plan being cancelled
                            planName: getPlanName(userData.activePlan),
                            date: new Date().toISOString(),
                            description: 'User cancelled active plan.'
                        });

                        showNotification('Your active plan has been cancelled. Future earnings will stop.', 'success');
                        refreshUserBalance(); // Refresh data and UI
                    } catch (error) {
                        showNotification(`Error cancelling plan: ${error.message}`, 'error');
                    } finally {
                        showLoadingButton(buttonElement, false, "Cancel Current Plan");
                    }
                },
                'danger' // Modal type for cancellation
            );
        }


        function initTransactionButtons() {
            const depositButton = document.getElementById('submit-deposit');
            if (depositButton) depositButton.addEventListener('click', submitDepositRequest);
            const withdrawButton = document.getElementById('submit-withdraw');
            if (withdrawButton) withdrawButton.addEventListener('click', submitWithdrawalRequest);
        }

        function initDepositPage() {
            const methodCards = document.querySelectorAll('#deposit-page .method-card');
            methodCards.forEach(card => {
                card.addEventListener('click', function() {
                    methodCards.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    // Update account details based on selected method
                    // For now, only Easypaisa is hardcoded
                    if (this.dataset.method === 'easypaisa') {
                        document.getElementById('deposit-account-number').textContent = '03709912807';
                        document.getElementById('deposit-account-name').textContent = 'Memoona zohra';
                    }
                    // else if (this.dataset.method === 'jazzcash') { ... }
                });
            });
            // Click the default (Easypaisa) card on page load
            const easypaisaCard = document.querySelector('#deposit-page .method-card[data-method="easypaisa"]');
            if (easypaisaCard) easypaisaCard.click();
        }

        function submitDepositRequest() {
            const amountSelect = document.getElementById('deposit-amount');
            let amount = amountSelect.value === 'other' ?
                parseFloat(document.getElementById('custom-amount').value) :
                parseFloat(amountSelect.value);

            const transactionId = document.getElementById('deposit-transaction').value.trim();
            const senderNumber = document.getElementById('deposit-sender').value.trim();
            const method = document.querySelector('#deposit-page .method-card.active')?.dataset.method;

            if (!amount || isNaN(amount) || amount < 550) {
                showNotification('Invalid amount. Minimum deposit is 550 Rs.', 'error'); return;
            }
            if (!transactionId || !senderNumber || !method) {
                showNotification('Please fill all required fields.', 'error'); return;
            }
            if (!/^03\d{9}$/.test(senderNumber)) {
                showNotification('Sender mobile number must be 11 digits starting with 03.', 'error'); return;
            }

            const submitDepositBtn = document.getElementById('submit-deposit');
            showLoadingButton(submitDepositBtn, true);

            const depositData = {
                userId: currentUser.uid, userName: userData.name, userEmail: currentUser.email,
                amount: amount, method: method,
                transactionId: transactionId, senderNumber: senderNumber,
                date: new Date().toISOString(), status: 'pending', screenshotUrl: null // Placeholder for screenshot
            };

            const depositKey = database.ref(`users/${currentUser.uid}/deposits`).push().key;
            database.ref(`users/${currentUser.uid}/deposits/${depositKey}`).set({...depositData, id: depositKey})
            .then(() => {
                // Also add to an admin queue for approval
                return database.ref(`admin/pending_deposits/${depositKey}`).set({...depositData, userUid: currentUser.uid, depositId: depositKey });
            })
            .then(() => {
                showNotification('Deposit request submitted! Processing takes 5-15 mins.', 'success');
                document.getElementById('deposit-form-element').reset(); // Reset the form
                document.getElementById('custom-amount-container').classList.add('hidden');
                document.getElementById('file-name').textContent = 'No file chosen';
                document.getElementById('screenshot-preview').innerHTML = '<p>No image selected.</p>';
                if(document.getElementById('deposit-screenshot')) document.getElementById('deposit-screenshot').value = ''; // Clear file input
            })
            .catch(error => showNotification(`Deposit error: ${error.message}`, 'error'))
            .finally(() => showLoadingButton(submitDepositBtn, false, "Submit Deposit"));
        }

        function initWithdrawPage() {
            if (userData) updateBalanceDisplay(); // Ensure balance is current when page loads
        }
        function initAmountButtons() {
            const withdrawAmountInput = document.getElementById('withdraw-amount');
            document.querySelectorAll('#withdraw-page .amount-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent any default form action if inside a form
                    if(withdrawAmountInput) withdrawAmountInput.value = this.dataset.amount;
                });
            });
        }

        function submitWithdrawalRequest() {
            const method = document.getElementById('withdraw-method').value;
            const account = document.getElementById('withdraw-account').value.trim();
            const name = document.getElementById('withdraw-name').value.trim();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);

            if (!method || !account || !name || !amount || isNaN(amount)) {
                showNotification('Please fill all fields correctly.', 'error'); return;
            }
            if (!/^\d{11}$/.test(account)) { // Basic 11-digit validation
                showNotification('Account number must be 11 digits.', 'error'); return;
            }
            if (amount < 200 || amount > 20000) {
                showNotification('Withdrawal amount must be between 200 and 20,000 Rs.', 'error'); return;
            }

            // Withdraw from combined earnings and balance
            const totalAvailableBalance = (userData.balance || 0) + (userData.earnings || 0);
            if (amount > totalAvailableBalance) {
                showNotification('Insufficient funds for withdrawal.', 'error'); return;
            }

            const feeAmount = amount * 0.05; // 5% fee
            const netAmountToReceive = amount - feeAmount;

            const withdrawalData = {
                userId: currentUser.uid, userName: userData.name, userEmail: currentUser.email,
                method: method, account: account, name: name,
                requestedAmount: amount, fee: feeAmount, netAmount: netAmountToReceive,
                date: new Date().toISOString(), status: 'pending'
            };

            showConfirmationModal(
                'Confirm Withdrawal',
                `Withdraw ${amount.toFixed(2)} Rs to ${account} (${method})? Fee: ${feeAmount.toFixed(2)} Rs. You receive: ${netAmountToReceive.toFixed(2)} Rs.`,
                async () => { // Make callback async
                    const submitWithdrawBtn = document.getElementById('submit-withdraw');
                    showLoadingButton(submitWithdrawBtn, true);

                    let newEarnings = userData.earnings || 0;
                    let newBalance = userData.balance || 0;
                    let amountDeductedFromEarnings = 0;
                    let amountDeductedFromBalance = 0;

                    // Deduct from earnings first, then balance
                    if (newEarnings >= amount) {
                        amountDeductedFromEarnings = amount;
                        newEarnings -= amount;
                    } else {
                        amountDeductedFromEarnings = newEarnings;
                        const remainingToDeduct = amount - newEarnings;
                        newEarnings = 0;
                        amountDeductedFromBalance = remainingToDeduct;
                        newBalance -= remainingToDeduct;
                    }

                    try {
                        // Update earnings and balance first
                        await database.ref('users/' + currentUser.uid).update({ earnings: newEarnings, balance: newBalance });

                        // Then record the withdrawal request
                        const withdrawalKey = database.ref(`users/${currentUser.uid}/withdrawals`).push().key;
                        await database.ref(`users/${currentUser.uid}/withdrawals/${withdrawalKey}`).set({...withdrawalData, id: withdrawalKey});
                        await database.ref(`admin/pending_withdrawals/${withdrawalKey}`).set({...withdrawalData, userUid: currentUser.uid, withdrawalId: withdrawalKey });

                        if (!userData.firstWithdrawalMade) {
                            await database.ref('users/' + currentUser.uid).update({ firstWithdrawalMade: true });
                        }

                        showNotification('Withdrawal request submitted!', 'success');

                        document.getElementById('withdraw-form-element').reset();
                        refreshUserBalance();
                    } catch (error) {
                        showNotification(`Withdrawal error: ${error.message}`, 'error');
                        refreshUserBalance();
                    } finally {
                        showLoadingButton(submitWithdrawBtn, false, "Request Withdrawal");
                    }
                }, 'warning' // Modal type
            );
        }

        function initCopyButton() {
            const copyButton = document.getElementById('copy-invite');
            const inviteCodeInput = document.getElementById('invite-code');
            if (copyButton && inviteCodeInput) {
                copyButton.addEventListener('click', () => {
                    inviteCodeInput.select();
                    inviteCodeInput.setSelectionRange(0, 99999); // For mobile devices
                    try {
                        document.execCommand('copy');
                        showNotification('Invite code copied!', 'success');
                    } catch (err) {
                        // Fallback for browsers that don't support execCommand or if it fails
                        navigator.clipboard.writeText(inviteCodeInput.value)
                            .then(() => showNotification('Invite code copied!', 'success'))
                            .catch(() => showNotification('Failed to copy code.', 'error'));
                    }
                    window.getSelection().removeAllRanges(); // Deselect
                });
            }
        }
        function initShareButtons() {
            const inviteCodeEl = document.getElementById('invite-code');
            // Assuming the app is hosted at the root. Adjust if it's in a subdirectory.
            const baseAppUrl = window.location.origin + window.location.pathname.replace('index.html', '');

            document.querySelector('.share-btn.whatsapp')?.addEventListener('click', () => {
                const code = inviteCodeEl ? inviteCodeEl.value : (currentUser?.uid.slice(0,8).toUpperCase() || "DEMOCODE");
                const msg = `Join Video Treasure Pro with my invite code: ${code} and earn daily! Sign up: ${baseAppUrl}?ref=${code}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            });
            document.querySelector('.share-btn.facebook')?.addEventListener('click', () => {
                const code = inviteCodeEl ? inviteCodeEl.value : (currentUser?.uid.slice(0,8).toUpperCase() || "DEMOCODE");
                const link = `${baseAppUrl}?ref=${code}`;
                const msg = `Join Video Treasure Pro with my invite code: ${code} and start earning! Check out this awesome platform.`;
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}&quote=${encodeURIComponent(msg)}`, '_blank');
            });
            document.querySelector('.share-btn.copy-link')?.addEventListener('click', () => {
                const code = inviteCodeEl ? inviteCodeEl.value : (currentUser?.uid.slice(0,8).toUpperCase() || "DEMOCODE");
                const referralLink = `${baseAppUrl}?ref=${code}`;
                navigator.clipboard.writeText(referralLink)
                    .then(() => showNotification('Referral link copied!', 'success'))
                    .catch(() => showNotification('Failed to copy link.', 'error'));
            });
        }
        function initRankingButton() {
            const btn = document.getElementById('view-ranking-btn');
            const tableDiv = document.getElementById('ranking-table-container');
            if (btn && tableDiv) {
                btn.addEventListener('click', () => {
                    const isHidden = tableDiv.classList.contains('hidden');
                    if (isHidden) {
                        loadUserRankings();
                        tableDiv.classList.remove('hidden');
                        btn.innerHTML = `<i class="fas fa-eye-slash"></i> Hide Ranking`;
                    } else {
                        tableDiv.classList.add('hidden');
                        btn.innerHTML = `<i class="fas fa-list-ol"></i> View Full Ranking`;
                    }
                });
            }
        }

        function initTeamPage() {
            loadReferralHistory(); // Load commission history
            updateReferralMilestonesUI(); // Display current milestone status
        }

        function updateReferralMilestonesUI() {
            if (!milestonesListEl || !nextMilestoneInfoEl || !milestoneProgressBarEl || !userData || !referralMilestonesConfig) {
                 console.log("Skipping milestone UI update: missing elements or data.");
                 return;
            }

            milestonesListEl.innerHTML = ''; // Clear previous list
            const currentReferrals = userData.investingReferralsCount || 0;
            let nextMilestone = null;
            let achievedAll = true;
            let lastAchievedMilestoneReferrals = 0; // Referrals needed for the previously achieved/lower milestone

            referralMilestonesConfig.forEach(milestone => {
                const li = document.createElement('li');
                const isAchieved = userData.achievedMilestones && userData.achievedMilestones[milestone.id + '_rewarded'];

                let statusHtml = '';
                if (isAchieved) {
                    statusHtml = `<span class="status-completed">Achieved! +${milestone.rewardAmount} Rs</span>`;
                    lastAchievedMilestoneReferrals = milestone.requiredReferrals;
                } else {
                    achievedAll = false; // If any milestone is not achieved
                    const needed = milestone.requiredReferrals - currentReferrals;
                    if (needed > 0) {
                        statusHtml = `<span class="status-pending">${needed} more needed</span>`;
                    } else { // Current referrals >= required, but not yet marked as rewarded (should be auto-claimed by backend logic)
                        statusHtml = `<span class="status-pending">Pending claim...</span>`;
                    }
                    if (!nextMilestone) { // This is the next unachieved milestone
                        nextMilestone = milestone;
                    }
                }
                li.innerHTML = `<span>${milestone.name} (${milestone.requiredReferrals} Referrals)</span> ${statusHtml}`;
                milestonesListEl.appendChild(li);
            });

            if (achievedAll && referralMilestonesConfig.length > 0) {
                nextMilestoneInfoEl.textContent = "Congratulations! You've achieved all referral milestones!";
                milestoneProgressBarEl.style.width = '100%';
                milestoneProgressBarEl.textContent = '100%';
            } else if (nextMilestone) {
                // Find the milestone just before the nextMilestone for progress calculation
                let prevMilestoneReq = 0;
                for (let i = 0; i < referralMilestonesConfig.length; i++) {
                    if (referralMilestonesConfig[i].id === nextMilestone.id && i > 0) {
                        prevMilestoneReq = referralMilestonesConfig[i-1].requiredReferrals;
                        break;
                    }
                }

                const progressCurrentTierTotal = nextMilestone.requiredReferrals - prevMilestoneReq;
                const progressInCurrentTier = Math.max(0, currentReferrals - prevMilestoneReq);
                const percentage = progressCurrentTierTotal > 0
                                   ? Math.min(100, (progressInCurrentTier / progressCurrentTierTotal) * 100)
                                   : (currentReferrals >= nextMilestone.requiredReferrals ? 100 : 0);

                nextMilestoneInfoEl.textContent = `Next: ${nextMilestone.name} (${nextMilestone.requiredReferrals} Referrals for ${nextMilestone.rewardAmount} Rs reward)`;
                milestoneProgressBarEl.style.width = `${percentage.toFixed(0)}%`;
                milestoneProgressBarEl.textContent = `${percentage.toFixed(0)}%`;
            } else { // No milestones defined or other edge case
                 nextMilestoneInfoEl.textContent = "Start referring to unlock milestones!";
                 milestoneProgressBarEl.style.width = '0%';
                 milestoneProgressBarEl.textContent = '0%';
            }
        }


        function loadUserRankings() {
            showLoading();
            // Fetch users, order by activePlan (desc), then by total earnings (desc) as secondary sort.
            // Firebase RTDB doesn't support compound sorting directly on server.
            // We fetch ordered by primary key and sort client-side.
            database.ref('users').orderByChild('activePlan').limitToLast(50).once('value') // Get more to sort client-side
                .then(snapshot => {
                    const rankings = [];
                    snapshot.forEach(userSnapshot => {
                        const user = userSnapshot.val();
                        // Ensure user has a name and an active plan to be in ranking
                        if (user.name && user.activePlan && user.activePlan > 0) {
                            rankings.push({
                                id: userSnapshot.key,
                                name: user.name,
                                investment: user.activePlan,
                                // Consider total earnings from plan and referrals for ranking tie-breaking
                                earnings: (user.earnings || 0) + (user.referralCommissionTotal || 0)
                            });
                        }
                    });
                    // Sort: Primary by investment (desc), secondary by earnings (desc)
                    rankings.sort((a, b) => {
                        if (b.investment !== a.investment) {
                            return b.investment - a.investment;
                        }
                        return b.earnings - a.earnings;
                    });

                    const rankingBody = document.getElementById('ranking-body');
                    if (!rankingBody) { hideLoading(); return; } // Safety check
                    rankingBody.innerHTML = ''; // Clear previous entries

                    if (rankings.length === 0) {
                        rankingBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No active investors to rank.</td></tr>';
                    } else {
                        // Display top N (e.g., top 10 or 20)
                        rankings.slice(0, 20).forEach((user, index) => {
                            const row = document.createElement('tr');
                            if (currentUser && user.id === currentUser.uid) {
                                row.classList.add('current-user'); // Highlight current user
                            }
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${user.name}</td>
                                <td>${user.investment.toFixed(0)} Rs</td>
                                <td>${user.earnings.toFixed(2)} Rs</td>
                            `;
                            rankingBody.appendChild(row);
                        });
                    }
                })
                .catch(error => showNotification('Error loading rankings: ' + error.message, 'error'))
                .finally(() => hideLoading());
        }

        function loadDepositHistory() {
            const body = document.getElementById('deposit-history-body');
            if (!body) return;
            if (!currentUser || !userData || !userData.deposits) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No deposit history.</td></tr>';
                updateDepositSummary(0,0,0); return;
            }
            const filter = document.getElementById('deposit-filter')?.value || 'all';
            const arr = Object.values(userData.deposits);
            body.innerHTML = '';
            const filtered = arr.filter(d => filter === 'all' || d.status === filter)
                                .sort((a,b) => new Date(b.date) - new Date(a.date));
            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="5" style="text-align:center;">No deposits found for '${filter}'.</td></tr>`;
            } else {
                filtered.forEach(d => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${d.amount.toFixed(2)} Rs</td>
                        <td>${d.method || 'N/A'}</td>
                        <td>${formatDate(d.date)}</td>
                        <td><span class="status-${d.status}">${d.status}</span></td>
                        <td>${d.status === 'pending' ? `<span class="action-link" data-id="${d.id}" data-type="deposit">Cancel</span>` : (d.status === 'rejected' && d.adminNotes ? `<span title="${d.adminNotes}"><i class="fas fa-info-circle"></i></span>` : '--')}</td>
                    `;
                    body.appendChild(row);
                });
            }
            let sT=0, sP=0, sC=0;
            arr.forEach(d => { sT += d.amount; if(d.status==='completed')sC+=d.amount; if(d.status==='pending')sP+=d.amount; });
            updateDepositSummary(sT,sP,sC);
            attachCancelListeners(body, 'deposit');
        }
        function updateDepositSummary(total,pending,completed) {
            document.getElementById('total-deposits').textContent = `${total.toFixed(2)} Rs`;
            document.getElementById('pending-deposits').textContent = `${pending.toFixed(2)} Rs`;
            document.getElementById('completed-deposits').textContent = `${completed.toFixed(2)} Rs`;
        }

        function loadWithdrawHistory() {
            const body = document.getElementById('withdraw-history-body');
            if (!body) return;
            if (!currentUser || !userData || !userData.withdrawals) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No withdrawal history.</td></tr>';
                updateWithdrawalSummary(0,0,0); return;
            }
            const filter = document.getElementById('withdraw-filter')?.value || 'all';
            const arr = Object.values(userData.withdrawals);
            body.innerHTML = '';
            const filtered = arr.filter(w => filter === 'all' || w.status === filter)
                                .sort((a,b) => new Date(b.date) - new Date(a.date));
            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="5" style="text-align:center;">No withdrawals found for '${filter}'.</td></tr>`;
            } else {
                filtered.forEach(w => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${w.requestedAmount.toFixed(2)} Rs</td>
                        <td>${w.method || 'N/A'} (${w.account})</td>
                        <td>${formatDate(w.date)}</td>
                        <td><span class="status-${w.status}">${w.status}</span></td>
                        <td>${w.status === 'pending' ? `<span class="action-link" data-id="${w.id}" data-type="withdrawal" data-amount="${w.requestedAmount}">Cancel</span>` : (w.status === 'rejected' && w.adminNotes ? `<span title="${w.adminNotes}"><i class="fas fa-info-circle"></i></span>` : '--')}</td>
                    `;
                    body.appendChild(row);
                });
            }
            let sT=0, sP=0, sC=0;
            arr.forEach(w => { sT += w.requestedAmount; if(w.status==='completed')sC+=w.requestedAmount; if(w.status==='pending')sP+=w.requestedAmount; });
            updateWithdrawalSummary(sT,sP,sC);
            attachCancelListeners(body, 'withdrawal');
        }
        function updateWithdrawalSummary(total,pending,completed) {
            document.getElementById('total-withdrawals').textContent = `${total.toFixed(2)} Rs`;
            document.getElementById('pending-withdrawals').textContent = `${pending.toFixed(2)} Rs`;
            document.getElementById('completed-withdrawals').textContent = `${completed.toFixed(2)} Rs`;
        }
        function attachCancelListeners(tableBody, type) {
            tableBody.querySelectorAll('.action-link[data-type="' + type + '"]').forEach(link => {
                // Remove old listener if any to prevent multiple fires
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);
                newLink.addEventListener('click', function() {
                    cancelTransaction(this.dataset.id, type, parseFloat(this.dataset.amount) || 0);
                });
            });
        }
        function cancelTransaction(id, type, amountToRefund = 0) {
            const CType = type.charAt(0).toUpperCase() + type.slice(1);
            showConfirmationModal(
                `Cancel ${CType}`,
                `Are you sure you want to cancel this ${type} request? ${type==='withdrawal' && amountToRefund > 0 ?'The amount will be refunded to your earnings balance.':''}`,
                async () => { // Make callback async
                    showLoading();
                    const userTransactionPath = `users/${currentUser.uid}/${type}s/${id}`;
                    const adminQueuePath = `admin/pending_${type}s/${id}`; // Path in admin queue

                    try {
                        await database.ref(userTransactionPath).update({ status: 'cancelled', cancelledBy: 'user' });
                        // Update status in admin queue as well, or remove it. For simplicity, update status.
                        await database.ref(adminQueuePath).update({ status: 'cancelled_by_user' });

                        if (type === 'withdrawal' && amountToRefund > 0) {
                            // Refund to earnings as it's the main source of withdrawable funds
                            await database.ref(`users/${currentUser.uid}`).update({
                                earnings: (userData.earnings || 0) + amountToRefund
                            });
                        }
                        showNotification(`${CType} request cancelled successfully.`, 'success');
                        // Refresh history and balance
                        if(type === 'deposit') loadDepositHistory();
                        else loadWithdrawHistory();
                        refreshUserBalance(); // This will re-fetch data and update UI
                    } catch (error) {
                         showNotification(`Error cancelling ${type}: ${error.message}`, 'error');
                    } finally {
                        hideLoading();
                    }
                }, 'warning'
            );
        }

        function loadReferralHistory() {
            const body = document.getElementById('referral-body');
            if (!body) return;
            if (!currentUser || !userData || !userData.referralHistory) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No referral commission history.</td></tr>';
                return;
            }
            // Filter only for 'commission' type entries for this specific table
            const commissionEntries = Object.values(userData.referralHistory)
                                          .filter(entry => entry.type === 'commission')
                                          .sort((a, b) => new Date(b.date) - new Date(a.date));
            body.innerHTML = '';
            if (commissionEntries.length === 0) {
                 body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No commissions earned yet.</td></tr>';
            } else {
                commissionEntries.forEach(ref => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ref.referredUserName || 'Referred User'}</td>
                        <td>${ref.planPurchased ? getPlanName(ref.planPurchased) + ` (${ref.planPurchased} Rs)` : 'N/A'}</td>
                        <td>${ref.amount.toFixed(2)} Rs</td>
                        <td>${formatDate(ref.date)}</td>
                        <td><span class="status-${ref.status || 'credited'}">${ref.status || 'Credited'}</span></td>
                    `;
                    body.appendChild(row);
                });
            }
        }

        function initEarningsPage() {
            loadEarningsHistory();
            if (!earningsChartInstance) setupEarningsChart(); // Setup chart only if not already initialized
        }
        function loadEarningsHistory() {
            const body = document.getElementById('earnings-body');
            if (!body) return;
            if (!currentUser || !userData) {
                body.innerHTML = '<tr><td colspan="4" style="text-align:center;">No earnings data available.</td></tr>';
                updateEarningsSummary(0,0,0); return;
            }
            const period = document.getElementById('earnings-period')?.value || 'all';
            const entries = [];
            // Consolidate all types of earnings
            if (userData.earningsHistory) { // Plan earnings
                Object.values(userData.earningsHistory).forEach(e => entries.push({
                    date: e.date,
                    type: 'Investment',
                    amount: e.amount,
                    description: `From ${e.plan ? getPlanName(e.plan) : 'Active Plan'}`
                }));
            }
            if (userData.referralHistory) { // Referral commissions and milestone rewards
                Object.values(userData.referralHistory).forEach(e => {
                    let entryType = 'Unknown';
                    let description = '';
                    if (e.type === 'commission') {
                        entryType = 'Referral';
                        description = `Commission from ${e.referredUserName || 'referral'}`;
                    } else if (e.type === 'milestone_reward') {
                        entryType = 'Milestone';
                        description = `Milestone: ${e.milestoneName || 'Reward'}`;
                    }
                    if (entryType !== 'Unknown') {
                        entries.push({ date: e.date, type: entryType, amount: e.amount, description: description });
                    }
                });
            }
            // Add registration bonus if credited and logged in transactions
            if(userData.transactions){
                Object.values(userData.transactions).forEach(tx => {
                    if(tx.type === 'bonus_credit' && tx.description === 'Registration Bonus Credited') {
                         entries.push({date: tx.date, type: 'Bonus', amount: tx.amount, description: tx.description});
                    }
                });
            }


            entries.sort((a,b) => new Date(b.date) - new Date(a.date));
            const now = new Date();
            const filtered = entries.filter(e => {
                if (!e.date) return false; // Skip entries without a date
                const d = new Date(e.date);
                if (period === 'today') return d.toDateString() === now.toDateString();
                if (period === 'week') {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1)); // Monday as start of week
                    weekStart.setHours(0,0,0,0);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    weekEnd.setHours(23,59,59,999);
                    return d >= weekStart && d <= weekEnd;
                }
                if (period === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                return true; // 'all' period
            });

            let totalAllTimeEarnings=0, todayTotalEarnings=0, totalReferralAndBonusEarnings=0;
            entries.forEach(e => {
                totalAllTimeEarnings += e.amount;
                if (new Date(e.date).toDateString() === now.toDateString()) todayTotalEarnings += e.amount;
                if (e.type === 'Referral' || e.type === 'Milestone' || e.type === 'Bonus') totalReferralAndBonusEarnings += e.amount;
            });
            updateEarningsSummary(totalAllTimeEarnings, todayTotalEarnings, totalReferralAndBonusEarnings);

            body.innerHTML = '';
            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="4" style="text-align:center;">No earnings for this period.</td></tr>`;
            } else {
                // Display limited entries for performance, e.g., latest 50
                filtered.slice(0,50).forEach(e => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(e.date)}</td>
                        <td><span class="badge ${e.type.toLowerCase()}">${e.type}</span></td>
                        <td>${e.amount.toFixed(2)} Rs</td>
                        <td>${e.description}</td>
                    `;
                    body.appendChild(row);
                });
            }
            updateChartData(filtered, period);
        }
        function updateEarningsSummary(total, today, referralAndBonus) {
            document.getElementById('total-earnings').textContent = `${total.toFixed(2)} Rs`;
            document.getElementById('today-earnings').textContent = `${today.toFixed(2)} Rs`;
            document.getElementById('all-referral-earnings').textContent = `${referralAndBonus.toFixed(2)} Rs`;
        }
        function setupEarningsChart() {
            const ctx = document.getElementById('earnings-chart')?.getContext('2d');
            if (!ctx) return;
            if (earningsChartInstance) earningsChartInstance.destroy(); // Destroy old chart if exists

            Chart.defaults.color = 'var(--text-gray)'; // Default text color for chart elements
            Chart.defaults.borderColor = 'var(--border-color)'; // Default border color for chart lines/grids

            earningsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily Earnings',
                        data: [],
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'rgba(var(--primary-rgb-val), 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: 'var(--primary-light)',
                        pointBorderColor: 'var(--primary-color)',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (Rs)', color: 'var(--text-gray)' },
                            grid: { color: 'var(--border-color)'},
                            ticks: { color: 'var(--text-gray)'}
                        },
                        x: {
                            title: { display: true, text: 'Date/Period', color: 'var(--text-gray)' },
                            grid: { color: 'var(--border-color)'},
                            ticks: { color: 'var(--text-gray)'}
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { color: 'var(--text-gray)'}},
                        title: { display: true, text: 'Earnings Trend', font: {size: 16}, color: 'var(--text-light)'}
                    }
                }
            });
        }
        function updateChartData(data, period) {
            if (!earningsChartInstance || !data) return;
            let labels = [], points = [];

            // Group data by day for chart
            const dailyAggregatedData = {};
            data.forEach(entry => {
                if (!entry.date) return;
                const day = new Date(entry.date).toLocaleDateString('en-CA'); // YYYY-MM-DD for sorting
                dailyAggregatedData[day] = (dailyAggregatedData[day] || 0) + entry.amount;
            });

            const sortedDays = Object.keys(dailyAggregatedData).sort((a,b) => new Date(a) - new Date(b));

            if (period === 'today') { // Show hourly if possible, or just the single day's total
                 if (sortedDays.length === 1) {
                    labels = [formatDate(sortedDays[0], true)]; // Format as 'Mon DD'
                    points = [dailyAggregatedData[sortedDays[0]]];
                 } else { // Fallback for no data or structure for hourly
                    labels = ['Today'];
                    points = [sortedDays.reduce((sum, day) => sum + dailyAggregatedData[day], 0)];
                 }
            } else if (period === 'week' || period === 'month' || (period === 'all' && sortedDays.length <= 31)) {
                // Show daily data points for week, month, or 'all' if not too many days
                labels = sortedDays.map(day => formatDate(day, true));
                points = sortedDays.map(day => dailyAggregatedData[day]);
            } else { // 'all' with many days, might need to aggregate by week or month (simplified for now)
                // For simplicity, show last 30 days if 'all' has too much data
                const last30DaysData = sortedDays.slice(-30);
                labels = last30DaysData.map(day => formatDate(day, true));
                points = last30DaysData.map(day => dailyAggregatedData[day]);
            }

            earningsChartInstance.data.labels = labels;
            earningsChartInstance.data.datasets[0].data = points;
            earningsChartInstance.data.datasets[0].label = period === 'today' ? 'Earnings Today' : 'Daily Earnings';
            earningsChartInstance.update();
        }

        function initHistoryFilters() {
            document.getElementById('deposit-filter')?.addEventListener('change', loadDepositHistory);
            document.getElementById('withdraw-filter')?.addEventListener('change', loadWithdrawHistory);
            document.getElementById('earnings-period')?.addEventListener('change', loadEarningsHistory);
        }
        function initContactForm() {
            const form = document.getElementById('contact-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const nameInput = this.elements['contact-name'];
                    const emailInput = this.elements['contact-email'];
                    const subjectInput = this.elements['contact-subject'];
                    const messageInput = this.elements['contact-message'];

                    const n=nameInput.value.trim(), em=emailInput.value.trim(), s=subjectInput.value.trim(), m=messageInput.value.trim();
                    if (!n||!em||!s||!m) { showNotification('Please fill all fields.', 'error'); return; }
                    if (!validateEmail(em)) { showNotification('Please enter a valid email address.', 'error'); return;}

                    const btn = this.querySelector('.submit-btn');
                    showLoadingButton(btn, true);
                    database.ref('contact_messages').push({
                        name:n, email:em, subject:s, message:m,
                        date: new Date().toISOString(),
                        userId: currentUser?currentUser.uid:'guest',
                        userName: currentUser? userData.name : 'Guest'
                    })
                    .then(() => {
                        showNotification('Message sent successfully! We will get back to you soon.', 'success');
                        form.reset();
                    })
                    .catch(err => {
                        showNotification('Failed to send message. Please try again later.', 'error');
                        console.error("Contact form submission error:", err);
                    })
                    .finally(() => showLoadingButton(btn, false, "Send Message"));
                });
            }
        }
        function showConfirmationModal(title, message, confirmCallback, type = 'warning') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message; // Use innerHTML for potential formatting in message
            const iconContainer = confirmationModalEl.querySelector('.modal-icon');
            iconContainer.querySelectorAll('i').forEach(icon => icon.style.display = 'none');
            const iconShow = iconContainer.querySelector(`i.${type}`);
            if(iconShow) iconShow.style.display = 'block';

            // Change confirm button color based on type
            modalConfirm.className = 'modal-btn confirm'; // Reset classes
            if (type === 'error' || type === 'danger') modalConfirm.classList.add('danger');
            else if (type === 'warning') modalConfirm.classList.add('warning');
            // 'success' type will use default confirm style

            confirmationModalEl.classList.add('active');
            confirmationModalEl.classList.remove('hidden');

            // Re-bind confirm button to avoid multiple listeners from previous calls
            const newConfirmBtn = modalConfirm.cloneNode(true);
            modalConfirm.parentNode.replaceChild(newConfirmBtn, modalConfirm);
            modalConfirm = newConfirmBtn; // Update reference

            modalConfirm.onclick = () => {
                confirmationModalEl.classList.remove('active');
                confirmationModalEl.classList.add('hidden');
                if (typeof confirmCallback === 'function') confirmCallback();
            };
            // Ensure cancel button is also fresh or simple
            document.getElementById('modal-cancel').onclick = () => {
                 confirmationModalEl.classList.remove('active');
                 confirmationModalEl.classList.add('hidden');
            }
        }
        function formatDate(dateString, short = false) {
            if (!dateString) return 'N/A';
            const d = new Date(dateString);
            if (isNaN(d.getTime())) return 'Invalid Date'; // Check if date is valid

            if (short) return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); // e.g. "Jul 20"
            return d.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }); // e.g. "20 Jul 2024, 02:30 PM"
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
